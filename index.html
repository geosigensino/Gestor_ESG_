<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eco Smart Group — Gestor de Tarefas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b0d10; --panel:#0f1317; --card:#141922; --muted:#9aa4b2; --txt:#dde6ee;
      --brand:#185b24; --brand-2:#0f4319; --ok:#38c172; --warn:#ffcc00; --danger:#ef6b6b;
      --border:#1f2430; --shadow:0 10px 24px rgba(0,0,0,.35); --ring:0 0 0 3px rgba(24,91,36,.35);
    }
    .light{
      --bg:#f5f8fb; --panel:#fff; --card:#fff; --muted:#5c6675; --txt:#101317;
      --brand:#1b6a2a; --brand-2:#145021; --ok:#2f855a; --warn:#b7791f; --danger:#c53030;
      --border:#e6ebf2; --shadow:0 10px 24px rgba(16,19,23,.08); --ring:0 0 0 3px rgba(27,106,42,.18);
    }

    /* ===== Tokens por status ===== */
    :root{
      --st-todo-bg:rgba(251,191,36,.14); --st-todo-bd:rgba(251,191,36,.40); --st-todo-tx:#fde68a;
      --st-prog-bg:rgba(59,130,246,.14); --st-prog-bd:rgba(59,130,246,.40); --st-prog-tx:#bfdbfe;
      --st-done-bg:rgba(16,185,129,.14); --st-done-bd:rgba(16,185,129,.35); --st-done-tx:#a7f3d0;
      --st-late-bg:rgba(239,68,68,.16); --st-late-bd:rgba(239,68,68,.45); --st-late-tx:#fecaca;
    }
    .light{
      --st-todo-bg:#fffbeb; --st-todo-bd:#fde68a; --st-todo-tx:#92400e;
      --st-prog-bg:#eff6ff; --st-prog-bd:#bfdbfe; --st-prog-tx:#1d4ed8;
      --st-done-bg:#ecfdf5; --st-done-bd:#a7f3d0; --st-done-tx:#065f46;
      --st-late-bg:#fef2f2; --st-late-bd:#fecaca; --st-late-tx:#991b1b;
    }

    html,body{height:100%}
    body{margin:0;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--txt)}
    .wrap{max-width:1400px;margin:0 auto;padding:22px 18px 36px}

    header{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{font-weight:800;font-size:22px;letter-spacing:.2px}
    .muted{color:var(--muted)}

    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:16px;padding:12px;border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);backdrop-filter:saturate(160%) blur(6px); position:sticky; top:0; z-index:10}
    @media (max-width:980px){ .toolbar{position:static;top:auto} }

    .pill{background:rgba(255,255,255,.05);color:var(--txt);padding:6px 10px;border:1px solid var(--border);border-radius:10px}

    .btn,button{cursor:pointer;border:1px solid var(--border);background:var(--panel);color:var(--txt);padding:9px 12px;border-radius:10px;box-shadow:var(--shadow);transition:transform .05s,box-shadow .2s,background .2s}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;border:none}
    .btn.primary:hover{filter:saturate(1.1);box-shadow:0 10px 22px rgba(24,91,36,.35)}
    .btn.small{padding:6px 9px}

    .grid{display:grid;grid-template-columns:minmax(0,1.8fr) minmax(320px,1fr);gap:28px;margin-top:26px;align-items:start}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .panel h3{margin:18px;font-size:16px}

    .kanban{display:grid;grid-template-columns:repeat(auto-fit, minmax(280px,1fr));gap:24px;padding:24px}
    .col{background:var(--card);border:1px solid var(--border);border-radius:12px;min-height:260px;display:flex;flex-direction:column}
    .col header{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--border)}
    .dropzone{flex:1;padding:14px;min-height:160px}
    .dropzone.readonly{opacity:.95}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 6px;box-shadow:var(--shadow);transition:box-shadow .2s,transform .05s;cursor:pointer}
    .card:hover{box-shadow:0 10px 22px rgba(0,0,0,.25)}
    .title{font-weight:700}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{background:rgba(255,255,255,.06);border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .actions{display:flex;gap:8px;margin-top:10px}
    .actions .btn.small{cursor:pointer}

    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,input[type="date"],input[type="text"],input[type="time"]{background:var(--panel);color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:8px 10px}

    .status-inline{font-size:12px;padding:4px 6px;border-radius:8px}

    .note{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 14px}
    .note-meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:6px}
    .note-edit{display:grid;gap:8px}
    textarea{width:100%;min-height:64px;background:var(--panel);color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:8px 10px}

    .badges{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel)}
    .badge.status-a_fazer{background:var(--st-todo-bg);color:var(--st-todo-tx);border-color:var(--st-todo-bd)}
    .badge.status-em_andamento{background:var(--st-prog-bg);color:var(--st-prog-tx);border-color:var(--st-prog-bd)}
    .badge.status-concluida{background:var(--st-done-bg);color:var(--st-done-tx);border-color:var(--st-done-bd)}

    .col[data-status="atrasadas"] .card{background:var(--st-late-bg);border-color:var(--st-late-bd)}
    .col[data-status="atrasadas"] .badge{background:transparent;color:var(--st-late-tx);border-color:var(--st-late-bd)}

    .card.is-a_fazer{box-shadow:inset 3px 0 0 0 var(--st-todo-bd)}
    .card.is-em_andamento{box-shadow:inset 3px 0 0 0 var(--st-prog-bd)}
    .card.is-concluida{box-shadow:inset 3px 0 0 0 var(--st-done-bd)}

    .col:not([data-status="atrasadas"]) .card.is-a_fazer{background:var(--st-todo-bg);border-color:var(--st-todo-bd)}
    .col:not([data-status="atrasadas"]) .card.is-em_andamento{background:var(--st-prog-bg);border-color:var(--st-prog-bd)}
    .col:not([data-status="atrasadas"]) .card.is-concluida{background:var(--st-done-bg);border-color:var(--st-done-bd)}

    .foot{margin-top:28px;display:flex;justify-content:space-between;align-items:center;color:var(--muted)}

    .assignees{display:flex;gap:8px;flex-wrap:wrap}
    .assignees input[type="checkbox"]{display:none}
    .assignees label{user-select:none;cursor:pointer;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--panel);transition:background .2s,color .2s,box-shadow .2s}
    .assignees input[type="checkbox"]:checked + label{background:var(--brand);color:#fff;border-color:transparent;box-shadow:var(--ring)}

    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
      .kanban{grid-template-columns:1fr}
      .toolbar{position:static;top:auto}
    }

    dialog{ width:min(680px, calc(100% - 32px)); }
    dialog.modal-light{ background:#ffffff; color:#111827; border:1px solid #e6ebf2; border-radius:14px; box-shadow:var(--shadow); }
    dialog.modal-light::backdrop{ background:rgba(0,0,0,.45); }
    dialog.modal-light .modal-head{ padding:14px 16px; border-bottom:1px solid #e6ebf2; font-weight:700; color:#0f172a; }
    dialog.modal-light .modal-body{ padding:14px 16px; display:grid; gap:12px; }
    dialog.modal-light .modal-foot{ padding:14px 16px; border-top:1px solid #e6ebf2; display:flex; gap:10px; justify-content:flex-end; }
    dialog.modal-light label{ color:#4b5563; }
    dialog.modal-light input[type="text"],
    dialog.modal-light input[type="date"],
    dialog.modal-light input[type="time"],
    dialog.modal-light select,
    dialog.modal-light textarea{ background:#f8fafc; color:#0f172a; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; width:100%; box-sizing:border-box; }
    dialog.modal-light .btn{ background:#f8fafc; color:#0f172a; border:1px solid #e5e7eb; }
    dialog.modal-light .btn.primary{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; border:none; }

    /* ===== Mini-calendário (popover) ===== */
    .cal-pop{
      position:fixed; z-index:20; width:280px; max-width:96vw;
      background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:8px;
    }
    .cal-pop.hidden{ display:none; }
    .cal{ display:grid; gap:8px; }
    .cal-head{ display:flex; justify-content:space-between; align-items:center; padding:4px 6px; }
    .cal-head .title{ font-weight:700; }
    .cal-head button{ padding:4px 8px; }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; padding:0 4px 6px; }
    .cal-dow{ text-align:center; font-size:12px; color:var(--muted); }
    .cal-day{ position:relative; text-align:center; padding:8px 0; border:1px solid var(--border); border-radius:8px; cursor:pointer; user-select:none; background:var(--panel); }
    .cal-day:hover{ box-shadow:0 4px 14px rgba(0,0,0,.18); }
    .cal-day.is-today{ outline:2px solid var(--brand); outline-offset:-2px; }
    .cal-day.is-selected{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; border-color:transparent; }
    .cal-day.has-task::after{ content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:6px; width:6px; height:6px; border-radius:50%; background:var(--warn); }
    #selDiaTag .btn.small{ padding:2px 6px; }

    /* Modo bottom-sheet em telas estreitas */
    @media (max-width:420px){
      .cal-pop{
        left:50% !important;
        transform:translateX(-50%) !important;
        top:auto !important;
        bottom:calc(env(safe-area-inset-bottom, 0px) + 8px) !important;
        width:calc(100vw - 16px);
      }
    }

    /* ===== Avisos de vencimento nos cards ===== */
    .badge.due{ font-weight:700 }
    .badge.due-today{ background:var(--st-todo-bg); color:var(--st-todo-tx); border-color:var(--st-todo-bd) }
    .badge.due-soon{ background:var(--st-prog-bg); color:var(--st-prog-tx); border-color:var(--st-prog-bd) }
    .badge.due-overdue{ background:var(--st-late-bg); color:var(--st-late-tx); border-color:var(--st-late-bd) }

    /* ===== Reuniões (lista no modal) ===== */
    .meeting-list{ display:grid; gap:10px; max-height:50vh; overflow:auto; padding-right:2px; }
    .meeting-item{ border:1px solid var(--border); background:var(--panel); border-radius:10px; padding:10px; display:grid; gap:6px; }
    .meeting-top{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .meeting-meta{ color:var(--muted); font-size:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .meeting-actions{ display:flex; gap:8px; }
    .pill-inline{ background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:12px; }

    /* ===== Timeline (histórico da tarefa) ===== */
    .timeline-form{ display:grid; gap:8px; border:1px solid var(--border); background:var(--panel); border-radius:10px; padding:10px; }
    .timeline-form-head{ font-weight:700; color:#0f172a; display:flex; justify-content:space-between; align-items:center; }
    .timeline-list{ display:grid; gap:10px; max-height:45vh; overflow:auto; padding-right:2px; }
    .tl-item{ border:1px solid var(--border); background:var(--panel); border-radius:10px; padding:10px; display:grid; gap:6px; }
    .tl-top{ display:flex; justify-content:space-between; align-items:flex-start; gap:8px; }
    .tl-left{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .tl-dot{ width:10px; height:10px; border-radius:50%; flex-shrink:0; }
    .dot-concluido{ background:var(--ok); }
    .dot-andamento{ background:var(--warn); }
    .dot-parado{ background:var(--danger); }
    .tl-titulo{ font-weight:600; color:#0f172a; }
    .tl-actions{ display:flex; gap:8px; }
    .tl-actions .btn.small{ padding:4px 8px; font-size:12px; line-height:1.1; }
    .tl-meta{ font-size:12px; color:var(--muted); display:flex; flex-wrap:wrap; gap:6px; }
    .tl-desc{ font-size:13px; color:#4b5563; white-space:pre-wrap; word-break:break-word; }

    .tl-edit-block{ display:grid; gap:6px; }
    .tl-edit-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .tl-edit-row label{ font-size:12px; color:#4b5563; }
    .tl-edit-row input[type="text"],
    .tl-edit-row textarea,
    .tl-edit-row select{ font-size:13px; }
    .tl-save-row{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div>
        <div class="brand">Eco Smart Group — Gestor de Tarefas</div>
        <div class="muted" id="modeLabel">Modo local • Snapshots por link — board: <span id="boardLabel">default</span></div>
      </div>
    </header>

    <div class="toolbar">
      <button class="btn primary" id="btnNova">+ Nova tarefa</button>

      <div class="filters">
        <span class="pill">Status:
          <select id="fStatus">
            <option value="todos">todos</option>
            <option value="a_fazer">a fazer</option>
            <option value="em_andamento">em andamento</option>
            <option value="concluida">concluída</option>
          </select>
        </span>
        <span class="pill">Responsável:
          <select id="fResp"><option value="todos">todos</option></select>
        </span>
        <span class="pill">Prazo:
          <select id="fPrazo">
            <option value="todos">todos</option>
            <option value="hoje">hoje</option>
            <option value="semana">esta semana</option>
            <option value="atrasadas">atrasadas</option>
          </select>
        </span>

        <!-- Calendário + chip de dia -->
        <button class="btn small" id="btnCal" title="Abrir calendário">📅</button>
        <span id="selDiaTag" class="pill" style="display:none">dia: <strong id="selDiaText"></strong> <button class="btn small" id="btnClearDia" title="Limpar">×</button></span>

        <div id="calPopover" class="cal-pop hidden" role="dialog" aria-label="Calendário"></div>
      </div>

      <!-- Botão das reuniões -->
      <button class="btn" id="btnMeetings" title="Reuniões">🗓 Reuniões</button>

      <button class="btn" id="btnExport">Exportar CSV</button>
      <button class="btn" id="btnLink">Gerar link com dados</button>
      <label class="switch"><input type="checkbox" id="chkUpdateLink" checked> atualizar link ao editar</label>

      <span style="flex:1"></span>
      <button class="btn" id="btnTheme">Alternar tema</button>
    </div>

    <div class="grid">
      <section class="panel">
        <h3>Tarefas</h3>
        <div class="kanban">
          <div class="col" data-status="atrasadas">
            <header><div class="row"><strong>Atrasadas</strong><span class="badge">0</span></div></header>
            <div class="dropzone readonly" id="col-atrasadas"></div>
          </div>

          <div class="col" data-status="a_fazer">
            <header>
              <div class="row"><strong>A fazer</strong><span class="badge">0</span></div>
              <button class="btn small" data-add="a_fazer">+ adicionar</button>
            </header>
            <div class="dropzone" id="col-a_fazer" ondragover="event.preventDefault()"></div>
          </div>
          <div class="col" data-status="em_andamento">
            <header>
              <div class="row"><strong>Em andamento</strong><span class="badge">0</span></div>
              <button class="btn small" data-add="em_andamento">+ adicionar</button>
            </header>
            <div class="dropzone" id="col-em_andamento" ondragover="event.preventDefault()"></div>
          </div>
          <div class="col" data-status="concluida">
            <header>
              <div class="row"><strong>Concluídas</strong><span class="badge">0</span></div>
              <button class="btn small" data-add="concluida">+ adicionar</button>
            </header>
            <div class="dropzone" id="col-concluida" ondragover="event.preventDefault()"></div>
          </div>
        </div>
      </section>

      <section class="panel">
        <h3>Anotações gerais</h3>

        <div class="note">
          <div class="row" style="gap:10px;margin-bottom:8px">
            <label class="pill">Autor:
              <select id="noteAuthor"></select>
            </label>
            <span class="muted" id="noteNow"></span>
          </div>
          <textarea id="noteInput" placeholder="Escreva uma anotação…"></textarea>
          <div class="actions">
            <button class="btn" id="btnAnotar">Anotar</button>
          </div>
        </div>

        <div id="notes"></div>
      </section>
    </div>

    <div class="foot">
      <div>Feito com ❤ para equipes que precisam de algo simples, online e colaborativo.</div>
      <div class="muted" id="onlineState">Offline (LocalStorage)</div>
    </div>
  </div>

  <!-- MODAL: TAREFA -->
  <dialog id="dlgTask" class="modal-light">
    <div class="modal-head" id="taskModalTitle">Nova tarefa</div>
    <div class="modal-body">
      <div class="field"><label>Título</label><input id="tTitulo" type="text" placeholder="Ex.: Arquivos da Novo Agro" /></div>
      <div class="field"><label>Descrição (opcional)</label><input id="tDesc" type="text" placeholder="Detalhes curtos…" /></div>
      <div class="field"><label>Responsáveis</label><div id="tRespGroup" class="assignees"></div></div>
      <div class="field"><label>Prazo</label><input id="tPrazo" type="date" /></div>
      <div class="field"><label>Status</label>
        <select id="tStatus">
          <option value="a_fazer">a fazer</option>
          <option value="em_andamento">em andamento</option>
          <option value="concluida">concluída</option>
        </select>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="tCancelar">Cancelar</button>
      <button class="btn primary" id="tSalvar">Salvar</button>
    </div>
  </dialog>

  <!-- MODAL: REUNIÕES -->
  <dialog id="dlgMeetings" class="modal-light">
    <div class="modal-head">Reuniões</div>
    <div class="modal-body">
      <!-- Formulário de nova reunião -->
      <div class="field"><label>Responsável</label>
        <select id="mResp"></select>
      </div>
      <div class="field"><label>Título</label>
        <input id="mTitulo" type="text" placeholder="Ex.: Reunião com Cliente X" />
      </div>
      <div class="field"><label>Descrição (opcional)</label>
        <input id="mDesc" type="text" placeholder="Pauta breve…" />
      </div>
      <div class="row" style="gap:10px">
        <div class="field"><label>Dia</label><input id="mData" type="date" /></div>
        <div class="field"><label>Hora</label><input id="mHora" type="time" /></div>
      </div>
      <div class="actions" style="justify-content:flex-end">
        <button class="btn" id="mCancelar">Limpar</button>
        <button class="btn primary" id="mSalvar">Salvar reunião</button>
      </div>

      <!-- Lista de reuniões -->
      <div style="margin-top:8px;font-weight:700">Registros</div>
      <div id="meetingList" class="meeting-list"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="mFechar">Fechar</button>
    </div>
  </dialog>

  <!-- MODAL: TIMELINE DA TAREFA -->
  <dialog id="dlgTimeline" class="modal-light">
    <div class="modal-head" id="tlTaskTitle">Timeline / Histórico</div>
    <div class="modal-body">
      <!-- Formulário para novo registro de timeline (só aparece para autor) -->
      <div id="tlFormWrap" class="timeline-form" style="display:none">
        <div class="timeline-form-head">
          <span>Novo registro</span>
        </div>
        <div class="tl-edit-row">
          <label style="min-width:60px">Título</label>
          <input id="tlNovoTitulo" type="text" placeholder="Ex.: Reunião feita / Documento entregue" />
        </div>
        <div class="tl-edit-row">
          <label style="min-width:60px">Descrição</label>
          <textarea id="tlNovoDesc" placeholder="Descreva rapidamente o que aconteceu…"></textarea>
        </div>
        <div class="tl-edit-row">
          <label style="min-width:60px">Status</label>
          <select id="tlNovoStatus">
            <option value="parado">Parado (vermelho)</option>
            <option value="andamento">Em andamento (amarelo)</option>
            <option value="concluido">Concluído (verde)</option>
          </select>
        </div>
        <div class="tl-save-row">
          <button class="btn primary" id="tlNovoSalvar">Adicionar na timeline</button>
        </div>
      </div>

      <!-- Lista da timeline -->
      <div style="font-weight:700">Histórico</div>
      <div id="tlList" class="timeline-list"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="tlFechar">Fechar</button>
    </div>
  </dialog>

  <script>
  const DEFAULT_SB_URL = 'https://oakntljdkkoqwttkgzpk.supabase.co';
  const DEFAULT_SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ha250bGpka2tvcXd0dGtnenBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzQzMDgsImV4cCI6MjA3MTYxMDMwOH0.jjxUzxyUoutDAVzZg9nrSi9kg5fYfs6F7PCd4xkT48c';

  const FIXED_RESPONSAVEIS = ['Bruno Ferreira','Bruno Santos','Carlos Barretto','João Tenório'];

  const state = {
    theme: localStorage.getItem('theme') || 'dark',
    board: new URL(location.href).searchParams.get('board') || 'default',
    author: 'Anônimo',
    supabaseUrl: DEFAULT_SB_URL, supabaseKey: DEFAULT_SB_KEY, client: null,
    tasks: [], notes: [], meetings: [],
    editingTaskId: null, editingNoteId: null, online:false,
    filterDate:null, calMonth:null,
    viewingTaskTimelineId:null,
    editingTimelineEntryId:null
  };

  function applyTheme(){ if(state.theme==='light') document.body.classList.add('light'); else document.body.classList.remove('light'); } applyTheme();

  const id = x => document.getElementById(x);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const unique = a => [...new Set(a)];
  const pad2 = n => String(n).padStart(2,'0');
  const toYMD = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const toHM  = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

  function ymdToLocalDate(s){ if(!s) return null; const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
  function fmtDate(d){ if(!d) return ''; const dt=(typeof d==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(d))?ymdToLocalDate(d):new Date(d); return dt.toLocaleDateString(); }
  function fmtTime(hm){ if(!hm) return ''; const [h,m]=(hm||'').split(':').map(Number); const d=new Date(); d.setHours(h||0,m||0,0,0); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  function fmtDateTime(d){ return d?new Date(d).toLocaleString():''; }

  const toCSV = rows=>{ if(!rows.length) return ''; const head=Object.keys(rows[0]); const body=rows.map(r=>head.map(k=>`"${String(r[k]??'').replaceAll('"','""')}"`).join(',')); return [head.join(','),...body].join('\n'); };
  function showErr(ctx, err){ console.error(ctx, err); alert(`${ctx}:\n${(err && err.message) || err}`); }

  function lsKey(){ return `gst_${state.board}`; }
  function loadLocal(){
    const raw=localStorage.getItem(lsKey());
    if(!raw) return {tasks:[],notes:[],meetings:[]};
    try{ const obj = JSON.parse(raw); return {tasks:obj.tasks||[], notes:obj.notes||[], meetings:obj.meetings||[]}; }
    catch{ return {tasks:[],notes:[],meetings:[]} }
  }
  function saveLocal(){ localStorage.setItem(lsKey(), JSON.stringify({tasks:state.tasks, notes:state.notes, meetings:state.meetings})); }

  function renderRespChoices(selected=[]){
    const wrap=id('tRespGroup'); wrap.innerHTML='';
    FIXED_RESPONSAVEIS.forEach((name, idx)=>{
      const input=document.createElement('input'); input.type='checkbox'; input.id=`resp_${idx}`; input.value=name; if(selected.includes(name)) input.checked=true;
      const label=document.createElement('label'); label.htmlFor=input.id; label.textContent=name;
      wrap.append(input,label);
    });
  }
  function renderMeetingResponsaveis(){
    const sel=id('mResp');
    sel.innerHTML = ['','...'].includes(sel.value)
      ? FIXED_RESPONSAVEIS.map(n=>`<option value="${n}">${n}</option>`).join('')
      : FIXED_RESPONSAVEIS.map(n=>`<option ${n===sel.value?'selected':''} value="${n}">${n}</option>`).join('');
  }
  function renderNoteAuthors(){
    const sel=id('noteAuthor');
    sel.innerHTML=FIXED_RESPONSAVEIS.map(n=>`<option value="${n}">${n}</option>`).join('');
    id('noteNow').textContent=`agora: ${fmtDateTime(new Date())}`;
  }

  async function maybeInitSupabase(){
    try{
      state.client = window.supabase.createClient(state.supabaseUrl, state.supabaseKey, { auth: { persistSession:false }});
      await state.client.from('boards').upsert({ slug: state.board, title: state.board }, { onConflict: 'slug' }).select();
      state.online=true;
      id('onlineState').textContent='Online (Supabase)';
      id('modeLabel').innerHTML=`Online • Snapshots por link — board: <span id="boardLabel">${state.board}</span>`;
      state.client.channel('ch-app')
        .on('postgres_changes', { event:'*', schema:'public', table:'tasks',    filter:`board_slug=eq.${state.board}` }, handleRealtime)
        .on('postgres_changes', { event:'*', schema:'public', table:'notes',    filter:`board_slug=eq.${state.board}` }, handleRealtime)
        .on('postgres_changes', { event:'*', schema:'public', table:'meetings', filter:`board_slug=eq.${state.board}` }, handleRealtime)
        .subscribe();
    }catch(e){
      state.online=false;
      id('onlineState').textContent='Offline (LocalStorage)';
      id('modeLabel').innerHTML=`Modo local • Snapshots por link — board: <span id="boardLabel">${state.board}</span>`;
      console.warn('Sem Supabase, operando local:', e);
    }
  }
  async function handleRealtime(){ await fetchAll(); }

  async function fetchAll(){
    if(state.online){
      const { data: t, error: e1 } = await state.client.from('tasks').select('*').eq('board_slug', state.board).order('created_at',{ascending:true});
      state.tasks = e1 ? [] : (t||[]); if(e1) showErr('Erro ao carregar tarefas', e1);

      const { data: n, error: e2 } = await state.client.from('notes').select('*').eq('board_slug', state.board).order('created_at',{ascending:false});
      state.notes = e2 ? [] : (n||[]); if(e2) showErr('Erro ao carregar anotações', e2);

      const { data: m, error: e3 } = await state.client.from('meetings').select('*').eq('board_slug', state.board).order('created_at',{ascending:false});
      state.meetings = e3 ? [] : (m||[]); if(e3) showErr('Erro ao carregar reuniões', e3);
    }else{
      const {tasks,notes,meetings} = loadLocal(); state.tasks=tasks; state.notes=notes; state.meetings=meetings;
    }
    render(); updateFilters(); renderNoteAuthors();
    renderMeetingList(); // mantém lista de reuniões sincronizada

    // se timeline estiver aberta, re-renderiza modal
    if(state.viewingTaskTimelineId){
      renderTimelineModal();
    }
  }

  async function upsertTask(obj){
    if(state.online){
      if(obj.id){
        const { error } = await state.client.from('tasks').update(obj).eq('id', obj.id);
        if(error) return showErr('Erro ao atualizar tarefa', error);
      }else{
        const payload = { ...obj, board_slug: state.board };
        const { error } = await state.client.from('tasks').insert(payload);
        if(error) return showErr('Erro ao criar tarefa', error);
      }
    }else{
      if(!obj.id){ obj.id=crypto.randomUUID(); obj.created_at=new Date().toISOString(); }
      const idx=state.tasks.findIndex(x=>x.id===obj.id);
      if(idx>=0){
        state.tasks[idx]={...state.tasks[idx],...obj};
      }else{
        state.tasks.push(obj);
      }
      saveLocal();
    }
    await fetchAll();
  }
  async function deleteTask(idv){
    if(state.online){
      const { error } = await state.client.from('tasks').delete().eq('id', idv);
      if(error) return showErr('Erro ao excluir tarefa', error);
    }else{
      state.tasks = state.tasks.filter(t=>t.id!==idv); saveLocal();
    }
    await fetchAll();
  }

  // ===== REUNIÕES =====
  async function upsertMeeting(obj){
    if(state.online){
      if(obj.id){
        const { error } = await state.client
          .from('meetings')
          .update({ ...obj, updated_at:new Date().toISOString() })
          .eq('id', obj.id);
        if(error) return showErr('Erro ao atualizar reunião', error);
      }else{
        const tempId = crypto.randomUUID();
        const optimistic = { id: tempId, board_slug: state.board, created_at: new Date().toISOString(), ...obj };
        state.meetings = [optimistic, ...(state.meetings||[])];
        renderMeetingList();

        const { data, error } = await state.client
          .from('meetings')
          .insert({ ...obj, board_slug: state.board })
          .select()
          .single();

        if(error){
          state.meetings = state.meetings.filter(m => m.id !== tempId);
          renderMeetingList();
          return showErr('Erro ao criar reunião', error);
        }
        const ix = state.meetings.findIndex(m => m.id === tempId);
        if(ix >= 0) state.meetings[ix] = data;
        renderMeetingList();
        return;
      }
    }else{
      if(!obj.id){ obj.id=crypto.randomUUID(); obj.created_at=new Date().toISOString(); }
      const idx=state.meetings.findIndex(x=>x.id===obj.id);
      if(idx>=0){ state.meetings[idx]={...state.meetings[idx],...obj}; }
      else{ state.meetings.unshift(obj); }
      saveLocal();
    }
    await fetchAll();
  }

  async function deleteMeeting(idv){
    const backup = [...(state.meetings||[])];
    state.meetings = state.meetings.filter(m => m.id !== idv);
    renderMeetingList();

    if(state.online){
      const { error } = await state.client.from('meetings').delete().eq('id', idv);
      if(error){
        state.meetings = backup;
        renderMeetingList();
        return showErr('Erro ao excluir reunião', error);
      }
    }else{
      saveLocal();
    }
  }

  function openMeetings(){
    renderMeetingResponsaveis();
    id('mResp').value = FIXED_RESPONSAVEIS[0] || '';
    id('mTitulo').value = '';
    id('mDesc').value = '';
    id('mData').value = '';
    id('mHora').value = '';
    renderMeetingList();
    id('dlgMeetings').showModal();
  }
  function renderMeetingList(){
    const wrap=id('meetingList'); if(!wrap) return;
    wrap.innerHTML='';
    const list = [...(state.meetings||[])].sort((a,b) => new Date(b.created_at||0) - new Date(a.created_at||0));
    if(!list.length){
      wrap.innerHTML = `<div class="muted">Sem reuniões registradas.</div>`;
      return;
    }
    list.forEach(m=>{
      const dv=document.createElement('div'); dv.className='meeting-item';
      const top=document.createElement('div'); top.className='meeting-top';
      const ttl=document.createElement('div'); ttl.className='title'; ttl.textContent=m.titulo||'(sem título)';
      const actions=document.createElement('div'); actions.className='meeting-actions';
      const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir'; bDel.onclick=()=>deleteMeeting(m.id);
      actions.append(bDel); top.append(ttl, actions);

      const meta=document.createElement('div'); meta.className='meeting-meta';
      const resp=`<span class="pill-inline">${m.responsavel||'—'}</span>`;
      const dia = m.data ? fmtDate(m.data) : 'sem dia';
      const hora= m.hora ? fmtTime(m.hora) : '';
      meta.innerHTML = `${resp}<span>•</span><span>${dia}${hora? ' — '+hora:''}</span><span>•</span><span>criada: ${fmtDateTime(m.created_at)}</span>`;

      const desc=document.createElement('div'); desc.className='muted'; desc.textContent=m.descricao||'';

      dv.append(top, meta, desc);
      wrap.append(dv);
    });
  }
  async function saveMeetingFromModal(){
    const responsavel=id('mResp').value;
    const titulo=(id('mTitulo').value||'').trim();
    const descricao=(id('mDesc').value||'').trim() || null;
    const data=id('mData').value || null;
    const hora=id('mHora').value || null;

    if(!titulo || !responsavel || !data || !hora){
      return showErr('Formulário incompleto','Preencha responsável, título, dia e hora.');
    }
    const obj = { titulo, descricao, responsavel, data, hora, autor: state.author };
    if(!state.online) obj.board_slug=state.board;
    await upsertMeeting(obj);
    id('mTitulo').value=''; id('mDesc').value=''; id('mData').value=''; id('mHora').value='';
  }

  // ===== NOTAS =====
  async function addNote(content){
    const autor=id('noteAuthor').value;
    if(!content.trim()) return;
    if(state.online){
      const { error } = await state.client.from('notes').insert({ board_slug: state.board, conteudo: content, autor });
      if(error) return showErr('Erro ao criar anotação', error);
    }else{
      state.notes.push({ id: crypto.randomUUID(), conteudo: content, autor, created_at: new Date().toISOString(), updated_at: null });
      saveLocal();
    }
    id('noteInput').value=''; await fetchAll();
  }
  async function startEditNote(note){ state.editingNoteId=note.id; renderNotes(); }
  async function saveEditNote(idv){
    const area=id(`edit_area_${idv}`), sel=id(`edit_author_${idv}`);
    const newText=area.value.trim(), newAuthor=sel.value; if(!newText) return;
    if(state.online){
      const { error } = await state.client.from('notes').update({ conteudo:newText, autor:newAuthor }).eq('id', idv);
      if(error) return showErr('Erro ao salvar edição', error);
    }else{
      const idx=state.notes.findIndex(n=>n.id===idv);
      if(idx>=0){ state.notes[idx].conteudo=newText; state.notes[idx].autor=newAuthor; state.notes[idx].updated_at=new Date().toISOString(); saveLocal(); }
    }
    state.editingNoteId=null; await fetchAll();
  }
  function cancelEditNote(){ state.editingNoteId=null; renderNotes(); }
  async function deleteNote(idv){
    if(state.online){
      const { error } = await state.client.from('notes').delete().eq('id', idv);
      if(error) return showErr('Erro ao excluir anotação', error);
    }else{
      state.notes = state.notes.filter(n=>n.id!==idv); saveLocal();
    }
    await fetchAll();
  }

  function render(){
    id('boardLabel').textContent=state.board;
    renderTasks();
    renderNotes();
    updateSelectedDayChip();
  }

  /* ===== Aviso de vencimento ===== */
  function getDueBadge(prazo, status){
    if(!prazo || status==='concluida') return null;
    const today=new Date(); today.setHours(0,0,0,0);
    const d=ymdToLocalDate(prazo);
    const diff=Math.round((d - today)/(1000*60*60*24));
    if(diff<0) return { cls:'due due-overdue', text:`atrasada há ${Math.abs(diff)}d` };
    if(diff===0) return { cls:'due due-today', text:'vence hoje' };
    if(diff===1) return { cls:'due due-soon', text:'vence amanhã' };
    if(diff<=7) return { cls:'due due-soon', text:`em ${diff} dias` };
    return null;
  }

  /* ===== Timeline helpers ===== */
  function getTaskById(taskId){
    return state.tasks.find(x=>x.id===taskId);
  }
  function getTimelineStatusLabel(st){
    if(st==='concluido') return 'Concluído';
    if(st==='andamento') return 'Em andamento';
    if(st==='parado') return 'Parado';
    return st || '';
  }
  function getTimelineDotClass(st){
    if(st==='concluido') return 'dot-concluido';
    if(st==='andamento') return 'dot-andamento';
    if(st==='parado') return 'dot-parado';
    return '';
  }

  async function saveTaskTimeline(task){
    // persiste somente timeline e updated_at
    const newObj = { id: task.id, timeline: task.timeline||[], updated_at: new Date().toISOString() };
    await upsertTask(newObj);
  }

  function openTimelineModal(taskId){
    state.viewingTaskTimelineId = taskId;
    state.editingTimelineEntryId = null;
    renderTimelineModal();
    id('dlgTimeline').showModal();
  }

  function renderTimelineModal(){
    const task = getTaskById(state.viewingTaskTimelineId);
    if(!task) return;
    const isAutor = task.autor === state.author || !task.autor; // autor pode ser vazio em dados antigos
    const tlTaskTitle = id('tlTaskTitle');
    const tlFormWrap = id('tlFormWrap');
    const tlList = id('tlList');

    tlTaskTitle.textContent = `Timeline / Histórico — ${task.titulo||'(sem título)'}`;

    // mostra ou oculta formulário de novo registro
    if(isAutor){
      tlFormWrap.style.display = '';
    }else{
      tlFormWrap.style.display = 'none';
    }

    // limpa campos do formulário novo
    // (não limpa se já estiver digitando; simples assim)
    // opcional: deixamos como está

    // Renderizar lista
    tlList.innerHTML = '';
    const timelineArr = Array.isArray(task.timeline) ? [...task.timeline] : [];
    // ordenar do mais recente pro mais antigo
    timelineArr.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));

    if(!timelineArr.length){
      tlList.innerHTML = `<div class="muted">Sem registros na timeline.</div>`;
      return;
    }

    timelineArr.forEach(entry=>{
      const isEditing = state.editingTimelineEntryId === entry.id;
      const item = document.createElement('div');
      item.className = 'tl-item';

      if(isEditing){
        // bloco de edição
        const editBlock = document.createElement('div');
        editBlock.className='tl-edit-block';

        // título
        const rowTitulo = document.createElement('div');
        rowTitulo.className='tl-edit-row';
        const lblT = document.createElement('label'); lblT.textContent='Título';
        const inpT = document.createElement('input'); inpT.type='text'; inpT.id=`tlEditTitulo_${entry.id}`; inpT.value=entry.titulo||'';
        rowTitulo.append(lblT, inpT);

        // descrição
        const rowDesc = document.createElement('div');
        rowDesc.className='tl-edit-row';
        const lblD = document.createElement('label'); lblD.textContent='Descrição';
        const inpD = document.createElement('textarea'); inpD.id=`tlEditDesc_${entry.id}`; inpD.value=entry.descricao||'';
        rowDesc.append(lblD, inpD);

        // status
        const rowSt = document.createElement('div');
        rowSt.className='tl-edit-row';
        const lblS = document.createElement('label'); lblS.textContent='Status';
        const selS = document.createElement('select'); selS.id=`tlEditStatus_${entry.id}`;
        selS.innerHTML = `
          <option value="parado">Parado (vermelho)</option>
          <option value="andamento">Em andamento (amarelo)</option>
          <option value="concluido">Concluído (verde)</option>
        `;
        selS.value = entry.status || 'parado';
        rowSt.append(lblS, selS);

        // linha salvar/cancelar
        const rowBtns = document.createElement('div');
        rowBtns.className='tl-save-row';
        const bCancel = document.createElement('button');
        bCancel.className='btn';
        bCancel.textContent='Cancelar';
        bCancel.onclick=()=>{ state.editingTimelineEntryId=null; renderTimelineModal(); };

        const bSave = document.createElement('button');
        bSave.className='btn primary';
        bSave.textContent='Salvar';
        bSave.onclick=async ()=>{
          const newTitulo = id(`tlEditTitulo_${entry.id}`).value.trim() || '(sem título)';
          const newDesc   = id(`tlEditDesc_${entry.id}`).value.trim() || '';
          const newStatus = id(`tlEditStatus_${entry.id}`).value;
          const tTask = getTaskById(state.viewingTaskTimelineId);
          if(!tTask) return;
          const arr = Array.isArray(tTask.timeline)?tTask.timeline:[];
          const idx = arr.findIndex(e=>e.id===entry.id);
          if(idx>=0){
            arr[idx] = { ...arr[idx],
              titulo:newTitulo,
              descricao:newDesc,
              status:newStatus,
              updated_at:new Date().toISOString()
            };
          }
          tTask.timeline = arr;
          await saveTaskTimeline(tTask);
          state.editingTimelineEntryId=null;
          renderTimelineModal();
        };

        rowBtns.append(bCancel,bSave);

        editBlock.append(rowTitulo,rowDesc,rowSt,rowBtns);
        item.append(editBlock);

      }else{
        // visualização normal
        const top = document.createElement('div');
        top.className='tl-top';

        const left = document.createElement('div');
        left.className='tl-left';
        const dot = document.createElement('span');
        dot.className=`tl-dot ${getTimelineDotClass(entry.status)}`;
        const tt = document.createElement('span');
        tt.className='tl-titulo';
        tt.textContent=entry.titulo||'(sem título)';
        left.append(dot,tt);

        const act = document.createElement('div');
        act.className='tl-actions';

        if(isAutor){
          const bEdit = document.createElement('button');
          bEdit.className='btn small';
          bEdit.textContent='Editar';
          bEdit.onclick=()=>{ state.editingTimelineEntryId = entry.id; renderTimelineModal(); };
          const bDel = document.createElement('button');
          bDel.className='btn small';
          bDel.textContent='Excluir';
          bDel.onclick=async ()=>{
            const tTask=getTaskById(state.viewingTaskTimelineId);
            if(!tTask) return;
            const arr=Array.isArray(tTask.timeline)?tTask.timeline:[];
            tTask.timeline = arr.filter(e=>e.id!==entry.id);
            await saveTaskTimeline(tTask);
            renderTimelineModal();
          };
          act.append(bEdit,bDel);
        }

        top.append(left, act);

        const meta=document.createElement('div');
        meta.className='tl-meta';
        const tsLabel = entry.created_at ? fmtDateTime(entry.created_at) : '(sem data)';
        const stLabel = getTimelineStatusLabel(entry.status);
        meta.innerHTML = `<span>${stLabel}</span><span>•</span><span>${tsLabel}</span>`;

        const desc=document.createElement('div');
        desc.className='tl-desc';
        desc.textContent=entry.descricao||'';

        item.append(top, meta, desc);
      }

      tlList.append(item);
    });
  }

  async function addTimelineEntry(){
    const task = getTaskById(state.viewingTaskTimelineId);
    if(!task) return;
    // só autor pode adicionar
    if(task.autor && task.autor !== state.author){
      return showErr('Sem permissão','Somente o autor da tarefa pode registrar na timeline.');
    }
    const titulo = (id('tlNovoTitulo').value||'').trim() || '(sem título)';
    const descricao = (id('tlNovoDesc').value||'').trim() || '';
    const status = id('tlNovoStatus').value || 'parado';

    const entry = {
      id: crypto.randomUUID(),
      titulo,
      descricao,
      status,
      created_at: new Date().toISOString()
    };

    const arr = Array.isArray(task.timeline)?task.timeline:[];
    arr.push(entry);
    task.timeline = arr;

    // limpa campos
    id('tlNovoTitulo').value='';
    id('tlNovoDesc').value='';
    id('tlNovoStatus').value='parado';

    await saveTaskTimeline(task);
    renderTimelineModal();
  }

  /* ===== Render das tarefas ===== */
  function makeTaskCard(t){
    const card=document.createElement('div');
    card.className='card';
    card.classList.add('is-'+t.status);
    card.draggable=true;
    card.dataset.id=t.id;
    card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', t.id); });

    // clique geral abre timeline
    card.addEventListener('click', ()=> openTimelineModal(t.id) );

    const title=document.createElement('div'); title.className='title'; title.textContent=t.titulo||'(sem título)';

    const badges=document.createElement('div'); badges.className='badges';
    const stBadge=document.createElement('span'); stBadge.className='badge status-'+t.status; stBadge.textContent=t.status.replace('_',' ');
    const prazo=document.createElement('span'); prazo.className='badge'; prazo.textContent=t.prazo ? 'Prazo: '+fmtDate(t.prazo) : 'Sem prazo';
    badges.append(stBadge,prazo);

    const due=getDueBadge(t.prazo, t.status);
    if(due){ const b=document.createElement('span'); b.className='badge '+due.cls; b.textContent=due.text.toUpperCase(); badges.append(b); }

    const stRow=document.createElement('div'); stRow.className='row';
    const stLabel=document.createElement('span'); stLabel.className='muted'; stLabel.style.fontSize='12px'; stLabel.textContent='Status:';
    const stSel=document.createElement('select'); stSel.className='status-inline';
    stSel.innerHTML=`<option value="a_fazer">a fazer</option><option value="em_andamento">em andamento</option><option value="concluida">concluída</option>`;
    stSel.value=t.status;
    // impedir que o clique no select abra timeline
    stSel.addEventListener('click', ev=>ev.stopPropagation());
    stSel.onchange=async e=>{
      e.stopPropagation();
      await upsertTask({ id:t.id, status:e.target.value });
    };
    stRow.append(stLabel, stSel);

    const meta=document.createElement('div'); meta.className='muted'; meta.style.fontSize='12px';
    meta.textContent='Criada em: ' + (t.created_at ? fmtDateTime(t.created_at) : '—');

    const tags=document.createElement('div'); tags.className='tags';
    (t.responsaveis||[]).forEach(p=>{ const el=document.createElement('span'); el.className='tag'; el.textContent=p; tags.append(el); });

    const actions=document.createElement('div'); actions.className='actions';
    const bEdit=document.createElement('button'); bEdit.className='btn small'; bEdit.textContent='Editar';
    bEdit.onclick=(ev)=>{ ev.stopPropagation(); openTaskModal(t); };

    const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir';
    bDel.onclick=(ev)=>{ ev.stopPropagation(); deleteTask(t.id); };

    actions.append(bEdit,bDel);

    card.append(title);
    if(t.descricao){ const d=document.createElement('div'); d.className='muted'; d.textContent=t.descricao; card.append(d); }
    card.append(badges, stRow, meta, tags, actions);
    return card;
  }

  function renderTasks(){
    const cols={ atrasadas:id('col-atrasadas'), a_fazer:id('col-a_fazer'), em_andamento:id('col-em_andamento'), concluida:id('col-concluida') };
    Object.values(cols).forEach(el=>el.innerHTML='');

    const fSt=id('fStatus').value, fResp=id('fResp').value, fPrazo=id('fPrazo').value;

    const today=new Date(); today.setHours(0,0,0,0);
    const endWeek=new Date(today); endWeek.setDate(today.getDate() + (7 - today.getDay())); endWeek.setHours(23,59,59,999);

    let list=[...state.tasks];
    if(fSt!=='todos') list=list.filter(t=>t.status===fSt);
    if(fResp!=='todos') list=list.filter(t=>(t.responsaveis||[]).includes(fResp));

    const prazoToLocal=t=> t.prazo ? ymdToLocalDate(t.prazo) : null;

    if(state.filterDate){
      list=list.filter(t=>t.prazo===state.filterDate);
    }else{
      if(fPrazo==='hoje') list=list.filter(t=>{ const p=prazoToLocal(t); return p && p.getTime()===today.getTime(); });
      if(fPrazo==='semana') list=list.filter(t=>{ const p=prazoToLocal(t); return p && p>=today && p<=endWeek; });
      if(fPrazo==='atrasadas') list=list.filter(t=>{ const p=prazoToLocal(t); return p && p<today && t.status!=='concluida'; });
    }

    const isOverdue=t=>{ const p=prazoToLocal(t); return p && p<today && t.status!=='concluida'; };
    const overdue=list.filter(isOverdue);
    const notOverdue=list.filter(t=>!isOverdue(t));

    overdue.forEach(t=> cols.atrasadas.append(makeTaskCard(t)));

    const counts={a_fazer:0,em_andamento:0,concluida:0};
    notOverdue.forEach(t=>counts[t.status]=(counts[t.status]||0)+1);
    notOverdue.forEach(t=> cols[t.status].append(makeTaskCard(t)));

    qsa('.col').forEach(col=>{
      const st=col.dataset.status, badge=col.querySelector('header .badge'); if(!badge) return;
      badge.textContent = (st==='atrasadas') ? overdue.length : (counts[st]||0);
    });

    ['col-a_fazer','col-em_andamento','col-concluida'].forEach(cid=>{
      const dz=id(cid);
      dz.ondrop=async e=>{
        e.preventDefault();
        const idDrag=e.dataTransfer.getData('text/plain');
        const novo=cid.replace('col-','');
        const t=state.tasks.find(x=>x.id===idDrag); if(!t) return;
        await upsertTask({ id:t.id, status:novo });
        if(id('chkUpdateLink').checked) updateShareLink();
      };
    });
  }

  function renderNotes(){
    const wrap=id('notes'); wrap.innerHTML='';
    const ordered=[...state.notes].sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
    ordered.forEach(n=>{
      const dv=document.createElement('div'); dv.className='note';
      if(state.editingNoteId===n.id){
        const edit=document.createElement('div'); edit.className='note-edit';
        const sel=document.createElement('select'); sel.id=`edit_author_${n.id}`;
        sel.innerHTML=FIXED_RESPONSAVEIS.map(a=>`<option ${a===n.autor?'selected':''} value="${a}">${a}</option>`).join('');
        const ta=document.createElement('textarea'); ta.id=`edit_area_${n.id}`; ta.value=n.conteudo||'';
        const row=document.createElement('div'); row.className='actions';
        const bCancel=document.createElement('button'); bCancel.className='btn'; bCancel.textContent='Cancelar'; bCancel.onclick=()=>cancelEditNote();
        const bSave=document.createElement('button'); bSave.className='btn primary'; bSave.textContent='Salvar'; bSave.onclick=()=>saveEditNote(n.id);
        row.append(bCancel,bSave); edit.append(sel,ta,row); dv.append(edit);
      }else{
        const p=document.createElement('div'); p.textContent=n.conteudo; dv.append(p);
        const meta=document.createElement('div'); meta.className='note-meta';
        const created=fmtDateTime(n.created_at); const updated=n.updated_at?fmtDateTime(n.updated_at):null;
        meta.innerHTML=`<span>por <strong>${n.autor||'—'}</strong></span><span>•</span><span>${created}</span>` + (updated?` <span>•</span><span>(editado em ${updated})</span>`:'');
        dv.append(meta);
        const row=document.createElement('div'); row.className='actions';
        const bEdit=document.createElement('button'); bEdit.className='btn small'; bEdit.textContent='Editar'; bEdit.onclick=()=>startEditNote(n);
        const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir'; bDel.onclick=()=>deleteNote(n.id);
        row.append(bEdit,bDel); dv.append(row);
      }
      wrap.append(dv);
    });
  }

  function updateFilters(){
    const base=[...FIXED_RESPONSAVEIS];
    const extras=unique(state.tasks.flatMap(t=>t.responsaveis||[])).filter(n=>!base.includes(n)).sort();
    const opts=[...base,...extras];
    const sel=id('fResp'); const val=sel.value;
    sel.innerHTML='<option value="todos">todos</option>'+opts.map(o=>`<option value="${o}">${o}</option>`).join('');
    if(opts.includes(val)) sel.value=val; else sel.value='todos';
  }

  /* ===== Calendário ===== */
  function toggleCalendar(){ const pop=id('calPopover'); if(pop.classList.contains('hidden')) openCalendar(); else closeCalendar(); }
  function openCalendar(){
    if(!state.calMonth){
      const base = state.filterDate ? ymdToLocalDate(state.filterDate) : new Date();
      state.calMonth = new Date(base.getFullYear(), base.getMonth(), 1);
    }
    renderCalendar();
    id('calPopover').classList.remove('hidden');
    requestAnimationFrame(placeCalendarPopover);
  }
  function placeCalendarPopover(){
    const pop=id('calPopover'), btn=id('btnCal');
    const vw=window.innerWidth, vh=window.innerHeight;
    const r=btn.getBoundingClientRect();
    const popW=pop.offsetWidth||280, popH=pop.offsetHeight||280;

    if(vw<=420){
      pop.style.left='50%'; pop.style.transform='translateX(-50%)';
      pop.style.top=''; pop.style.bottom='calc(env(safe-area-inset-bottom, 0px) + 8px)';
      pop.style.width='calc(100vw - 16px)';
      return;
    }else{
      pop.style.bottom=''; pop.style.transform=''; pop.style.width='280px';
    }

    let left = r.left + (r.width/2) - (popW/2);
    left = Math.max(8, Math.min(left, vw - popW - 8));
    let top = r.bottom + 8;
    if(top + popH > vh - 8) top = r.top - popH - 8;
    top = Math.max(8, Math.min(top, vh - popH - 8));
    pop.style.left = left + 'px';
    pop.style.top  = top  + 'px';
  }
  function closeCalendar(){ id('calPopover').classList.add('hidden'); }

  function getTaskDatesSet(){ const set=new Set(); (state.tasks||[]).forEach(t=>{ if(t.prazo) set.add(t.prazo); }); return set; }

  function renderCalendar(){
    const pop=id('calPopover');
    const d=state.calMonth||new Date(); const y=d.getFullYear(), m=d.getMonth();
    const first=new Date(y,m,1); const firstDow=first.getDay(); const daysInMonth=new Date(y,m+1,0).getDate();
    const title=first.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
    const dows=['D','S','T','Q','Q','S','S']; const taskSet=getTaskDatesSet(); const todayStr=toYMD(new Date());

    let grid=''; grid+=dows.map(x=>`<div class="cal-dow">${x}</div>`).join(''); for(let i=0;i<firstDow;i++) grid+=`<div></div>`;
    for(let day=1; day<=daysInMonth; day++){
      const dt=new Date(y,m,day); const ymd=toYMD(dt);
      const has=taskSet.has(ymd); const isToday=ymd===todayStr; const isSel=state.filterDate===ymd;
      grid += `<div class="cal-day${has?' has-task':''}${isToday?' is-today':''}${isSel?' is-selected':''}" data-ymd="${ymd}">${day}</div>`;
    }

    pop.innerHTML=`
      <div class="cal">
        <div class="cal-head">
          <button class="btn small" id="calPrev">‹</button>
          <div class="title">${title}</div>
          <button class="btn small" id="calNext">›</button>
        </div>
        <div class="cal-grid">${grid}</div>
        <div class="row" style="justify-content:space-between; padding:0 6px 4px;">
          <button class="btn small" id="calHoje">Hoje</button>
          <button class="btn small" id="calFechar">Fechar</button>
        </div>
      </div>
    `;

    id('calPrev').onclick=()=>{ state.calMonth=new Date(y,m-1,1); renderCalendar(); placeCalendarPopover(); };
    id('calNext').onclick=()=>{ state.calMonth=new Date(y,m+1,1); renderCalendar(); placeCalendarPopover(); };
    id('calHoje').onclick=()=>{ const now=new Date(); state.calMonth=new Date(now.getFullYear(), now.getMonth(), 1); renderCalendar(); placeCalendarPopover(); };
    id('calFechar').onclick=closeCalendar;

    qsa('#calPopover .cal-day').forEach(el=>{
      el.onclick=()=>{ state.filterDate=el.dataset.ymd; id('fPrazo').value='todos'; closeCalendar(); render(); };
    });
  }

  function updateSelectedDayChip(){
    const chip=id('selDiaTag'), txt=id('selDiaText');
    if(state.filterDate){ chip.style.display=''; txt.textContent=fmtDate(state.filterDate); }
    else{ chip.style.display='none'; }
  }

  /* ===== Interações gerais ===== */
  function openTaskModal(t){
    state.editingTaskId = t?.id || null;
    id('taskModalTitle').textContent = t ? 'Editar tarefa' : 'Nova tarefa';
    id('tTitulo').value = t?.titulo || '';
    id('tDesc').value = t?.descricao || '';
    renderRespChoices(t?.responsaveis||[]);
    id('tPrazo').value = t?.prazo || '';
    id('tStatus').value = t?.status || 'a_fazer';
    id('dlgTask').showModal();
  }
  async function saveTaskFromModal(){
    const selected=Array.from(document.querySelectorAll('#tRespGroup input:checked')).map(i=>i.value);
    const obj={
      id: state.editingTaskId || undefined,
      titulo: id('tTitulo').value.trim() || 'Sem título',
      descricao: id('tDesc').value.trim() || null,
      responsaveis: selected,
      prazo: id('tPrazo').value || null,
      status: id('tStatus').value,
      autor: state.author,
    };
    if(!state.online) obj.board_slug=state.board;
    await upsertTask(obj);
    id('dlgTask').close();
    if(id('chkUpdateLink').checked) updateShareLink();
  }

  function updateShareLink(){ const url=new URL(location.href); url.searchParams.set('board',state.board); url.searchParams.set('theme',state.theme); history.replaceState({},'',url.toString()); }
  function generateShareLink(){ const url=new URL(location.href); url.searchParams.set('board',state.board); url.searchParams.set('theme',state.theme); navigator.clipboard.writeText(url.toString()); alert('Link copiado! Cole no WhatsApp para compartilhar.'); }
  function toggleTheme(){ state.theme=(state.theme==='dark')?'light':'dark'; localStorage.setItem('theme',state.theme); applyTheme(); updateShareLink(); }

  function exportCSV(){
    const rows=state.tasks.map(t=>({
      id:t.id,
      board:state.board,
      titulo:t.titulo,
      descricao:t.descricao||'',
      status:t.status,
      prazo:t.prazo||'',
      responsaveis:(t.responsaveis||[]).join('; '),
      autor:t.autor||'',
      criado_em:t.created_at||'',
      atualizado_em:t.updated_at||''
    }));
    const csv=toCSV(rows); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`tarefas_${state.board}.csv`; a.click();
  }

  // Eventos gerais
  document.getElementById('btnTheme').onclick = toggleTheme;
  document.getElementById('btnNova').onclick = ()=>openTaskModal();
  qsa('[data-add]').forEach(b=>b.onclick=()=>openTaskModal({status:b.getAttribute('data-add')}));
  document.getElementById('btnExport').onclick = exportCSV;
  document.getElementById('btnLink').onclick = generateShareLink;
  document.getElementById('tSalvar').onclick = saveTaskFromModal;
  document.getElementById('tCancelar').onclick = ()=>id('dlgTask').close();
  document.getElementById('btnAnotar').onclick = ()=>addNote(id('noteInput').value);
  document.getElementById('fStatus').onchange = render;
  document.getElementById('fResp').onchange = render;
  document.getElementById('fPrazo').onchange = ()=>{ state.filterDate=null; render(); };

  // Reuniões
  document.getElementById('btnMeetings').onclick = openMeetings;
  document.getElementById('mSalvar').onclick = saveMeetingFromModal;
  document.getElementById('mCancelar').onclick = ()=>{ id('mTitulo').value=''; id('mDesc').value=''; id('mData').value=''; id('mHora').value=''; };
  document.getElementById('mFechar').onclick = ()=>id('dlgMeetings').close();

  // Timeline
  document.getElementById('tlNovoSalvar').onclick = addTimelineEntry;
  document.getElementById('tlFechar').onclick = ()=>{
    state.viewingTaskTimelineId=null;
    state.editingTimelineEntryId=null;
    id('dlgTimeline').close();
  };

  // mini-calendário
  document.getElementById('btnCal').onclick = toggleCalendar;
  document.getElementById('btnClearDia').onclick = ()=>{ state.filterDate=null; render(); };
  document.addEventListener('click', (ev)=>{
    const pop=id('calPopover');
    if(pop.classList.contains('hidden')) return;
    if(!pop.contains(ev.target) && ev.target!==id('btnCal')) closeCalendar();
  });
  document.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') closeCalendar(); });
  window.addEventListener('resize', ()=>{ const pop=id('calPopover'); if(!pop.classList.contains('hidden')) placeCalendarPopover(); });
  window.addEventListener('scroll', ()=>{ const pop=id('calPopover'); if(!pop.classList.contains('hidden')) placeCalendarPopover(); }, true);

  (async function init(){
    const params=new URL(location.href).searchParams;
    const themeFromUrl=params.get('theme'); if(themeFromUrl){ state.theme=themeFromUrl; localStorage.setItem('theme',state.theme); applyTheme(); }
    renderNoteAuthors();
    await maybeInitSupabase();
    updateFilters();
    await fetchAll();
  })();
  </script>
</body>
</html>
