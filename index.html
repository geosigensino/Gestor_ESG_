<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eco Smart Group — Gestor de Tarefas</title>
  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b0d10; --panel:#0f1317; --card:#141922; --muted:#9aa4b2; --txt:#dde6ee;
      --brand:#185b24; --brand-2:#0f4319; --ok:#38c172; --warn:#ffcc00; --danger:#ef6b6b;
      --border:#1f2430; --shadow:0 10px 24px rgba(0,0,0,.35); --ring:0 0 0 3px rgba(24,91,36,.35);
    }
    .light{
      --bg:#f5f8fb; --panel:#fff; --card:#fff; --muted:#5c6675; --txt:#101317;
      --brand:#1b6a2a; --brand-2:#145021; --ok:#2f855a; --warn:#b7791f; --danger:#c53030;
      --border:#e6ebf2; --shadow:0 10px 24px rgba(16,19,23,.08); --ring:0 0 0 3px rgba(27,106,42,.18);
    }

    html,body{height:100%}
    body{margin:0;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--txt)}
    /* mais largura para respirar no desktop */
    .wrap{max-width:1400px;margin:0 auto;padding:22px 18px 36px}

    /* Cabeçalho */
    header{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{font-weight:800;font-size:22px;letter-spacing:.2px}
    .muted{color:var(--muted)}

    /* Barra de ações */
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:16px;padding:12px;border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);backdrop-filter:saturate(160%) blur(6px)}
    @media (min-width:981px){ .toolbar{position:sticky;top:0;z-index:10} }

    .pill{background:rgba(255,255,255,.05);color:var(--txt);padding:6px 10px;border:1px solid var(--border);border-radius:10px}

    /* Botões */
    .btn,button{cursor:pointer;border:1px solid var(--border);background:var(--panel);color:var(--txt);padding:9px 12px;border-radius:10px;box-shadow:var(--shadow);transition:transform .05s,box-shadow .2s,background .2s}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;border:none}
    .btn.primary:hover{filter:saturate(1.1);box-shadow:0 10px 22px rgba(24,91,36,.35)}
    .btn.small{padding:6px 9px}

    /* Layout: tarefas | notas (evita overflow e mantém alinhado) */
    .grid{
      display:grid;
      grid-template-columns: minmax(0,1.8fr) minmax(320px,1fr);
      gap:28px;
      margin-top:26px;
      align-items:start;
    }
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .panel h3{margin:18px;font-size:16px}

    /* Kanban — responsiva (não “empurra” o painel de notas) */
    .kanban{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px,1fr));
      gap:24px;
      padding:24px;
    }
    .col{background:var(--card);border:1px solid var(--border);border-radius:12px;min-height:260px;display:flex;flex-direction:column}
    .col header{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--border)}
    .dropzone{flex:1;padding:14px;min-height:160px}
    .dropzone.readonly{opacity:.9;pointer-events:none}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 6px;box-shadow:var(--shadow);transition:box-shadow .2s,transform .05s}
    .card:hover{box-shadow:0 10px 22px rgba(0,0,0,.25)}
    .title{font-weight:700}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{background:rgba(255,255,255,.06);border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .actions{display:flex;gap:8px;margin-top:10px}

    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,input[type="date"],input[type="text"]{background:var(--panel);color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:8px 10px}

    /* Select de status dentro do card (compacto) */
    .status-inline{font-size:12px;padding:4px 6px;border-radius:8px}

    /* Notas */
    .note{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 14px}
    .note-meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:6px}
    .note-edit{display:grid;gap:8px}
    textarea{width:100%;min-height:64px;background:var(--panel);color:var(--txt);border:1px solid var(--border);border-radius:10px;padding:8px 10px}

    .badges{display:flex;align-items:center;gap:8px}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel)}
    .status-em_andamento{background:#1f2a44;color:#cfe1ff}
    .status-a_fazer{background:#2b313a;color:#d5dae1}
    .status-concluida{background:#203a2a;color:#c8f5dd}

    .foot{margin-top:28px;display:flex;justify-content:space-between;align-items:center;color:var(--muted)}

    /* Chips de responsáveis (modal de tarefas) */
    .assignees{display:flex;gap:8px;flex-wrap:wrap}
    .assignees input[type="checkbox"]{display:none}
    .assignees label{user-select:none;cursor:pointer;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--panel);transition:background .2s,color .2s,box-shadow .2s}
    .assignees input[type="checkbox"]:checked + label{background:var(--brand);color:#fff;border-color:transparent;box-shadow:var(--ring)}

    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
      .kanban{grid-template-columns:1fr}
      .toolbar{position:static;top:auto}
    }

    /* --- MODAL CLARO (sempre) --- */
    dialog{ width:min(680px, calc(100% - 32px)); }
    dialog.modal-light{ background:#ffffff; color:#111827; border:1px solid #e6ebf2; border-radius:14px; box-shadow:var(--shadow); }
    dialog.modal-light::backdrop{ background:rgba(0,0,0,.45); }
    dialog.modal-light .modal-head{ padding:14px 16px; border-bottom:1px solid #e6ebf2; font-weight:700; color:#0f172a; }
    dialog.modal-light .modal-body{ padding:14px 16px; display:grid; gap:12px; }
    dialog.modal-light .modal-foot{ padding:14px 16px; border-top:1px solid #e6ebf2; display:flex; gap:10px; justify-content:flex-end; }
    dialog.modal-light label{ color:#4b5563; }

    dialog.modal-light input[type="text"],
    dialog.modal-light input[type="date"],
    dialog.modal-light select,
    dialog.modal-light textarea{
      background:#f8fafc; color:#0f172a; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px;
    }
    dialog.modal-light .assignees label{
      background:#f1f5f9; color:#0f172a; border:1px solid #e5e7eb;
    }
    dialog.modal-light .assignees input[type="checkbox"]:checked + label{
      background:var(--brand); color:#fff; border-color:transparent; box-shadow:0 0 0 3px rgba(24,91,36,.25);
    }
    dialog.modal-light .btn{ background:#f8fafc; color:#0f172a; border:1px solid #e5e7eb; }
    dialog.modal-light .btn.primary{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; border:none; }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div>
        <div class="brand">Eco Smart Group — Gestor de Tarefas</div>
        <div class="muted" id="modeLabel">Modo local • Snapshots por link — board: <span id="boardLabel">default</span></div>
      </div>
    </header>

    <div class="toolbar">
      <button class="btn primary" id="btnNova">+ Nova tarefa</button>

      <div class="filters">
        <span class="pill">Status:
          <select id="fStatus">
            <option value="todos">todos</option>
            <option value="a_fazer">a fazer</option>
            <option value="em_andamento">em andamento</option>
            <option value="concluida">concluída</option>
          </select>
        </span>
        <span class="pill">Responsável:
          <select id="fResp"><option value="todos">todos</option></select>
        </span>
        <span class="pill">Prazo:
          <select id="fPrazo">
            <option value="todos">todos</option>
            <option value="hoje">hoje</option>
            <option value="semana">esta semana</option>
            <option value="atrasadas">atrasadas</option>
          </select>
        </span>
      </div>

      <button class="btn" id="btnExport">Exportar CSV</button>
      <button class="btn" id="btnLink">Gerar link com dados</button>
      <label class="switch"><input type="checkbox" id="chkUpdateLink" checked> atualizar link ao editar</label>

      <span style="flex:1"></span>
      <button class="btn" id="btnTheme">Alternar tema</button>
    </div>

    <div class="grid">
      <section class="panel">
        <h3>Tarefas</h3>
        <div class="kanban">
          <div class="col" data-status="atrasadas">
            <header>
              <div class="row"><strong>Atrasadas</strong><span class="badge">0</span></div>
            </header>
            <div class="dropzone readonly" id="col-atrasadas"></div>
          </div>

          <div class="col" data-status="a_fazer">
            <header>
              <div class="row"><strong>A fazer</strong><span class="badge">0</span></div>
              <button class="btn small" data-add="a_fazer">+ adicionar</button>
            </header>
            <div class="dropzone" id="col-a_fazer" ondragover="event.preventDefault()"></div>
          </div>
          <div class="col" data-status="em_andamento">
            <header>
              <div class="row"><strong>Em andamento</strong><span class="badge">0</span></div>
              <button class="btn small" data-add="em_andamento">+ adicionar</button>
            </header>
            <div class="dropzone" id="col-em_andamento" ondragover="event.preventDefault()"></div>
          </div>
          <div class="col" data-status="concluida">
            <header>
              <div class="row"><strong>Concluídas</strong><span class="badge">0</span></div>
              <button class="btn small" data-add="concluida">+ adicionar</button>
            </header>
            <div class="dropzone" id="col-concluida" ondragover="event.preventDefault()"></div>
          </div>
        </div>
      </section>

      <section class="panel">
        <h3>Anotações gerais</h3>

        <div class="note">
          <div class="row" style="gap:10px;margin-bottom:8px">
            <label class="pill">Autor:
              <select id="noteAuthor"></select>
            </label>
            <span class="muted" id="noteNow"></span>
          </div>
          <textarea id="noteInput" placeholder="Escreva uma anotação…"></textarea>
          <div class="actions">
            <button class="btn" id="btnAnotar">Anotar</button>
          </div>
        </div>

        <div id="notes"></div>
      </section>
    </div>

    <div class="foot">
      <div>Feito com ❤ para equipes que precisam de algo simples, online e colaborativo.</div>
      <div class="muted" id="onlineState">Offline (LocalStorage)</div>
    </div>
  </div>

  <!-- MODAL: EDIÇÃO TAREFA (claro) -->
  <dialog id="dlgTask" class="modal-light">
    <div class="modal-head" id="taskModalTitle">Nova tarefa</div>
    <div class="modal-body">
      <div class="field"><label>Título</label><input id="tTitulo" type="text" placeholder="Ex.: Arquivos da Novo Agro" /></div>
      <div class="field"><label>Descrição (opcional)</label><input id="tDesc" type="text" placeholder="Detalhes curtos…" /></div>
      <div class="field">
        <label>Responsáveis</label>
        <div id="tRespGroup" class="assignees"></div>
      </div>
      <div class="field"><label>Prazo</label><input id="tPrazo" type="date" /></div>
      <div class="field"><label>Status</label>
        <select id="tStatus">
          <option value="a_fazer">a fazer</option>
          <option value="em_andamento">em andamento</option>
          <option value="concluida">concluída</option>
        </select>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="tCancelar">Cancelar</button>
      <button class="btn primary" id="tSalvar">Salvar</button>
    </div>
  </dialog>

  <script>
  /* ===== Supabase (fixo) ===== */
  const DEFAULT_SB_URL = 'https://oakntljdkkoqwttkgzpk.supabase.co';
  const DEFAULT_SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ha250bGpka2tvcXd0dGtnenBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzQzMDgsImV4cCI6MjA3MTYxMDMwOH0.jjxUzxyUoutDAVzZg9nrSi9kg5fYfs6F7PCd4xkT48c';

  /* ===== Responsáveis fixos ===== */
  const FIXED_RESPONSAVEIS = ['Bruno Ferreira', 'Bruno Santos', 'Carlos Barretto', 'João Tenório'];

  /* ===== Estado ===== */
  const state = {
    theme: localStorage.getItem('theme') || 'dark',
    board: new URL(location.href).searchParams.get('board') || 'default',
    author: 'Anônimo',
    supabaseUrl: DEFAULT_SB_URL,
    supabaseKey: DEFAULT_SB_KEY,
    client: null,
    tasks: [],
    notes: [],
    editingTaskId: null,
    editingNoteId: null,
    online: false,
  };

  /* Tema */
  function applyTheme(){ if(state.theme==='light') document.body.classList.add('light'); else document.body.classList.remove('light'); }
  applyTheme();

  /* ===== Helpers de data (corrigem o “voltar 1 dia”) ===== */
  const id = x => document.getElementById(x);
  const qsa = sel => Array.from(document.querySelectorAll(sel));
  const unique = arr => [...new Set(arr)];

  // Converte 'YYYY-MM-DD' em Date local (sem UTC)
  function ymdToLocalDate(s){
    if(!s) return null;
    const [y,m,d] = s.split('-').map(Number);
    return new Date(y, m-1, d); // local midnight
  }
  // Formata tanto 'YYYY-MM-DD' quanto ISO/Date para dd/mm/aaaa
  function fmtDate(d){
    if(!d) return '';
    const dt = (typeof d==='string' && /^\d{4}-\d{2}-\d{2}$/.test(d)) ? ymdToLocalDate(d) : new Date(d);
    return dt.toLocaleDateString();
  }
  function fmtDateTime(d){ return d ? new Date(d).toLocaleString() : ''; }

  const toCSV = rows=>{
    if(!rows.length) return '';
    const head = Object.keys(rows[0]);
    const body = rows.map(r => head.map(k => `"${String(r[k]??'').replaceAll('"','""')}"`).join(','));
    return [head.join(','), ...body].join('\n');
  };
  function showErr(ctx, err){ console.error(ctx, err); alert(`${ctx}:\n${(err && err.message) || err}`); }

  /* LocalStorage fallback */
  function lsKey(){ return `gst_${state.board}`; }
  function loadLocal(){ const raw = localStorage.getItem(lsKey()); if(!raw) return {tasks:[],notes:[]}; try{return JSON.parse(raw);}catch{return{tasks:[],notes:[]}} }
  function saveLocal(){ localStorage.setItem(lsKey(), JSON.stringify({tasks:state.tasks, notes:state.notes})); }

  /* Chips de responsáveis (modal de tarefa) */
  function renderRespChoices(selected=[]){
    const wrap = id('tRespGroup'); wrap.innerHTML='';
    FIXED_RESPONSAVEIS.forEach((name, idx)=>{
      const input=document.createElement('input'); input.type='checkbox'; input.id=`resp_${idx}`; input.value=name; if(selected.includes(name)) input.checked=true;
      const label=document.createElement('label'); label.htmlFor=input.id; label.textContent=name;
      wrap.append(input,label);
    });
  }

  /* Popular autores nas anotações */
  function renderNoteAuthors(){
    const sel = id('noteAuthor');
    sel.innerHTML = FIXED_RESPONSAVEIS.map(n=>`<option value="${n}">${n}</option>`).join('');
    id('noteNow').textContent = `agora: ${fmtDateTime(new Date())}`;
  }

  /* Supabase */
  async function maybeInitSupabase(){
    try{
      state.client = window.supabase.createClient(state.supabaseUrl, state.supabaseKey, { auth: { persistSession:false }});
      await state.client.from('boards').upsert({ slug: state.board, title: state.board }, { onConflict: 'slug' }).select();
      state.online = true;
      id('onlineState').textContent = 'Online (Supabase)';
      id('modeLabel').innerHTML = `Online • Snapshots por link — board: <span id="boardLabel">${state.board}</span>`;

      state.client.channel('ch-app')
        .on('postgres_changes', { event:'*', schema:'public', table:'tasks', filter:`board_slug=eq.${state.board}` }, handleRealtime)
        .on('postgres_changes', { event:'*', schema:'public', table:'notes', filter:`board_slug=eq.${state.board}` }, handleRealtime)
        .subscribe();
    }catch(e){
      state.online = false;
      id('onlineState').textContent = 'Offline (LocalStorage)';
      id('modeLabel').innerHTML = `Modo local • Snapshots por link — board: <span id="boardLabel">${state.board}</span>`;
      showErr('Falha ao conectar ao Supabase', e);
    }
  }
  async function handleRealtime(){ await fetchAll(); }

  /* CRUD */
  async function fetchAll(){
    if(state.online){
      const { data: t, error: e1 } = await state.client.from('tasks').select('*').eq('board_slug', state.board).order('created_at',{ascending:true});
      state.tasks = e1 ? [] : (t||[]);
      if(e1) showErr('Erro ao carregar tarefas', e1);

      const { data: n, error: e2 } = await state.client.from('notes').select('*').eq('board_slug', state.board).order('created_at',{ascending:true});
      state.notes = e2 ? [] : (n||[]);
      if(e2) showErr('Erro ao carregar anotações', e2);
    }else{
      const {tasks,notes} = loadLocal(); state.tasks=tasks; state.notes=notes;
    }
    render(); updateFilters(); renderNoteAuthors();
  }

  async function upsertTask(obj){
    if(state.online){
      if(obj.id){
        const { error } = await state.client.from('tasks').update(obj).eq('id', obj.id);
        if(error) return showErr('Erro ao atualizar tarefa', error);
      }else{
        const payload = { ...obj, board_slug: state.board };
        const { error } = await state.client.from('tasks').insert(payload);
        if(error) return showErr('Erro ao criar tarefa', error);
      }
    }else{
      if(!obj.id){
        obj.id = crypto.randomUUID();
        obj.created_at = new Date().toISOString();
      }
      const idx = state.tasks.findIndex(x=>x.id===obj.id);
      if(idx>=0) state.tasks[idx] = { ...state.tasks[idx], ...obj }; else state.tasks.push(obj);
      saveLocal();
    }
    await fetchAll();
  }
  async function deleteTask(idv){
    if(state.online){
      const { error } = await state.client.from('tasks').delete().eq('id', idv);
      if(error) return showErr('Erro ao excluir tarefa', error);
    }else{
      state.tasks = state.tasks.filter(t=>t.id!==idv); saveLocal();
    }
    await fetchAll();
  }

  async function addNote(content){
    const autor = id('noteAuthor').value;
    if(!content.trim()) return;
    if(state.online){
      const { error } = await state.client.from('notes').insert({ board_slug: state.board, conteudo: content, autor });
      if(error) return showErr('Erro ao criar anotação', error);
    }else{
      state.notes.push({ id: crypto.randomUUID(), conteudo: content, autor, created_at: new Date().toISOString(), updated_at: null });
      saveLocal();
    }
    id('noteInput').value=''; await fetchAll();
  }
  async function startEditNote(note){
    state.editingNoteId = note.id;
    renderNotes();
  }
  async function saveEditNote(idv){
    const area = id(`edit_area_${idv}`);
    const sel  = id(`edit_author_${idv}`);
    const newText = area.value.trim();
    const newAuthor = sel.value;
    if(!newText) return;
    if(state.online){
      const { error } = await state.client.from('notes').update({ conteudo:newText, autor:newAuthor }).eq('id', idv);
      if(error) return showErr('Erro ao salvar edição', error);
    }else{
      const idx = state.notes.findIndex(n=>n.id===idv);
      if(idx>=0){ state.notes[idx].conteudo=newText; state.notes[idx].autor=newAuthor; state.notes[idx].updated_at=new Date().toISOString(); saveLocal(); }
    }
    state.editingNoteId = null;
    await fetchAll();
  }
  function cancelEditNote(){ state.editingNoteId=null; renderNotes(); }
  async function deleteNote(idv){
    if(state.online){
      const { error } = await state.client.from('notes').delete().eq('id', idv);
      if(error) return showErr('Erro ao excluir anotação', error);
    }else{
      state.notes = state.notes.filter(n=>n.id!==idv); saveLocal();
    }
    await fetchAll();
  }

  /* Renderização */
  function render(){
    id('boardLabel').textContent = state.board;
    renderTasks();
    renderNotes();
  }

  // cria card de tarefa
  function makeTaskCard(t){
    const card=document.createElement('div'); card.className='card'; card.draggable=true; card.dataset.id=t.id;
    card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', t.id); });

    const title=document.createElement('div'); title.className='title'; title.textContent=t.titulo||'(sem título)';

    const badges=document.createElement('div'); badges.className='badges';
    const stBadge=document.createElement('span'); stBadge.className='badge status-'+t.status; stBadge.textContent=t.status.replace('_',' ');
    const prazo=document.createElement('span'); prazo.className='badge'; prazo.textContent=t.prazo ? 'Prazo: '+fmtDate(t.prazo) : 'Sem prazo';
    badges.append(stBadge,prazo);

    // seletor de status inline
    const stRow=document.createElement('div'); stRow.className='row';
    const stLabel=document.createElement('span'); stLabel.className='muted'; stLabel.style.fontSize='12px'; stLabel.textContent='Status:';
    const stSel=document.createElement('select'); stSel.className='status-inline';
    stSel.innerHTML = `
      <option value="a_fazer">a fazer</option>
      <option value="em_andamento">em andamento</option>
      <option value="concluida">concluída</option>`;
    stSel.value = t.status;
    stSel.onchange = async (e)=>{ await upsertTask({ id:t.id, status:e.target.value }); };
    stRow.append(stLabel, stSel);

    // meta criada em
    const meta=document.createElement('div'); meta.className='muted'; meta.style.fontSize='12px';
    meta.textContent = 'Criada em: ' + (t.created_at ? fmtDateTime(t.created_at) : '—');

    const tags=document.createElement('div'); tags.className='tags';
    (t.responsaveis||[]).forEach(p=>{ const el=document.createElement('span'); el.className='tag'; el.textContent=p; tags.append(el); });

    const actions=document.createElement('div'); actions.className='actions';
    const bEdit=document.createElement('button'); bEdit.className='btn small'; bEdit.textContent='Editar'; bEdit.onclick=()=>openTaskModal(t);
    const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir'; bDel.onclick=()=>deleteTask(t.id);
    actions.append(bEdit,bDel);

    card.append(title);
    if(t.descricao){ const d=document.createElement('div'); d.className='muted'; d.textContent=t.descricao; card.append(d); }
    card.append(badges, stRow, meta, tags, actions);
    return card;
  }

  function renderTasks(){
    const cols = {
      atrasadas: id('col-atrasadas'),
      a_fazer: id('col-a_fazer'),
      em_andamento: id('col-em_andamento'),
      concluida: id('col-concluida')
    };
    Object.values(cols).forEach(el=>el.innerHTML='');

    const fSt=id('fStatus').value, fResp=id('fResp').value, fPrazo=id('fPrazo').value;

    // Datas de referência (sem horas) para evitar bugs de fuso
    const today = new Date(); today.setHours(0,0,0,0);
    const endWeek = new Date(today); endWeek.setDate(today.getDate() + (7 - today.getDay())); endWeek.setHours(23,59,59,999);

    let list=[...state.tasks];
    if(fSt!=='todos') list=list.filter(t=>t.status===fSt);
    if(fResp!=='todos') list=list.filter(t=>(t.responsaveis||[]).includes(fResp));

    const prazoToLocal = (t)=> t.prazo ? ymdToLocalDate(t.prazo) : null;

    if(fPrazo==='hoje') list=list.filter(t=>{
      const p=prazoToLocal(t); return p && p.getTime()===today.getTime();
    });
    if(fPrazo==='semana') list=list.filter(t=>{
      const p=prazoToLocal(t); return p && p>=today && p<=endWeek;
    });
    if(fPrazo==='atrasadas') list=list.filter(t=>{
      const p=prazoToLocal(t); return p && p<today && t.status!=='concluida';
    });

    const isOverdue = (t)=>{ const p=prazoToLocal(t); return p && p<today && t.status!=='concluida'; };
    const overdue = list.filter(isOverdue);
    const notOverdue = list.filter(t=>!isOverdue(t));

    overdue.forEach(t=> cols.atrasadas.append(makeTaskCard(t)));

    const counts={a_fazer:0,em_andamento:0,concluida:0};
    notOverdue.forEach(t=>counts[t.status] = (counts[t.status]||0)+1);
    notOverdue.forEach(t=> cols[t.status].append(makeTaskCard(t)));

    qsa('.col').forEach(col=>{
      const st = col.dataset.status;
      const badge = col.querySelector('header .badge');
      if(!badge) return;
      if(st==='atrasadas') badge.textContent = overdue.length;
      else badge.textContent = counts[st] || 0;
    });

    // Drop apenas nas 3 colunas de status
    ['col-a_fazer','col-em_andamento','col-concluida'].forEach(cid=>{
      const dz = id(cid);
      dz.ondrop = async e=>{
        e.preventDefault();
        const idDrag=e.dataTransfer.getData('text/plain');
        const novo=cid.replace('col-','');
        const t=state.tasks.find(x=>x.id===idDrag); if(!t) return;
        await upsertTask({ id:t.id, status:novo });
        if(id('chkUpdateLink').checked) updateShareLink();
      };
    });
  }

  function renderNotes(){
    const wrap=id('notes'); wrap.innerHTML='';
    state.notes.forEach(n=>{
      const dv=document.createElement('div'); dv.className='note';
      if(state.editingNoteId===n.id){
        const edit=document.createElement('div'); edit.className='note-edit';
        const sel=document.createElement('select'); sel.id=`edit_author_${n.id}`;
        sel.innerHTML = FIXED_RESPONSAVEIS.map(a=>`<option ${a===n.autor?'selected':''} value="${a}">${a}</option>`).join('');
        const ta=document.createElement('textarea'); ta.id=`edit_area_${n.id}`; ta.value=n.conteudo||'';
        const row=document.createElement('div'); row.className='actions';
        const bCancel=document.createElement('button'); bCancel.className='btn'; bCancel.textContent='Cancelar'; bCancel.onclick=()=>cancelEditNote();
        const bSave=document.createElement('button'); bSave.className='btn primary'; bSave.textContent='Salvar'; bSave.onclick=()=>saveEditNote(n.id);
        row.append(bCancel,bSave);
        edit.append(sel,ta,row); dv.append(edit);
      }else{
        const p=document.createElement('div'); p.textContent=n.conteudo; dv.append(p);
        const meta=document.createElement('div'); meta.className='note-meta';
        const created = fmtDateTime(n.created_at);
        const updated = n.updated_at ? fmtDateTime(n.updated_at) : null;
        meta.innerHTML = `<span>por <strong>${n.autor||'—'}</strong></span><span>•</span><span>${created}</span>` + (updated ? ` <span>•</span><span>(editado em ${updated})</span>` : '');
        dv.append(meta);
        const row=document.createElement('div'); row.className='actions';
        const bEdit=document.createElement('button'); bEdit.className='btn small'; bEdit.textContent='Editar'; bEdit.onclick=()=>startEditNote(n);
        const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir'; bDel.onclick=()=>deleteNote(n.id);
        row.append(bEdit,bDel); dv.append(row);
      }
      wrap.append(dv);
    });
  }

  function updateFilters(){
    const base=[...FIXED_RESPONSAVEIS];
    const extras=unique(state.tasks.flatMap(t=>t.responsaveis||[])).filter(n=>!base.includes(n)).sort();
    const opts=[...base,...extras];
    const sel=id('fResp'); const val=sel.value;
    sel.innerHTML='<option value="todos">todos</option>'+opts.map(o=>`<option value="${o}">${o}</option>`).join('');
    if(opts.includes(val)) sel.value=val; else sel.value='todos';
  }

  /* Interações gerais */
  function openTaskModal(t){
    state.editingTaskId = t?.id || null;
    id('taskModalTitle').textContent = t ? 'Editar tarefa' : 'Nova tarefa';
    id('tTitulo').value = t?.titulo || '';
    id('tDesc').value = t?.descricao || '';
    renderRespChoices(t?.responsaveis||[]);
    // ⚠️ Sem conversão para ISO: evita “menos um dia”
    id('tPrazo').value = t?.prazo || '';
    id('tStatus').value = t?.status || 'a_fazer';
    id('dlgTask').showModal();
  }
  async function saveTaskFromModal(){
    const selected = Array.from(document.querySelectorAll('#tRespGroup input:checked')).map(i=>i.value);
    const obj = {
      id: state.editingTaskId || undefined,
      titulo: id('tTitulo').value.trim() || 'Sem título',
      descricao: id('tDesc').value.trim() || null,
      responsaveis: selected,
      prazo: id('tPrazo').value || null, // envia 'YYYY-MM-DD'
      status: id('tStatus').value,
      autor: state.author,
    };
    if(!state.online) obj.board_slug = state.board;
    await upsertTask(obj);
    id('dlgTask').close();
    if(id('chkUpdateLink').checked) updateShareLink();
  }

  function updateShareLink(){ const url=new URL(location.href); url.searchParams.set('board',state.board); url.searchParams.set('theme',state.theme); history.replaceState({},'',url.toString()); }
  function generateShareLink(){ const url=new URL(location.href); url.searchParams.set('board',state.board); url.searchParams.set('theme',state.theme); navigator.clipboard.writeText(url.toString()); alert('Link copiado! Cole no WhatsApp para compartilhar.'); }
  function toggleTheme(){ state.theme=(state.theme==='dark')?'light':'dark'; localStorage.setItem('theme',state.theme); applyTheme(); updateShareLink(); }

  function exportCSV(){
    const rows = state.tasks.map(t=>({
      id:t.id, board:state.board, titulo:t.titulo, descricao:t.descricao||'',
      status:t.status, prazo:t.prazo||'', responsaveis:(t.responsaveis||[]).join('; '),
      autor:t.autor||'', criado_em:t.created_at||'', atualizado_em:t.updated_at||''
    }));
    const csv=toCSV(rows); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`tarefas_${state.board}.csv`; a.click();
  }

  /* Eventos */
  document.getElementById('btnTheme').onclick = toggleTheme;
  document.getElementById('btnNova').onclick = ()=>openTaskModal();
  qsa('[data-add]').forEach(b=>b.onclick=()=>openTaskModal({status:b.getAttribute('data-add')}));
  document.getElementById('btnExport').onclick = exportCSV;
  document.getElementById('btnLink').onclick = generateShareLink;
  document.getElementById('tSalvar').onclick = saveTaskFromModal;
  document.getElementById('tCancelar').onclick = ()=>id('dlgTask').close();
  document.getElementById('btnAnotar').onclick = ()=>addNote(id('noteInput').value);
  document.getElementById('fStatus').onchange = render;
  document.getElementById('fResp').onchange = render;
  document.getElementById('fPrazo').onchange = render;

  /* Inicialização */
  (async function init(){
    const params=new URL(location.href).searchParams;
    const themeFromUrl=params.get('theme'); if(themeFromUrl){ state.theme=themeFromUrl; localStorage.setItem('theme',state.theme); applyTheme(); }
    renderNoteAuthors();
    await maybeInitSupabase();
    updateFilters();
    await fetchAll();
  })();
  </script>
</body>
</html>
