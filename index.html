<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Eco Smart Group ‚Äî Gestor de Tarefas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
  /* =================== TOKENS DE TEMA =================== */
  :root{
    --bg:#0b0d10; --panel:#0f1317; --card:#141922; --muted:#9aa4b2; --txt:#dde6ee;
    --brand:#185b24; --brand-2:#0f4319; --ok:#38c172; --warn:#ffcc00; --danger:#ef6b6b;
    --border:#1f2430; --shadow:0 10px 24px rgba(0,0,0,.35); --ring:0 0 0 3px rgba(24,91,36,.35);
  }
  .light{
    --bg:#f5f8fb; --panel:#fff; --card:#fff; --muted:#5c6675; --txt:#101317;
    --brand:#1b6a2a; --brand-2:#145021; --ok:#2f855a; --warn:#b7791f; --danger:#c53030;
    --border:#e6ebf2; --shadow:0 10px 24px rgba(16,19,23,.08); --ring:0 0 0 3px rgba(27,106,42,.18);
  }

  /* ===== Tokens por status ===== */
  :root{
    --st-todo-bg:rgba(251,191,36,.14); --st-todo-bd:rgba(251,191,36,.40); --st-todo-tx:#fde68a;
    --st-prog-bg:rgba(59,130,246,.14); --st-prog-bd:rgba(59,130,246,.40); --st-prog-tx:#bfdbfe;
    --st-done-bg:rgba(16,185,129,.14); --st-done-bd:rgba(16,185,129,.35); --st-done-tx:#a7f3d0;
    --st-late-bg:rgba(239,68,68,.16); --st-late-bd:rgba(239,68,68,.45); --st-late-tx:#fecaca;
  }
  .light{
    --st-todo-bg:#fffbeb; --st-todo-bd:#fde68a; --st-todo-tx:#92400e;
    --st-prog-bg:#eff6ff; --st-prog-bd:#bfdbfe; --st-prog-tx:#1d4ed8;
    --st-done-bg:#ecfdf5; --st-done-bd:#a7f3d0; --st-done-tx:#065f46;
    --st-late-bg:#fef2f2; --st-late-bd:#fecaca; --st-late-tx:#991b1b;
  }

  /* =================== BASE =================== */
  html,body{height:100%}
  html{ -webkit-text-size-adjust:100%; } /* evita zoom/‚Äúaumento‚Äù autom√°tico no iOS/Android */
  body{
    margin:0;
    font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg); color:var(--txt);
    overflow-x: hidden; /* elimina barra de rolagem horizontal no mobile */
  }

  .app-shell{ display:grid; grid-template-columns: 280px 1fr; min-height:100vh; }
  .sidebar{
    background:var(--panel); border-right:1px solid var(--border); padding:14px; position:sticky; top:0; height:100vh;
    box-sizing:border-box; display:flex; flex-direction:column; gap:12px;
  }

  .brand{font-weight:800;font-size:18px;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .sidebar .btn{ width:100%; }
  .proj-search{ display:flex; gap:8px; }
  .proj-search input{ flex:1; }
  .proj-list{ display:grid; gap:6px; overflow:auto; padding-right:4px; }
  .proj-item{ display:grid; grid-template-columns: 1fr auto; grid-template-rows:auto auto; gap:6px 8px; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px; cursor:pointer; }
  .proj-item:hover{ box-shadow:var(--shadow); }
  .proj-item .title{ font-weight:600; }
  .proj-actions{ display:flex; gap:6px; align-items:center; }
  .proj-stats{ display:flex; flex-wrap:wrap; gap:6px; grid-column:1 / -1; }
  .kpi{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:var(--panel); }
  .kpi.late{ background:var(--st-late-bg); color:var(--st-late-tx); border-color:var(--st-late-bd) }
  .kpi.todo{ background:var(--st-todo-bg); color:var(--st-todo-tx); border-color:var(--st-todo-bd) }
  .kpi.prog{ background:var(--st-prog-bg); color:var(--st-prog-tx); border-color:var(--st-prog-bd) }
  .kpi.done{ background:var(--st-done-bg); color:var(--st-done-tx); border-color:var(--st-done-bd) }

  /* menu de contexto (projetos) */
  .menu-wrap{ position:relative; }
  .menu-btn{ padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:var(--panel); }
  .context-menu{
    position:absolute; right:0; top:110%; z-index:20; background:var(--panel); border:1px solid var(--border);
    border-radius:10px; box-shadow:var(--shadow); display:none; min-width:180px; overflow:hidden;
  }
  .context-menu.open{ display:block; }
  .context-menu button{
    display:block; width:100%; text-align:left; border:none; background:transparent; color:var(--txt);
    padding:10px 12px; cursor:pointer; border-bottom:1px solid var(--border);
  }
  .context-menu button:last-child{ border-bottom:none; }
  .context-menu button:hover{ background:rgba(255,255,255,.04); }

  .main{ display:flex; flex-direction:column; gap:0; }
  header.main-head{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap; padding:16px 18px; border-bottom:1px solid var(--border);
    background:var(--panel); position:sticky; top:0; z-index:10;
    padding-top: calc(14px + env(safe-area-inset-top)); /* respeita notch */
  }
  .crumbs{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .crumbs .sep{ opacity:.5; }

  .btn,button{
    cursor:pointer; border:1px solid var(--border);background:var(--panel);color:var(--txt);
    padding:9px 12px;border-radius:10px;box-shadow:var(--shadow); transition:transform .05s,box-shadow .2s,background .2s
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{ background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;border:none }
  .btn.primary:hover{filter:saturate(1.1);box-shadow:0 10px 22px rgba(24,91,36,.35)}
  .btn.small{padding:6px 9px}

  .spacer{ flex:1; }

  .toolbar{
    display:flex;gap:12px;align-items:center;flex-wrap:wrap; padding:12px 18px; border-bottom:1px solid var(--border);
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent); backdrop-filter:saturate(160%) blur(6px);
    position:sticky; top:60px; z-index:9;
  }

  @media (max-width:980px){
    .app-shell{ grid-template-columns: 1fr; }
    .sidebar{ position:fixed; z-index:30; left:0; top:0; bottom:0; width:min(86vw, 360px); transform:translateX(-100%); transition:transform .2s; }
    .sidebar.open{ transform:none; }
    header.main-head{ position:sticky; top:0; }
  }

  /* ===== Melhoria de responsividade no MOBILE ===== */
  @media (max-width: 768px){
    /* evita ‚Äúestouro‚Äù lateral logo ao abrir o link */
    .wrap, .panel, .kanban, .subtabs, .toolbar, header.main-head { max-width: 100vw; }
    .toolbar{
      position: sticky;
      top: calc(48px + env(safe-area-inset-top));
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      overflow: visible;
      padding: 10px 12px;
    }
    .toolbar .btn,
    .toolbar .pill,
    .toolbar select{
      width: 100%;
    }
    .pill{ font-size: 13px; }
    .wrap{ padding: 0 12px 24px; }
    .kanban{ grid-template-columns: 1fr !important; gap:16px; padding:16px; }
    .panel h3{ margin: 12px; font-size: 15px; }
    .subtabs{
      position: sticky;
      top: calc(108px + env(safe-area-inset-top));
      z-index: 8;
      padding: 8px 12px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .subtabs::-webkit-scrollbar{ height: 6px; }
    .subtab{ white-space: nowrap; }
    .foot{ flex-direction: column; gap: 8px; padding-bottom: env(safe-area-inset-bottom); }
  }

  .pill{ background:rgba(255,255,255,.05);color:var(--txt); padding:6px 10px;border:1px solid var(--border);border-radius:10px }
  select,input[type="date"],input[type="text"],input[type="time"]{ background:var(--panel);color:var(--txt); border:1px solid var(--border);border-radius:10px;padding:8px 10px }

  .subtabs{
    display:flex; gap:8px; flex-wrap:wrap; padding:10px 18px; border-bottom:1px solid var(--border);
    background:var(--panel); position:sticky; top:114px; z-index:8;
  }
  .subtab{ border:1px solid var(--border); background:var(--card); color:var(--txt); padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer; }
  .subtab.active{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; border:none; }

  .wrap{max-width:1400px;margin:0 auto;padding:0 18px 36px}
  .grid{ display:grid;grid-template-columns:minmax(0,1.8fr) minmax(320px,1fr); gap:28px;margin-top:18px;align-items:start }
  .panel{ background:var(--panel);border:1px solid var(--border); border-radius:14px;box-shadow:var(--shadow);overflow:hidden }
  .panel h3{margin:18px;font-size:16px}
  .kanban{ display:grid;grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:24px;padding:24px }
  .col{ background:var(--card);border:1px solid var(--border); border-radius:12px;min-height:260px;display:flex;flex-direction:column }
  .col header{ display:flex;align-items:center;justify-content:space-between; padding:14px;border-bottom:1px solid var(--border) }
  .dropzone{flex:1;padding:14px;min-height:160px}
  .dropzone.readonly{opacity:.95}
  .card{ background:var(--panel);border:1px solid var(--border);border-radius:12px; padding:14px;margin:12px 6px;box-shadow:var(--shadow); transition:box-shadow .2s,transform .05s; cursor:pointer }
  .card:hover{box-shadow:0 10px 22px rgba(0,0,0,.25)}
  .title{font-weight:700}
  .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .tag{ background:rgba(255,255,255,.06);border:1px solid var(--border); padding:4px 8px;border-radius:999px;font-size:12px }
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .actions{display:flex;gap:8px;margin-top:10px}
  .actions .btn.small{cursor:pointer}
  .status-inline{font-size:12px;padding:4px 6px;border-radius:8px}
  .note{ background:var(--card);border:1px solid var(--border); border-radius:12px;padding:12px;margin:10px 14px }
  .note-meta{ display:flex;gap:8px;flex-wrap:wrap; color:var(--muted);font-size:12px;margin-top:6px }
  .note-edit{display:grid;gap:8px}
  textarea{ width:100%;min-height:64px; background:var(--panel);color:var(--txt); border:1px solid var(--border);border-radius:10px;padding:8px 10px }
  .badges{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .badge{ font-size:12px;padding:2px 8px;border-radius:999px; border:1px solid var(--border);background:var(--panel) }
  .badge.status-a_fazer{ background:var(--st-todo-bg);color:var(--st-todo-tx);border-color:var(--st-todo-bd) }
  .badge.status-em_andamento{ background:var(--st-prog-bg);color:var(--st-prog-tx);border-color:var(--st-prog-bd) }
  .badge.status-concluida{ background:var(--st-done-bg);color:var(--st-done-tx);border-color:var(--st-done-bd) }
  .col[data-status="atrasadas"] .card{ background:var(--st-late-bg);border-color:var(--st-late-bd) }
  .col[data-status="atrasadas"] .badge{ background:transparent;color:var(--st-late-tx);border-color:var(--st-late-bd) }
  .card.is-a_fazer{box-shadow:inset 3px 0 0 0 var(--st-todo-bd)}
  .card.is-em_andamento{box-shadow:inset 3px 0 0 0 var(--st-prog-bd)}
  .card.is-concluida{box-shadow:inset 3px 0 0 0 var(--st-done-bd)}
  .col:not([data-status="atrasadas"]) .card.is-a_fazer{ background:var(--st-todo-bg);border-color:var(--st-todo-bd) }
  .col:not([data-status="atrasadas"]) .card.is-em_andamento{ background:var(--st-prog-bg);border-color:var(--st-prog-bd) }
  .col:not([data-status="atrasadas"]) .card.is-concluida{ background:var(--st-done-bg);border-color:var(--st-done-bd) }

  .foot{display:flex;align-items:center;gap:12px;padding:12px 18px;border-top:1px solid var(--border)}
  .login-overlay{ position:fixed; inset:0; z-index:999; background:rgba(0,0,0,.6); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; }
  .login-card{ background:var(--panel); padding:24px; border-radius:14px; box-shadow:var(--shadow); width:min(90vw, 380px); }
  .login-card.shake{ animation:h-shake .4s; }
  @keyframes h-shake{ 0%,100%{transform:translateX(0)} 10%,30%,50%,70%,90%{transform:translateX(-6px)} 20%,40%,60%,80%{transform:translateX(6px)} }
  body.locked{ overflow:hidden; }

  .modal-light{ max-width:min(94vw,680px); border-radius:14px; border:1px solid var(--border); background:var(--panel); color:var(--txt); box-shadow:var(--shadow); }
  .modal-light::backdrop{ background:rgba(0,0,0,.5); backdrop-filter:blur(6px); }
  .modal-head{ font-size:18px; font-weight:700; padding:16px 20px; border-bottom:1px solid var(--border); }
  .modal-body{ padding:16px 20px; }
  .modal-foot{ padding:12px 20px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:10px; }
  .field{ display:grid; gap:4px; margin-bottom:12px; }
  .field label{ font-size:13px; font-weight:600; color:var(--muted); }
  .field input, .field select, .field textarea{ width:100%; box-sizing:border-box; }

  .meeting-list{ display:grid; gap:12px; max-height:320px; overflow:auto; padding:8px; background:var(--card); border-radius:10px; border:1px solid var(--border); margin-top:4px; }
  .meeting-item{ padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--bg); }
  .meeting-top{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .meeting-meta{ font-size:12px; color:var(--muted); display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:4px; }
  .meeting-actions{ display:flex; gap:6px; }

  .tl-body-grid{ display:grid; grid-template-columns:260px 1fr; gap:20px; align-items:start; }
  .tl-brief-card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
  .tl-brief-title{ font-weight:700; }
  .tl-brief-badges{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .tl-brief-chip{ font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:var(--panel); }
  .tl-brief-meta{ font-size:12px; color:var(--muted); margin-top:8px; }
  .timeline-form-head{ font-weight:700; margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid var(--border); }
  .tl-edit-row{ display:grid; gap:4px; margin-bottom:10px; }
  .tl-edit-row label{ font-size:12px; color:var(--muted); }
  .tl-save-row{ display:flex; justify-content:flex-end; margin-top:12px; }
  .tl-history-head{ font-weight:700; margin:16px 0 8px; }
  .tl-item{ position:relative; padding:0 0 16px 24px; border-left:2px solid var(--border); }
  .tl-item:last-child{ border-left-color:transparent; }
  .tl-item-dot{ position:absolute; left:-7px; top:4px; width:12px; height:12px; border-radius:999px; background:var(--bg); border:2px solid var(--border); }
  .tl-item-dot.dot-parado{ border-color:var(--st-late-bd); }
  .tl-item-dot.dot-andamento{ border-color:var(--st-todo-bd); }
  .tl-item-dot.dot-concluido{ border-color:var(--st-done-bd); }
  .tl-top-line{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
  .tl-titulo{ font-weight:600; }
  .tl-line2{ display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted); margin-top:2px; }
  .tl-pill{ padding:2px 8px; border-radius:999px; font-size:11px; }
  .tl-pill.tl-pill-parado{ background:var(--st-late-bg); color:var(--st-late-tx); border:1px solid var(--st-late-bd); }
  .tl-pill.tl-pill-andamento{ background:var(--st-todo-bg); color:var(--st-todo-tx); border:1px solid var(--st-todo-bd); }
  .tl-pill.tl-pill-concluido{ background:var(--st-done-bg); color:var(--st-done-tx); border:1px solid var(--st-done-bd); }
  .tl-actions{ display:flex; gap:6px; }
  .tl-desc{ font-size:13px; margin-top:6px; }

  .cal-wrap{ border:1px solid var(--border); border-radius:12px; background:var(--card); overflow:hidden; }
  .cal-head{ display:flex; align-items:center; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border); }
  .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:var(--border); }
  .cal-day-head{ text-align:center; font-size:11px; padding:6px 0; background:var(--panel); color:var(--muted); }
  .cal-day{ min-height:60px; background:var(--panel); padding:4px; font-size:12px; cursor:pointer; transition:background .2s; }
  .cal-day:hover{ background:var(--card); }
  .cal-day.other-month{ opacity:.5; }
  .cal-day.is-today{ font-weight:800; }
  .cal-day.is-selected{ background:var(--brand); color:#fff; }
  .cal-day .count{ font-size:11px; background:var(--st-prog-bg); color:var(--st-prog-tx); border:1px solid var(--st-prog-bd); padding:1px 4px; border-radius:999px; margin-top:4px; display:inline-block; }

  .share-link-wrap{ margin-top:12px; padding-top:12px; border-top:1px solid var(--border); }
  .share-link-wrap input{ width:100%; box-sizing:border-box; }

  /* Melhorias de responsividade para o modal de timeline */
  @media (max-width: 768px) {
    .tl-body-grid { grid-template-columns: 1fr; }
    .tl-brief-card { margin-bottom: 16px; }
  }

  </style>
</head>
<body>

<div class="app-shell">
  <aside class="sidebar" id="sidebar">
    <div class="brand">Eco Smart Group</div>
    <div class="muted" style="font-size:12px">Gestor de Tarefas</div>
    <button class="btn primary" id="btnNovoProjeto">+ Novo projeto</button>
    <div class="proj-search">
      <input type="text" id="projSearch" placeholder="Buscar projeto‚Ä¶" />
      <button class="btn" id="btnSearchProj">üîé</button>
    </div>
    <div style="display:flex;align-items:center;gap:8px;font-size:12px"><input type="checkbox" id="chkShowArchived" /><label for="chkShowArchived">Mostrar arquivados</label></div>
    <div class="proj-list" id="projList"></div>
    <div class="spacer"></div>
    <div class="foot">
      <div id="onlineState" class="muted" style="font-size:12px">Verificando‚Ä¶</div>
      <button class="btn" id="btnToggleTheme">Mudar tema</button>
    </div>
  </aside>

  <main class="main">
    <header class="main-head">
      <button class="btn small" id="btnMenu">‚ò∞</button>
      <div class="crumbs">
        <span id="modeLabel">Projetos</span> <span class="sep">/</span> <span id="crumbProject">‚Äî</span>
      </div>
      <div class="spacer"></div>
      <div id="boardInfo" class="muted" style="font-size:12px;text-align:right"></div>
    </header>

    <div id="viewProjects">
      <div class="toolbar">
        <div class="pill">Vis√£o geral de projetos</div>
      </div>
      <div class="wrap">
        <div id="projectsGrid" class="kanban"></div>
      </div>
    </div>

    <div id="viewProjectBoard" style="display:none">
      <div class="toolbar" id="projectToolbar" style="display:none">
        <button class="btn primary" id="btnNovaTarefa">+ Nova tarefa</button>
        <button class="btn" id="btnReunioes">üóìÔ∏è Reuni√µes</button>
        <button class="btn" id="btnDashboard">üìä Dashboard</button>
        <div class="spacer"></div>
        <select id="fStatus">
          <option value="todos">Todos status</option>
          <option value="a_fazer">A fazer</option>
          <option value="em_andamento">Em andamento</option>
          <option value="concluida">Conclu√≠da</option>
        </select>
        <select id="fResp"></select>
        <select id="fPrazo">
          <option value="todos">Qualquer prazo</option>
          <option value="hoje">Vence hoje</option>
          <option value="semana">Nesta semana</option>
          <option value="atrasadas">Atrasadas</option>
        </select>
        <button class="btn" id="btnLimparFiltros">Limpar</button>
      </div>

      <div class="subtabs" id="subtabs" style="display:none">
        <button class="subtab active" data-scope="todas">Todas</button>
        <button class="subtab" data-scope="atrasadas">Atrasadas</button>
        <button class="subtab" data-scope="a_fazer">A fazer</button>
        <button class="subtab" data-scope="em_andamento">Em andamento</button>
        <button class="subtab" data-scope="concluida">Conclu√≠das</button>
      </div>

      <div class="wrap">
        <div class="grid">
          <div class="panel">
            <h3 id="projBoardTitle">Tarefas</h3>
            <div class="kanban">
              <div class="col" data-status="atrasadas">
                <header><span>Atrasadas</span><span class="badge">0</span></header>
                <div class="dropzone" id="col-atrasadas"></div>
              </div>
              <div class="col" data-status="a_fazer">
                <header><span>A fazer</span><span class="badge">0</span></header>
                <div class="dropzone" id="col-a_fazer"></div>
              </div>
              <div class="col" data-status="em_andamento">
                <header><span>Em andamento</span><span class="badge">0</span></header>
                <div class="dropzone" id="col-em_andamento"></div>
              </div>
              <div class="col" data-status="concluida">
                <header><span>Conclu√≠da</span><span class="badge">0</span></header>
                <div class="dropzone readonly" id="col-concluida"></div>
              </div>
            </div>
          </div>

          <div style="display:grid;gap:18px;align-content:start">
            <div class="panel">
              <h3>üóìÔ∏è Calend√°rio de Prazos</h3>
              <div style="padding:0 18px 18px">
                <div class="cal-wrap">
                  <div class="cal-head">
                    <button id="calPrev" class="btn small">‚Äπ</button>
                    <span id="calMonthLabel"></span>
                    <button id="calNext" class="btn small">‚Ä∫</button>
                  </div>
                  <div class="cal-grid" id="calDays"></div>
                </div>
                <div class="share-link-wrap">
                  <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Link p√∫blico (somente leitura, atualizado ao salvar):</div>
                  <input type="text" readonly id="shareLink" />
                  <div style="font-size:11px;margin-top:4px"><input type="checkbox" id="chkUpdateLink" /><label for="chkUpdateLink">Atualizar link ao mudar status</label></div>
                </div>
              </div>
            </div>
            <div class="panel">
              <h3>Anota√ß√µes gerais</h3>
              <div style="padding:0 18px 18px">
                <div class="note-edit">
                  <select id="noteAuthor"></select>
                  <textarea id="noteText" placeholder="Digite sua anota√ß√£o aqui‚Ä¶"></textarea>
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <span id="noteNow" class="muted" style="font-size:12px"></span>
                    <button class="btn primary" id="btnSalvarNota">Salvar</button>
                  </div>
                </div>
                <div id="notes"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="login-overlay" id="loginOverlay">
  <div class="login-card" id="loginCard">
    <div style="font-weight:700;font-size:18px;margin-bottom:4px">Acesso restrito</div>
    <div class="muted" style="margin-bottom:16px">Digite a senha para continuar.</div>
    <div class="field"><label>Senha</label><input id="pwdInput" type="password" /></div>
    <div id="loginErr" style="color:var(--danger);font-size:13px;margin-top:8px;display:none">Senha incorreta.</div>
    <div class="actions" style="margin-top:16px;justify-content:space-between">
      <button class="btn" id="pwdShow">üëÅ Mostrar</button>
      <button class="btn primary" id="pwdEnter">Entrar</button>
    </div>
  </div>
</div>

<dialog id="dlgTask" class="modal-light">
  <div class="modal-head">Nova tarefa</div>
  <div class="modal-body">
    <div class="field"><label>T√≠tulo</label><input id="tTitulo" type="text" placeholder="Ex.: Modelar banco de dados" /></div>
    <div class="field"><label>Descri√ß√£o (opcional)</label><textarea id="tDesc" placeholder="Detalhes da tarefa‚Ä¶"></textarea></div>
    <div class="field"><label>Prazo (opcional)</label><input id="tPrazo" type="date" /></div>
    <div class="field"><label>Respons√°veis (selecione 1 ou mais)</label>
      <select id="tResps" multiple size="5"></select>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn" id="tCancelar">Cancelar</button>
    <button class="btn primary" id="tSalvar">Salvar</button>
  </div>
</dialog>

<dialog id="dlgMeetings" class="modal-light">
  <div class="modal-head">Reuni√µes</div>
  <div class="modal-body">
    <div class="field"><label>Respons√°vel</label> <select id="mResp"></select></div>
    <div class="field"><label>T√≠tulo</label> <input id="mTitulo" type="text" placeholder="Ex.: Reuni√£o com Cliente X" /></div>
    <div class="field"><label>Descri√ß√£o (opcional)</label> <input id="mDesc" type="text" placeholder="Pauta breve‚Ä¶" /></div>
    <div class="row" style="gap:10px">
      <div class="field"><label>Dia</label><input id="mData" type="date" /></div>
      <div class="field"><label>Hora</label><input id="mHora" type="time" /></div>
    </div>
    <div class="actions" style="justify-content:flex-end">
      <button class="btn" id="mCancelar">Limpar</button>
      <button class="btn primary" id="mSalvar">Salvar reuni√£o</button>
    </div>
    <div style="margin-top:8px;font-weight:700">Registros</div>
    <div id="meetingList" class="meeting-list"></div>
  </div>
  <div class="modal-foot"><button class="btn" id="mFechar">Fechar</button></div>
</dialog>

<dialog id="dlgTimeline" class="modal-light">
  <div class="modal-head" id="tlTaskTitle">Timeline / Hist√≥rico</div>
  <div class="modal-body">
    <div class="tl-body-grid">
      <section class="tl-brief-card">
        <div class="tl-brief-title" id="tlBriefTitulo">(t√≠tulo)</div>
        <div class="tl-brief-badges" id="tlBriefBadges"></div>
        <div class="tl-brief-meta" id="tlBriefMeta"></div>
      </section>
      <section class="tl-col-main">
        <div id="tlFormWrap" class="timeline-form" style="display:none">
          <div class="timeline-form-head"><span>Novo registro</span></div>
          <div class="tl-edit-row"><label>T√≠tulo</label><input id="tlNovoTitulo" type="text" placeholder="Ex.: Documento entregue / Reuni√£o feita" /></div>
          <div class="tl-edit-row"><label>Descri√ß√£o</label><textarea id="tlNovoDesc" placeholder="Descreva rapidamente o que aconteceu‚Ä¶"></textarea></div>
          <div class="tl-edit-row"><label>Status</label>
            <select id="tlNovoStatus">
              <option value="parado">Parado (vermelho)</option>
              <option value="andamento">Em andamento (amarelo)</option>
              <option value="concluido">Conclu√≠do (verde)</option>
            </select>
          </div>
          <div class="tl-save-row"><button class="btn primary" id="tlNovoSalvar">Adicionar na timeline</button></div>
        </div>
        <div class="tl-history-head">Hist√≥rico</div>
        <div id="tlList" class="timeline-entries"></div>
      </section>
    </div>
  </div>
  <div class="modal-foot"><button class="btn" id="tlFechar">Fechar</button></div>
</dialog>

<dialog id="dlgProject" class="modal-light">
  <div class="modal-head">Novo projeto</div>
  <div class="modal-body">
    <div class="field"><label>Nome do projeto</label><input id="pTitulo" type="text" placeholder="Ex.: Projeto Rond√¥nia" /></div>
    <div class="muted" style="font-size:12px">Exemplos: ‚ÄúProjeto Rond√¥nia‚Äù, ‚ÄúProjeto Par√°‚Äù.</div>
  </div>
  <div class="modal-foot">
    <button class="btn" id="pCancelar">Cancelar</button>
    <button class="btn primary" id="pSalvar">Criar</button>
  </div>
</dialog>

<dialog id="dlgDash" class="modal-light">
  <div class="modal-head">Dashboard ‚Äî M√©tricas</div>
  <div class="modal-body" style="display:grid; gap:16px">
    <div class="tl-brief-card">
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <span class="tl-brief-chip" id="dbTotalConcluidas">Conclu√≠das: 0</span>
        <span class="tl-brief-chip" id="dbPctNoPrazo">% no prazo: 0%</span>
        <span class="tl-brief-chip" id="dbLeadTime">Lead time m√©d.: ‚Äî</span>
      </div>
    </div>
    <div class="panel" style="padding:12px">
      <div style="font-weight:700; margin:6px 6px 10px">Tarefas entregues nos √∫ltimos 30 dias</div>
      <canvas id="dbLast30" height="120"></canvas>
    </div>
    <div class="panel" style="padding:12px">
      <div style="font-weight:700; margin:6px 6px 10px">% no prazo √ó com atraso</div>
      <canvas id="dbPct" height="120"></canvas>
    </div>
  </div>
  <div class="modal-foot"><button class="btn" id="dbFechar">Fechar</button></div>
</dialog>

<script>
/* =================== CONFIG GERAL =================== */
const DEFAULT_SB_URL = 'https://jyqfqazhcvrvwvgptuld.supabase.co';
const DEFAULT_SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5cWZxYXpoY3Zydnd2Z3B0dWxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMjE0ODUsImV4cCI6MjA3OTY5NzQ4NX0.6hw23rwEmEc4HLdhP6tEssYWPBXcnYSixUjI0A2i26c';
const FIXED_RESPONSAVEIS = ['Bruno Ferreira','Bruno Santos','Carlos Barretto','Gustavo', 'Carla', 'Rose'];

const state = {
  theme: localStorage.getItem('theme') || 'dark',
  author: 'An√¥nimo',
  projects: [],
  projectStats: {},
  currentProject: null,
  supabaseUrl: DEFAULT_SB_URL,
  supabaseKey: DEFAULT_SB_KEY,
  client: null,
  online:false,
  tasks: [], notes: [], meetings: [],
  editingTaskId: null, editingNoteId: null,
  viewingTaskTimelineId:null, editingTimelineEntryId:null,
  filterDate:null, calMonth:null, subScope:'todas',
};

/* ========== Cadeado simples ========== */
const APP_PASSWORD = 'esg2025*';
const AUTH_FLAG = 'gst_auth_ok';
let appStarted = false;

function bootWithPassword(){
  const ok = sessionStorage.getItem(AUTH_FLAG) === '1';
  const overlay = document.getElementById('loginOverlay');
  const pwdInput = document.getElementById('pwdInput');
  const btnEnter = document.getElementById('pwdEnter');
  const btnShow = document.getElementById('pwdShow');
  const err = document.getElementById('loginErr');

  function startAppOnce(){ if(appStarted) return; appStarted = true; startApp(); }
  function showLocked(){ document.body.classList.add('locked'); overlay.style.display = 'flex'; pwdInput.value = ''; err.style.display = 'none'; setTimeout(()=>pwdInput.focus(), 80); }
  function unlock(){ document.body.classList.remove('locked'); overlay.style.display = 'none'; sessionStorage.setItem(AUTH_FLAG, '1'); startAppOnce(); }
  function wrong(){ err.style.display = 'block'; const card = document.getElementById('loginCard'); card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake'); }

  btnEnter.onclick = ()=>{ if(pwdInput.value === APP_PASSWORD) unlock(); else wrong(); };
  btnShow.onclick = ()=>{ if(pwdInput.type === 'password'){ pwdInput.type = 'text'; btnShow.textContent = 'üôà Ocultar'; } else { pwdInput.type = 'password'; btnShow.textContent = 'üëÅ Mostrar'; } };
  pwdInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnEnter.click(); });

  if(ok){ startAppOnce(); } else { showLocked(); }
}
document.addEventListener('DOMContentLoaded', bootWithPassword);

/* =================== Helpers =================== */
function applyTheme(){ if(state.theme==='light') document.body.classList.add('light'); else document.body.classList.remove('light'); }
applyTheme();
const id = x => document.getElementById(x);
const qsa = s => Array.from(document.querySelectorAll(s));
const unique = a => [...new Set(a)];
const pad2 = n => String(n).padStart(2,'0');
const toYMD = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
function ymdToLocalDate(s){ if(!s) return null; const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function fmtDate(d){ if(!d) return ''; const dt=(typeof d==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(d))?ymdToLocalDate(d):new Date(d); return dt.toLocaleDateString(); }
function fmtTime(hm){ if(!hm) return ''; const [h,m]=(hm||'').split(':').map(Number); const d=new Date(); d.setHours(h||0,m||0,0,0); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
function fmtDateTime(d){ return d?new Date(d).toLocaleString():''; }
const toCSV = rows=>{
  if(!rows.length) return '';
  const head=Object.keys(rows[0]);
  const body=rows.map(r=>head.map(k=>`"${String(r[k]??'').replaceAll('"','""')}"`).join(','));
  return [head.join(','),...body].join('\n');
};
function showErr(ctx, err){ console.error(ctx, err); alert(`${ctx}:\n${(err && err.message) || err}`); }
function sanitizeSlug(text){
  return (text||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')
    || ('proj-'+Math.random().toString(36).slice(2,7));
}

/* =================== Storage Local =================== */
const ARCH_KEY = 'gst_archived_slugs';
function lsKeyProj(){ return `gst_projects`; }
function lsKeyData(slug){ return `gst_${slug}`; }
function loadProjectsLocal(){ try{ return JSON.parse(localStorage.getItem(lsKeyProj()))||[]; }catch{return [];} }
function saveProjectsLocal(arr){ localStorage.setItem(lsKeyProj(), JSON.stringify(arr||[])); }
function loadProjectDataLocal(slug){
  const raw=localStorage.getItem(lsKeyData(slug));
  if(!raw) return {tasks:[],notes:[],meetings:[]};
  try{ const obj=JSON.parse(raw); return { tasks:obj.tasks||[], notes:obj.notes||[], meetings:obj.meetings||[] }; }
  catch{ return {tasks:[],notes:[],meetings:[]}; }
}
function saveProjectDataLocal(slug, data){
  localStorage.setItem(lsKeyData(slug), JSON.stringify({ tasks:data.tasks||[], notes:data.notes||[], meetings:data.meetings||[] }));
}
function loadArchivedSet(){ try{ return new Set(JSON.parse(localStorage.getItem(ARCH_KEY))||[]); }catch{return new Set();} }
function saveArchivedSet(set){ localStorage.setItem(ARCH_KEY, JSON.stringify([...set])); }

/* =================== Supabase =================== */
async function maybeInitSupabase(){
  try{
    state.client = window.supabase.createClient(state.supabaseUrl, state.supabaseKey, { auth: { persistSession:false }});
    state.online = true;
    id('onlineState').textContent='Online (Supabase)';
    id('modeLabel').textContent='Online ‚Ä¢ Projetos';
    state.client.channel('ch-boards').on('postgres_changes', { event:'*', schema:'public', table:'boards' }, fetchProjectsAndStats).subscribe();
    state.client.channel('ch-app')
      .on('postgres_changes', { event:'*', schema:'public', table:'tasks' }, handleRealtimeIfCurrent)
      .on('postgres_changes', { event:'*', schema:'public', table:'notes' }, handleRealtimeIfCurrent)
      .on('postgres_changes', { event:'*', schema:'public', table:'meetings' }, handleRealtimeIfCurrent)
      .subscribe();
  }catch(e){
    state.online=false;
    id('onlineState').textContent='Offline (LocalStorage)';
    id('modeLabel').textContent='Modo local ‚Ä¢ Projetos';
    console.warn('Sem Supabase, operando local:', e);
  }
}
async function handleRealtimeIfCurrent(){ await fetchProjectData(); }

/* =================== Projetos + Contadores =================== */
async function fetchProjectsAndStats(){
  if(state.online){
    const { data, error } = await state.client.from('boards').select('*').order('created_at',{ascending:true});
    if(error){ console.warn('Boards fallback local', error); state.projects = loadProjectsLocal(); }
    else { state.projects = (data||[]).map(b=>({slug:b.slug, title:b.title||b.slug, archived: !!b.archived})); saveProjectsLocal(state.projects); }

    const slugs = state.projects.map(p=>p.slug);
    const { data:stats, error:errStats } = await state.client.rpc('get_board_stats', { board_slugs: slugs });
    if(errStats){ console.warn('Stats fallback local', errStats); state.projectStats = {}; }
    else{ state.projectStats = (stats||[]).reduce((acc,s)=>{ acc[s.board_slug] = s; return acc; }, {}); }

  }else{
    state.projects = loadProjectsLocal();
    state.projectStats = {}; // contagem local n√£o implementada
  }
  renderSidebarProjects(); renderProjectsView();
}
async function upsertProject(title, slug=null){
  const newSlug = slug || sanitizeSlug(title);
  const newTitle = title || newSlug;
  if(state.online){
    const { error } = await state.client.from('boards').upsert({ slug: newSlug, title: newTitle });
    if(error) return showErr('Erro ao salvar projeto', error);
  }else{
    const arr = loadProjectsLocal();
    const existing = arr.find(p=>p.slug===newSlug);
    if(existing){ existing.title = newTitle; } else { arr.push({ slug: newSlug, title: newTitle }); }
    saveProjectsLocal(arr);
  }
  await fetchProjectsAndStats();
  return newSlug;
}
async function renameProject(slug, newTitle){
  if(state.online){
    const { error } = await state.client.from('boards').update({ title: newTitle }).eq('slug', slug);
    if(error) return showErr('Erro ao renomear projeto', error);
  }else{
    const arr = loadProjectsLocal(); const p = arr.find(p=>p.slug===slug); if(p) p.title=newTitle; saveProjectsLocal(arr);
  }
  await fetchProjectsAndStats();
}
async function toggleArchiveProject(slug, isArchived){
  if(state.online){
    const { error } = await state.client.from('boards').update({ archived: isArchived }).eq('slug', slug);
    if(error) return showErr('Erro ao arquivar/desarquivar', error);
  }else{
    const archived = loadArchivedSet(); if(isArchived) archived.add(slug); else archived.delete(slug); saveArchivedSet(archived);
  }
  await fetchProjectsAndStats();
}
async function duplicateProject(slug){
  const p = state.projects.find(p=>p.slug===slug); if(!p) return;
  const newTitle = p.title + ' (c√≥pia)';
  const newSlug = await upsertProject(newTitle);
  if(!newSlug) return;
  const data = state.online ? (await state.client.from('tasks').select('*').eq('board_slug',slug)).data : loadProjectDataLocal(slug).tasks;
  if(state.online){
    const newTasks = (data||[]).map(t=>({...t, id:undefined, created_at:undefined, updated_at:undefined, board_slug:newSlug}));
    if(newTasks.length) await state.client.from('tasks').insert(newTasks);
  }else{
    saveProjectsLocal([...(loadProjectsLocal()), { slug:newSlug, title:newTitle }]);
    saveProjectDataLocal(newSlug, JSON.parse(JSON.stringify(data)));
  }
  await fetchProjectsAndStats(); selectProject(newSlug);
}
async function deleteProject(slug){
  if(!confirm('Excluir projeto e todos os dados locais/online?')) return;
  if(state.online){
    try{
      await state.client.from('tasks').delete().eq('board_slug', slug);
      await state.client.from('notes').delete().eq('board_slug', slug);
      await state.client.from('meetings').delete().eq('board_slug', slug);
      await state.client.from('boards').delete().eq('slug', slug);
    }catch(e){ return showErr('Erro ao excluir projeto', e); }
  }else{
    localStorage.removeItem(lsKeyData(slug));
    const arr = loadProjectsLocal().filter(p=>p.slug!==slug); saveProjectsLocal(arr);
  }
  if(state.currentProject?.slug === slug) state.currentProject=null;
  await fetchProjectsAndStats(); showProjectsHome();
}

/* =================== Projetos: UI (sidebar/grade + menu) =================== */
function kpiBadge(label, val, cls){ const span=document.createElement('span'); span.className='kpi '+cls; span.textContent=`${label}: ${val}`; return span; }
function isArchived(slug){ const proj = state.projects.find(p=>p.slug===slug); const localSet = loadArchivedSet(); return proj?.archived || localSet.has(slug); }
function filteredProjects(){
  const q = (id('projSearch').value||'').toLowerCase().trim(); const showArchived = id('chkShowArchived').checked;
  return state.projects.filter(p=>{ if(!showArchived && isArchived(p.slug)) return false; return !q || p.title.toLowerCase().includes(q) || p.slug.includes(q); });
}
function renderSidebarProjects(){
  const list = id('projList'); list.innerHTML='';
  const arr = filteredProjects();
  if(!arr.length){ list.innerHTML = `<div class="muted">Nenhum projeto encontrado.</div>`; return; }
  arr.forEach(p=>{
    const item = document.createElement('div'); item.className='proj-item'; item.onclick=()=> selectProject(p.slug);
    const t = document.createElement('div'); t.className='title'; t.textContent = p.title + (isArchived(p.slug)?' (arquivado)':'');
    const actions = document.createElement('div'); actions.className='proj-actions';
    const wrap=document.createElement('div'); wrap.className='menu-wrap'; wrap.onclick=e=>e.stopPropagation();
    const btn=document.createElement('button'); btn.className='menu-btn'; btn.textContent='‚ãØ';
    const menu=document.createElement('div'); menu.className='context-menu';
    const bRen=document.createElement('button'); bRen.textContent='Renomear'; bRen.onclick=()=>{ const nv=prompt('Novo nome:', p.title); if(nv&&nv.trim()) renameProject(p.slug, nv.trim()); menu.classList.remove('open'); };
    const bDup=document.createElement('button'); bDup.textContent='Duplicar'; bDup.onclick=()=>{ duplicateProject(p.slug); menu.classList.remove('open'); };
    const bArc=document.createElement('button'); bArc.textContent=isArchived(p.slug)?'Desarquivar':'Arquivar'; bArc.onclick=()=>{ toggleArchiveProject(p.slug, !isArchived(p.slug)); menu.classList.remove('open'); };
    const bDel=document.createElement('button'); bDel.textContent='Excluir'; bDel.onclick=()=>{ deleteProject(p.slug); menu.classList.remove('open'); };
    menu.append(bRen,bDup,bArc,bDel); btn.onclick=()=>{ qsa('.context-menu').forEach(m=>m.classList.remove('open')); menu.classList.toggle('open'); };
    wrap.append(btn,menu); actions.append(wrap);

    const stats=state.projectStats[p.slug]||{todo:0,prog:0,done:0,late:0};
    const statLine=document.createElement('div'); statLine.className='proj-stats';
    statLine.append( kpiBadge('Atrasadas', stats.late, 'late'), kpiBadge('A fazer', stats.todo, 'todo'), kpiBadge('Em andamento', stats.prog, 'prog'), kpiBadge('Conclu√≠das', stats.done, 'done') );

    item.append(t, actions, statLine); list.append(item);
  });
  document.addEventListener('click', (ev)=>{ if(!ev.target.closest('.menu-wrap')) qsa('.context-menu').forEach(m=>m.classList.remove('open')); });
}
function renderProjectsView(){
  const grid = id('projectsGrid'); grid.innerHTML='';
  const arr = filteredProjects();
  if(!state.projects.length){
    grid.innerHTML = `<div class="card">
      <div class="title">Sem projetos ainda</div>
      <div class="muted" style="margin-top:6px">Crie seu primeiro projeto para come√ßar (ex.: Projeto Rond√¥nia).</div>
      <div class="actions" style="margin-top:10px"><button class="btn primary" id="gridNovoProjeto">+ Criar projeto</button></div>
    </div>`;
    const b = id('gridNovoProjeto'); if(b) b.onclick=()=>openProjectModal(); return;
  }
  arr.forEach(p=>{
    const card=document.createElement('div'); card.className='card'; card.style.cursor='pointer'; card.onclick=()=>selectProject(p.slug);
    const title=document.createElement('div'); title.className='title'; title.textContent=p.title + (isArchived(p.slug)?' (arquivado)':'');
    const meta=document.createElement('div'); meta.className='muted'; meta.style.fontSize='12px'; meta.textContent=`slug: ${p.slug}`;
    const stats=state.projectStats[p.slug]||{todo:0,prog:0,done:0,late:0};
    const kpis=document.createElement('div'); kpis.className='proj-stats';
    kpis.append( kpiBadge('Atrasadas', stats.late, 'late'), kpiBadge('A fazer', stats.todo, 'todo'), kpiBadge('Em and.', stats.prog, 'prog'), kpiBadge('Concl.', stats.done, 'done') );
    const actions=document.createElement('div'); actions.className='actions';
    const del=document.createElement('button'); del.className='btn small'; del.textContent='Excluir'; del.onclick=(ev)=>{ev.stopPropagation(); deleteProject(p.slug);};
    actions.append(del);
    card.append(title, meta, kpis, actions); grid.append(card);
  });
}
function showProjectsHome(){
  id('viewProjects').style.display=''; id('viewProjectBoard').style.display='none'; id('projectToolbar').style.display='none'; id('subtabs').style.display='none';
  id('crumbProject').textContent='‚Äî'; id('boardInfo').textContent='Selecione um projeto na sidebar ou na grade.';
}
async function selectProject(slug){
  const p = (state.projects||[]).find(x=>x.slug===slug); if(!p) return;
  state.currentProject = p; id('crumbProject').textContent = p.title;
  id('projBoardTitle').textContent = `Tarefas ‚Äî ${p.title}`;
  id('boardInfo').textContent = `Projeto: ${p.title} (slug: ${p.slug})`;
  id('viewProjects').style.display='none'; id('viewProjectBoard').style.display=''; id('projectToolbar').style.display=''; id('subtabs').style.display='';
  const url=new URL(location.href); url.searchParams.set('board', p.slug); url.searchParams.set('theme', state.theme); history.replaceState({},
'',url.toString());
  await fetchProjectData(); closeSidebar();
}
function openProjectModal(){ id('pTitulo').value=''; id('dlgProject').showModal(); }
async function saveProjectFromModal(){ const title=(id('pTitulo').value||'').trim(); if(!title) return showErr('Projeto inv√°lido','Informe um nome.'); await upsertProject(title); id('dlgProject').close(); }

/* =================== Dados do Projeto =================== */
async function fetchProjectData(){
  if(!state.currentProject) return; const slug = state.currentProject.slug;
  if(state.online){
    const { data: t, error: e1 } = await state.client.from('tasks').select('*').eq('board_slug', slug).order('created_at',{ascending:true});
    state.tasks = e1 ? [] : (t||[]); if(e1) showErr('Erro ao carregar tarefas', e1);
    const { data: n, error: e2 } = await state.client.from('notes').select('*').eq('board_slug', slug).order('created_at',{ascending:false});
    state.notes = e2 ? [] : (n||[]); if(e2) showErr('Erro ao carregar anota√ß√µes', e2);
    const { data: m, error: e3 } = await state.client.from('meetings').select('*').eq('board_slug', slug).order('created_at',{ascending:false});
    state.meetings = e3 ? [] : (m||[]); if(e3) showErr('Erro ao carregar reuni√µes', e3);
    saveProjectDataLocal(slug, {tasks:state.tasks, notes:state.notes, meetings:state.meetings});
  }else{
    const {tasks,notes,meetings} = loadProjectDataLocal(slug); state.tasks=tasks; state.notes=notes; state.meetings=meetings;
  }
  renderProjectBoard(); renderMeetingList(); renderNoteAuthors();
  if(state.viewingTaskTimelineId) renderTimelineModal();
  await fetchProjectsAndStats();
}

/* =================== Meetings / Notes =================== */
function renderMeetingResponsaveis(){ id('mResp').innerHTML = FIXED_RESPONSAVEIS.map(n=>`<option value="${n}">${n}</option>`).join(''); }
function renderNoteAuthors(){
  id('noteAuthor').innerHTML=FIXED_RESPONSAVEIS.map(n=>`<option value="${n}">${n}</option>`).join('');
  id('noteNow').textContent=`agora: ${fmtDateTime(new Date())}`;
}
async function upsertMeeting(obj){
  const slug = state.currentProject?.slug; if(!slug) return showErr('Projeto n√£o selecionado','Selecione um projeto.');
  if(state.online){
    if(obj.id){
      const { error } = await state.client.from('meetings').update({ ...obj, updated_at:new Date().toISOString() }).eq('id', obj.id);
      if(error) return showErr('Erro ao atualizar reuni√£o', error);
    }else{
      const tempId = crypto.randomUUID();
      const optimistic = { id: tempId, board_slug: slug, created_at: new Date().toISOString(), ...obj };
      state.meetings = [optimistic, ...(state.meetings||[])]; renderMeetingList();
      const { data, error } = await state.client.from('meetings').insert({ ...obj, board_slug: slug }).select().single();
      if(error){ state.meetings = state.meetings.filter(m => m.id !== tempId); renderMeetingList(); return showErr('Erro ao criar reuni√£o', error); }
      const ix = state.meetings.findIndex(m => m.id === tempId); if(ix >= 0) state.meetings[ix] = data; renderMeetingList(); return;
    }
  }else{
    const data = loadProjectDataLocal(slug);
    if(!obj.id){ obj.id=crypto.randomUUID(); obj.created_at=new Date().toISOString(); }
    const idx=data.meetings.findIndex(x=>x.id===obj.id);
    if(idx>=0){ data.meetings[idx]={...data.meetings[idx],...obj}; } else { data.meetings.unshift(obj); }
    saveProjectDataLocal(slug, data);
  }
  await fetchProjectData();
}
async function deleteMeeting(idv){
  const slug = state.currentProject?.slug; if(!slug) return;
  const backup = [...(state.meetings||[])]; state.meetings = state.meetings.filter(m => m.id !== idv); renderMeetingList();
  if(state.online){
    const { error } = await state.client.from('meetings').delete().eq('id', idv);
    if(error){ state.meetings = backup; renderMeetingList(); return showErr('Erro ao excluir reuni√£o', error); }
  }else{
    const data = loadProjectDataLocal(slug); data.meetings = (data.meetings||[]).filter(m=>m.id!==idv); saveProjectDataLocal(slug, data);
  }
}
function openMeetings(){ renderMeetingResponsaveis(); id('mResp').value = FIXED_RESPONSAVEIS[0] || ''; id('mTitulo').value = ''; id('mDesc').value = ''; id('mData').value = ''; id('mHora').value = ''; renderMeetingList(); id('dlgMeetings').showModal(); }
function renderMeetingList(){
  const wrap=id('meetingList'); if(!wrap) return; wrap.innerHTML='';
  const list = [...(state.meetings||[])].sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
  if(!list.length){ wrap.innerHTML = `<div class="muted">Sem reuni√µes registradas.</div>`; return; }
  list.forEach(m=>{
    const dv=document.createElement('div'); dv.className='meeting-item';
    const top=document.createElement('div'); top.className='meeting-top';
    const ttl=document.createElement('div'); ttl.className='title'; ttl.textContent=m.titulo||'(sem t√≠tulo)';
    const actions=document.createElement('div'); actions.className='meeting-actions';
    const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir'; bDel.onclick=()=>deleteMeeting(m.id);
    actions.append(bDel); top.append(ttl, actions);
    const meta=document.createElement('div'); meta.className='meeting-meta';
    const resp=`<span class="kpi">${m.responsavel||'‚Äî'}</span>`;
    const dia = m.data ? fmtDate(m.data) : 'sem dia';
    const hora= m.hora ? fmtTime(m.hora) : '';
    meta.innerHTML = `${resp}<span>‚Ä¢</span><span>${dia}${hora? ' ‚Äî '+hora:''}</span><span>‚Ä¢</span><span>criada: ${fmtDateTime(m.created_at)}</span>`;
    const desc=document.createElement('div'); desc.className='muted'; desc.textContent=m.descricao||'';
    dv.append(top, meta, desc); wrap.append(dv);
  });
}
async function saveMeetingFromModal(){
  const responsavel=id('mResp').value; const titulo=(id('mTitulo').value||'').trim(); const descricao=(id('mDesc').value||'').trim() || null;
  const data=id('mData').value || null; const hora=id('mHora').value || null;
  if(!titulo || !responsavel || !data || !hora){ return showErr('Formul√°rio incompleto','Preencha respons√°vel, t√≠tulo, dia e hora.'); }
  const obj = { titulo, descricao, responsavel, data, hora, autor: state.author };
  await upsertMeeting(obj);
  id('mTitulo').value=''; id('mDesc').value=''; id('mData').value=''; id('mHora').value='';
}

/* =================== Board/Tarefas =================== */
async function upsertTask(obj){
  if(!state.currentProject) return showErr('Projeto n√£o selecionado','Selecione um projeto.');
  const slug = state.currentProject.slug;
  if(state.online){
    if(obj.id){
      const { error } = await state.client.from('tasks').update(obj).eq('id', obj.id);
      if(error) return showErr('Erro ao atualizar tarefa', error);
    }else{
      const payload = { ...obj, board_slug: slug };
      const { error } = await state.client.from('tasks').insert(payload);
      if(error) return showErr('Erro ao criar tarefa', error);
    }
  }else{
    if(!obj.id){ obj.id=crypto.randomUUID(); obj.created_at=new Date().toISOString(); }
    const data = loadProjectDataLocal(slug);
    const idx=data.tasks.findIndex(x=>x.id===obj.id);
    if(idx>=0){ data.tasks[idx]={...data.tasks[idx],...obj}; } else { data.tasks.push(obj); }
    saveProjectDataLocal(slug, data);
  }
  await fetchProjectData();
}
async function deleteTask(idv){
  const slug = state.currentProject?.slug; if(!slug) return;
  if(state.online){
    const { error } = await state.client.from('tasks').delete().eq('id', idv);
    if(error) return showErr('Erro ao excluir tarefa', error);
  }else{
    const data = loadProjectDataLocal(slug); data.tasks = (data.tasks||[]).filter(t=>t.id!==idv); saveProjectDataLocal(slug, data);
  }
  await fetchProjectData();
}
function getDueBadge(prazo, status){
  if(!prazo || status==='concluida') return null;
  const today=new Date(); today.setHours(0,0,0,0);
  const d=ymdToLocalDate(prazo); const diff=Math.round((d - today)/(1000*60*60*24));
  if(diff<0) return { cls:'due due-overdue', text:`atrasada h√° ${Math.abs(diff)}d` };
  if(diff===0) return { cls:'due due-today', text:'vence hoje' };
  if(diff===1) return { cls:'due due-soon', text:'em 1 dia' };
  if(diff<=7) return { cls:'due due-soon', text:`em ${diff} dias` };
  return null;
}
function getTaskById(taskId){ return state.tasks.find(x=>x.id===taskId); }

async function saveTaskTimeline(task){
  const slug = state.currentProject?.slug; if(!slug) return;
  if(!state.online){
    const data = loadProjectDataLocal(slug);
    const idx=data.tasks.findIndex(t=>t.id===task.id);
    if(idx>=0){ data.tasks[idx].timeline = task.timeline||[]; data.tasks[idx].updated_at=new Date().toISOString(); saveProjectDataLocal(slug, data); }
  }
  if(state.online){
    const payloadUpdate = { timeline: task.timeline || [], updated_at: new Date().toISOString() };
    const { error } = await state.client.from('tasks').update(payloadUpdate).eq('id', task.id);
    if(error){ console.warn('Falha ao salvar timeline online:', error); showErr('Erro ao atualizar timeline', error); }
  }
  renderTimelineModal(); renderTasks();
}
function openTimelineModal(taskId){ state.viewingTaskTimelineId = taskId; state.editingTimelineEntryId = null; renderTimelineModal(); id('dlgTimeline').showModal(); }
function renderTimelineModal(){
  const task = getTaskById(state.viewingTaskTimelineId); if(!task) return;
  const isAutor = task.autor === state.author || !task.autor;
  id('tlTaskTitle').textContent = 'Timeline / Hist√≥rico';
  id('tlBriefTitulo').textContent = task.titulo || '(sem t√≠tulo)';
  const badgesWrap = id('tlBriefBadges'); badgesWrap.innerHTML = '';
  const stSpan = document.createElement('span'); stSpan.className='tl-brief-chip'; stSpan.textContent = 'Status: ' + (task.status||''); badgesWrap.appendChild(stSpan);
  if(task.prazo){ const prazoSpan=document.createElement('span'); prazoSpan.className='tl-brief-chip'; prazoSpan.textContent='Prazo: '+fmtDate(task.prazo); badgesWrap.appendChild(prazoSpan); }
  if(Array.isArray(task.responsaveis)){ task.responsaveis.forEach(r=>{ const chip=document.createElement('span'); chip.className='tl-brief-chip'; chip.textContent=r; badgesWrap.appendChild(chip); }); }
  const metaWrap = id('tlBriefMeta'); metaWrap.innerHTML = '';
  const partesMeta = []; if(task.autor){ partesMeta.push('Autor: '+task.autor); }
  if(task.created_at){ partesMeta.push('Criada: '+fmtDateTime(task.created_at)); }
  if(task.updated_at){ partesMeta.push('Atualizada: '+fmtDateTime(task.updated_at)); }
  if(!partesMeta.length){ partesMeta.push('Sem metadados'); }
  metaWrap.textContent = partesMeta.join(' ‚Ä¢ ');
  id('tlFormWrap').style.display = isAutor ? '' : 'none';

  const tlList = id('tlList'); tlList.innerHTML='';
  const timelineArr = Array.isArray(task.timeline) ? [...task.timeline] : [];
  timelineArr.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
  if(!timelineArr.length){ tlList.innerHTML = `<div style="font-size:13px;color:#6b7280;padding:8px 0 0 0;">Sem registros na timeline.</div>`; return; }
  timelineArr.forEach(entry=>{
    const item = document.createElement('div'); item.className='tl-item';
    const dot = document.createElement('div'); dot.className = 'tl-item-dot ' + (entry.status==='concluido'?'dot-concluido':entry.status==='andamento'?'dot-andamento':'dot-parado'); item.appendChild(dot);

    const topLine=document.createElement('div'); topLine.className='tl-top-line';
    const leftBlock=document.createElement('div'); leftBlock.className='tl-left-block';
    const titleEl=document.createElement('div'); titleEl.className='tl-titulo'; titleEl.textContent=entry.titulo||'(sem t√≠tulo)';
    const line2=document.createElement('div'); line2.className='tl-line2';
    const pill=document.createElement('span'); pill.className = entry.status==='concluido'?'tl-pill tl-pill-concluido':entry.status==='andamento'?'tl-pill tl-pill-andamento':'tl-pill tl-pill-parado';
    pill.textContent= entry.status==='concluido'?'Conclu√≠do':entry.status==='andamento'?'Em andamento':'Parado';
    const tsLabel = document.createElement('span'); tsLabel.textContent = entry.created_at ? fmtDateTime(entry.created_at) : '(sem data)';
    line2.append(pill,tsLabel); leftBlock.append(titleEl,line2);

    const actions=document.createElement('div'); actions.className='tl-actions';
    const canEdit = isAutor;
    if(canEdit){
      const bEdit = document.createElement('button'); bEdit.className='btn small'; bEdit.textContent='Editar';
      bEdit.onclick=()=>{ openTimelineEditor(entry.id); };
      const bDel = document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir';
      bDel.onclick=async ()=>{ const tTask=getTaskById(state.viewingTaskTimelineId); if(!tTask) return; const arr=Array.isArray(tTask.timeline)?tTask.timeline:[]; tTask.timeline = arr.filter(e=>e.id!==entry.id); await saveTaskTimeline(tTask); };
      actions.append(bEdit,bDel);
    }
    topLine.append(leftBlock, actions);
    const desc=document.createElement('div'); desc.className='tl-desc'; desc.textContent=entry.descricao||'';
    item.append(topLine, desc);
    id('tlList').append(item);
  });
}
async function addTimelineEntry(){
  const task = getTaskById(state.viewingTaskTimelineId); if(!task) return;
  if(task.autor && task.autor !== state.author){ return showErr('Sem permiss√£o','Somente o autor da tarefa pode registrar na timeline.'); }
  const titulo = (id('tlNovoTitulo').value||'').trim() || '(sem t√≠tulo)';
  const descricao = (id('tlNovoDesc').value||'').trim() || '';
  const status = id('tlNovoStatus').value || 'parado';
  const entry = { id: crypto.randomUUID(), titulo, descricao, status, created_at: new Date().toISOString() };
  const arr = Array.isArray(task.timeline)?task.timeline:[]; arr.push(entry); task.timeline = arr;
  id('tlNovoTitulo').value=''; id('tlNovoDesc').value=''; id('tlNovoStatus').value='parado';
  await saveTaskTimeline(task);
}
function makeTaskCard(t){
  const card=document.createElement('div'); card.className='card'; card.classList.add('is-'+t.status);
  card.draggable=true; card.dataset.id=t.id;
  card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', t.id); });
  card.addEventListener('click', ()=>{ openTimelineModal(t.id); });

  const title=document.createElement('div'); title.className='title'; title.textContent=t.titulo||'(sem t√≠tulo)';
  const badges=document.createElement('div'); badges.className='badges';
  const stBadge=document.createElement('span'); stBadge.className='badge status-'+t.status; stBadge.textContent=t.status.replace('_',' ');
  const prazo=document.createElement('span'); prazo.className='badge'; prazo.textContent=t.prazo ? 'Prazo: '+fmtDate(t.prazo) : 'Sem prazo';
  badges.append(stBadge,prazo);
  const due=getDueBadge(t.prazo, t.status); if(due){ const b=document.createElement('span'); b.className='badge '+due.cls; b.textContent=due.text.toUpperCase(); badges.append(b); }

  const stRow=document.createElement('div'); stRow.className='row';
  const stLabel=document.createElement('span'); stLabel.className='muted'; stLabel.style.fontSize='12px'; stLabel.textContent='Status:';
  const stSel=document.createElement('select'); stSel.className='status-inline';
  stSel.innerHTML=`<option value="a_fazer">a fazer</option><option value="em_andamento">em andamento</option><option value="concluida">conclu√≠da</option>`;
  stSel.value=t.status; stSel.addEventListener('click', ev=>ev.stopPropagation());
  stSel.onchange=async e=>{ e.stopPropagation(); await upsertTask({ id:t.id, status:e.target.value }); if(id('chkUpdateLink').checked) updateShareLink(); };
  stRow.append(stLabel, stSel);

  const meta=document.createElement('div'); meta.className='muted'; meta.style.fontSize='12px'; meta.textContent='Criada em: ' + (t.created_at ? fmtDateTime(t.created_at) : '‚Äî');
  const tags=document.createElement('div'); tags.className='tags'; (t.responsaveis||[]).forEach(p=>{ const el=document.createElement('span'); el.className='tag'; el.textContent=p; tags.append(el); });
  const actions=document.createElement('div'); actions.className='actions';
  const bEdit=document.createElement('button'); bEdit.className='btn small'; bEdit.textContent='Editar'; bEdit.onclick=(ev)=>{ ev.stopPropagation(); openTaskModal(t); };
  const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir'; bDel.onclick=(ev)=>{ ev.stopPropagation(); deleteTask(t.id); };
  actions.append(bEdit,bDel);

  card.append(title);
  if(t.descricao){ const d=document.createElement('div'); d.className='muted'; d.textContent=t.descricao; card.append(d); }
  card.append(badges, stRow, meta, tags, actions);
  return card;
}
function renderTasks(){
  const cols={ atrasadas:id('col-atrasadas'), a_fazer:id('col-a_fazer'), em_andamento:id('col-em_andamento'), concluida:id('col-concluida') };
  Object.values(cols).forEach(el=>el.innerHTML='');
  const fSt=id('fStatus').value, fResp=id('fResp').value, fPrazo=id('fPrazo').value;

  const today=new Date(); today.setHours(0,0,0,0);
  const endWeek=new Date(today); endWeek.setDate(today.getDate() + (7 - today.getDay())); endWeek.setHours(23,59,59,999);

  let list=[...state.tasks];
  const scope = state.subScope;
  const prazoToLocal=t=> t.prazo ? ymdToLocalDate(t.prazo) : null;
  const isOverdue=t=>{ const p=prazoToLocal(t); return p && p<today && t.status!=='concluida'; };

  if(scope==='atrasadas') list=list.filter(isOverdue);
  if(scope==='a_fazer') list=list.filter(t=>t.status==='a_fazer' && !isOverdue(t));
  if(scope==='em_andamento') list=list.filter(t=>t.status==='em_andamento' && !isOverdue(t));
  if(scope==='concluida') list=list.filter(t=>t.status==='concluida');
  if(fSt!=='todos') list=list.filter(t=>t.status===fSt);
  if(fResp!=='todos') list=list.filter(t=>(t.responsaveis||[]).includes(fResp));

  if(state.filterDate){ list=list.filter(t=>t.prazo===state.filterDate); }
  else{
    if(fPrazo==='hoje'){ list=list.filter(t=>{ const p=prazoToLocal(t); return p && p.getTime()===today.getTime(); }); }
    if(fPrazo==='semana'){ list=list.filter(t=>{ const p=prazoToLocal(t); return p && p>=today && p<=endWeek; }); }
    if(fPrazo==='atrasadas'){ list=list.filter(t=> isOverdue(t)); }
  }

  const overdue=list.filter(isOverdue);
  const notOverdue=list.filter(t=>!isOverdue(t));
  overdue.forEach(t=> cols.atrasadas.append(makeTaskCard(t)));
  const counts={a_fazer:0,em_andamento:0,concluida:0};
  notOverdue.forEach(t=>counts[t.status]=(counts[t.status]||0)+1);
  notOverdue.forEach(t=> cols[t.status].append(makeTaskCard(t)));
  qsa('.col').forEach(col=>{ const st=col.dataset.status, badge=col.querySelector('header .badge'); if(!badge) return; badge.textContent = (st==='atrasadas') ? overdue.length : (counts[st]||0); });
  updateFilters();
}
function renderNotes(){
  const wrap=id('notes'); if(!wrap) return; wrap.innerHTML='';
  const list = [...(state.notes||[])].sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
  if(!list.length){ wrap.innerHTML = `<div class="muted" style="font-size:13px;padding:8px 0;">Sem anota√ß√µes.</div>`; return; }
  list.forEach(n=>{
    const isEditing = state.editingNoteId === n.id;
    const canEdit = n.autor === state.author || !n.autor;
    const dv=document.createElement('div'); dv.className='note';
    if(isEditing){
      dv.innerHTML = `
        <div class="note-edit">
          <textarea class="note-edit-text">${n.texto||''}</textarea>
          <div class="actions" style="justify-content:flex-end">
            <button class="btn small note-cancel">Cancelar</button>
            <button class="btn small primary note-save">Salvar</button>
          </div>
        </div>`;
      dv.querySelector('.note-save').onclick = async () => {
        const texto = (dv.querySelector('.note-edit-text').value||'').trim();
        if(texto) await upsertNote({ id: n.id, texto });
        state.editingNoteId = null; renderNotes();
      };
      dv.querySelector('.note-cancel').onclick = () => { state.editingNoteId = null; renderNotes(); };
    }else{
      const txt=document.createElement('div'); txt.textContent=n.texto||'(vazio)';
      const meta=document.createElement('div'); meta.className='note-meta';
      meta.innerHTML = `<span>${n.autor||'‚Äî'}</span> ‚Ä¢ <span>${fmtDateTime(n.created_at)}</span>`;
      const acts=document.createElement('div'); acts.className='actions';
      if(canEdit){
        const bEdit=document.createElement('button'); bEdit.className='btn small'; bEdit.textContent='Editar';
        bEdit.onclick=()=>{ state.editingNoteId = n.id; renderNotes(); };
        const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir';
        bDel.onclick=()=>deleteNote(n.id);
        acts.append(bEdit,bDel);
      }
      dv.append(txt,meta,acts);
    }
    wrap.append(dv);
  });
}
async function upsertNote(obj){
  const slug = state.currentProject?.slug; if(!slug) return;
  if(state.online){
    if(obj.id){
      const { error } = await state.client.from('notes').update({ texto:obj.texto, updated_at:new Date().toISOString() }).eq('id', obj.id);
      if(error) return showErr('Erro ao salvar anota√ß√£o', error);
    }else{
      const { error } = await state.client.from('notes').insert({ ...obj, board_slug: slug });
      if(error) return showErr('Erro ao criar anota√ß√£o', error);
    }
  }else{
    const data = loadProjectDataLocal(slug);
    if(!obj.id){ obj.id=crypto.randomUUID(); obj.created_at=new Date().toISOString(); }
    const idx=data.notes.findIndex(x=>x.id===obj.id);
    if(idx>=0){ data.notes[idx]={...data.notes[idx],...obj}; } else { data.notes.unshift(obj); }
    saveProjectDataLocal(slug, data);
  }
  await fetchProjectData();
}
async function deleteNote(idv){
  const slug = state.currentProject?.slug; if(!slug) return;
  if(state.online){
    const { error } = await state.client.from('notes').delete().eq('id', idv);
    if(error) return showErr('Erro ao excluir anota√ß√£o', error);
  }else{
    const data = loadProjectDataLocal(slug); data.notes = (data.notes||[]).filter(n=>n.id!==idv); saveProjectDataLocal(slug, data);
  }
  await fetchProjectData();
}
async function saveNoteFromPanel(){
  const autor = id('noteAuthor').value;
  const texto = (id('noteText').value||'').trim();
  if(!texto || !autor) return showErr('Formul√°rio incompleto', 'Preencha autor e texto da anota√ß√£o.');
  await upsertNote({ autor, texto });
  id('noteText').value = '';
}

/* =================== UI Geral =================== */
function renderProjectBoard(){
  renderTasks(); renderNotes();
  const fResp = id('fResp'); fResp.innerHTML = '<option value="todos">Todos resp.</option>';
  const resps = unique(state.tasks.flatMap(t=>(t.responsaveis||[])));
  resps.sort(); resps.forEach(r=> fResp.innerHTML += `<option value="${r}">${r}</option>`);
  updateShareLink();
}
function updateFilters(){
  const fSt=id('fStatus').value, fResp=id('fResp').value, fPrazo=id('fPrazo').value;
  const hasFilter = fSt!=='todos' || fResp!=='todos' || fPrazo!=='todos' || state.filterDate;
  id('btnLimparFiltros').style.display = hasFilter ? '' : 'none';
}
function clearFilters(){ id('fStatus').value='todos'; id('fResp').value='todos'; id('fPrazo').value='todos'; state.filterDate=null; renderCalendar(); renderTasks(); }
function openTaskModal(task=null){
  state.editingTaskId = task?.id || null;
  id('dlgTask').querySelector('.modal-head').textContent = task ? 'Editar tarefa' : 'Nova tarefa';
  id('tTitulo').value = task?.titulo || '';
  id('tDesc').value = task?.descricao || '';
  id('tPrazo').value = task?.prazo || '';
  const sel = id('tResps'); sel.innerHTML = '';
  FIXED_RESPONSAVEIS.forEach(r=>{
    const opt = document.createElement('option');
    opt.value = r; opt.textContent = r;
    if(task?.responsaveis?.includes(r)) opt.selected = true;
    sel.appendChild(opt);
  });
  id('dlgTask').showModal();
}
async function saveTaskFromModal(){
  const titulo = (id('tTitulo').value||'').trim();
  if(!titulo) return showErr('T√≠tulo √© obrigat√≥rio', 'Informe um t√≠tulo para a tarefa.');
  const obj = {
    titulo,
    descricao: (id('tDesc').value||'').trim() || null,
    prazo: id('tPrazo').value || null,
    responsaveis: qsa('#tResps option:checked').map(o=>o.value),
    autor: state.author,
  };
  if(state.editingTaskId){ await upsertTask({ id: state.editingTaskId, ...obj }); }
  else { await upsertTask({ status:'a_fazer', ...obj }); }
  id('dlgTask').close();
}
function closeSidebar(){ id('sidebar').classList.remove('open'); }
function updateShareLink(){
  if(!state.currentProject) return;
  const url = new URL(location.href);
  const p = { board:state.currentProject.slug, tasks:state.tasks, notes:state.notes, meetings:state.meetings, title:state.currentProject.title };
  url.pathname = '/share.html';
  url.search = '';
  url.hash = '#' + btoa(JSON.stringify(p));
  id('shareLink').value = url.toString();
}

/* =================== Calend√°rio =================== */
function renderCalendar(){
  const month = state.calMonth || new Date();
  state.calMonth = month;
  id('calMonthLabel').textContent = month.toLocaleDateString([],{month:'long', year:'numeric'});
  const grid = id('calDays'); grid.innerHTML = '';
  ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'].forEach(d=> grid.innerHTML += `<div class="cal-day-head">${d}</div>`);

  const d=new Date(month); d.setDate(1); d.setDate(1 - d.getDay());
  const today=new Date(); today.setHours(0,0,0,0);
  const sel=state.filterDate ? ymdToLocalDate(state.filterDate) : null;

  const counts = {};
  state.tasks.forEach(t=>{
    if(!t.prazo) return;
    counts[t.prazo] = (counts[t.prazo]||0)+1;
  });

  for(let i=0; i<42; i++){
    const day=document.createElement('div'); day.className='cal-day';
    if(d.getMonth() !== month.getMonth()) day.classList.add('other-month');
    if(d.getTime() === today.getTime()) day.classList.add('is-today');
    const ymd = toYMD(d);
    if(sel && sel.getTime() === d.getTime()) day.classList.add('is-selected');

    const dayNum = document.createElement('div'); dayNum.textContent = d.getDate();
    day.appendChild(dayNum);
    if(counts[ymd]){
      const countBadge = document.createElement('div'); countBadge.className='count';
      countBadge.textContent = counts[ymd];
      day.appendChild(countBadge);
    }
    day.onclick = () => { state.filterDate = state.filterDate === ymd ? null : ymd; renderCalendar(); renderTasks(); };
    grid.appendChild(day);
    d.setDate(d.getDate()+1);
  }
}

/* =================== Inicializa√ß√£o =================== */
async function startApp(){
  await maybeInitSupabase();
  await fetchProjectsAndStats();

  const urlParams = new URLSearchParams(window.location.search);
  const boardSlug = urlParams.get('board');
  if(boardSlug) selectProject(boardSlug);
  else showProjectsHome();

  id('btnMenu').onclick=()=>id('sidebar').classList.toggle('open');
  id('btnToggleTheme').onclick=()=>{
    state.theme = state.theme==='light'?'dark':'light';
    localStorage.setItem('theme', state.theme);
    applyTheme();
  };
  id('btnNovoProjeto').onclick=()=>openProjectModal();
  id('pSalvar').onclick=()=>saveProjectFromModal();
  id('pCancelar').onclick=()=>id('dlgProject').close();
  id('btnNovaTarefa').onclick=()=>openTaskModal();
  id('tSalvar').onclick=()=>saveTaskFromModal();
  id('tCancelar').onclick=()=>id('dlgTask').close();
  id('btnReunioes').onclick=()=>openMeetings();
  id('mFechar').onclick=()=>id('dlgMeetings').close();
  id('mSalvar').onclick=()=>saveMeetingFromModal();
  id('mCancelar').onclick=()=>{ id('mTitulo').value=''; id('mDesc').value=''; id('mData').value=''; id('mHora').value=''; };
  id('tlFechar').onclick=()=>id('dlgTimeline').close();
  id('tlNovoSalvar').onclick=()=>addTimelineEntry();
  id('btnLimparFiltros').onclick=()=>clearFilters();
  id('btnDashboard').onclick=()=>openDashboard();
  id('dbFechar').onclick=()=>id('dlgDash').close();
  id('projSearch').oninput=()=>renderSidebarProjects();
  id('btnSearchProj').onclick=()=>renderSidebarProjects();
  id('chkShowArchived').onchange=()=>renderSidebarProjects();
  qsa('.subtab').forEach(el=>el.onclick=()=>{
    qsa('.subtab').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    state.subScope = el.dataset.scope;
    renderTasks();
  });
  qsa('#fStatus, #fResp, #fPrazo').forEach(el=>el.onchange=()=>renderTasks());
  qsa('.dropzone').forEach(el=>{
    el.ondragover = e => e.preventDefault();
    el.ondrop = async e => {
      e.preventDefault();
      const taskId = e.dataTransfer.getData('text/plain');
      const newStatus = el.closest('.col').dataset.status;
      if(newStatus==='atrasadas') return; // n√£o pode arrastar pra ‚Äòatrasadas‚Äô
      await upsertTask({ id:taskId, status:newStatus });
    };
  });
  id('calPrev').onclick=()=>{ state.calMonth.setMonth(state.calMonth.getMonth()-1); renderCalendar(); };
  id('calNext').onclick=()=>{ state.calMonth.setMonth(state.calMonth.getMonth()+1); renderCalendar(); };
  id('btnSalvarNota').onclick=()=>saveNoteFromPanel();
  renderCalendar();
}

/* =================== Dashboard =================== */
let charts = {};
function destroyCharts(){ Object.values(charts).forEach(c=>c.destroy()); charts={}; }
function openDashboard(){
  destroyCharts();
  const tasksDone = state.tasks.filter(t=>t.status==='concluida');
  id('dbTotalConcluidas').textContent = `Conclu√≠das: ${tasksDone.length}`;

  const onTime = tasksDone.filter(t => !t.prazo || !t.updated_at || new Date(t.updated_at) <= ymdToLocalDate(t.prazo));
  const pctOnTime = tasksDone.length ? Math.round((onTime.length / tasksDone.length) * 100) : 0;
  id('dbPctNoPrazo').textContent = `% no prazo: ${pctOnTime}%`;

  const leadTimes = tasksDone.map(t => (new Date(t.updated_at) - new Date(t.created_at))/(1000*60*60*24)).filter(d=>d>=0);
  const avgLeadTime = leadTimes.length ? (leadTimes.reduce((a,b)=>a+b,0) / leadTimes.length).toFixed(1) : '‚Äî';
  id('dbLeadTime').textContent = `Lead time m√©d.: ${avgLeadTime}d`;

  const last30days = {};
  for(let i=29; i>=0; i--){ const d=new Date(); d.setDate(d.getDate()-i); last30days[toYMD(d)]=0; }
  tasksDone.forEach(t=>{
    const ymd = toYMD(new Date(t.updated_at));
    if(last30days[ymd]!==undefined) last30days[ymd]++;
  });
  charts.c1 = new Chart(id('dbLast30'), {
    type:'bar', data:{ labels:Object.keys(last30days), datasets:[{label:'Entregas',data:Object.values(last30days),backgroundColor: 'rgba(24,91,36,.7)'}] },
    options:{ scales:{y:{beginAtZero:true}}, plugins:{legend:{display:false}} }
  });

  charts.c2 = new Chart(id('dbPct'), {
    type:'doughnut', data:{ labels:['No prazo','Com atraso'], datasets:[{data:[pctOnTime, 100-pctOnTime], backgroundColor:['#38c172','#ef6b6b']}] },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
  });

  id('dlgDash').showModal();
}

</script>
</body>
</html>
