<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eco Smart Group ‚Äî Gestor de Tarefas</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b0d10; --panel:#0f1317; --card:#141922; --muted:#9aa4b2; --txt:#dde6ee;
      --brand:#185b24; --brand-2:#0f4319; --ok:#38c172; --warn:#ffcc00; --danger:#ef6b6b;
      --border:#1f2430; --shadow:0 10px 24px rgba(0,0,0,.35); --ring:0 0 0 3px rgba(24,91,36,.35);
    }
    .light{
      --bg:#f5f8fb; --panel:#fff; --card:#fff; --muted:#5c6675; --txt:#101317;
      --brand:#1b6a2a; --brand-2:#145021; --ok:#2f855a; --warn:#b7791f; --danger:#c53030;
      --border:#e6ebf2; --shadow:0 10px 24px rgba(16,19,23,.08); --ring:0 0 0 3px rgba(27,106,42,.18);
    }

    /* ===== Tokens por status ===== */
    :root{
      --st-todo-bg:rgba(251,191,36,.14); --st-todo-bd:rgba(251,191,36,.40); --st-todo-tx:#fde68a;
      --st-prog-bg:rgba(59,130,246,.14); --st-prog-bd:rgba(59,130,246,.40); --st-prog-tx:#bfdbfe;
      --st-done-bg:rgba(16,185,129,.14); --st-done-bd:rgba(16,185,129,.35); --st-done-tx:#a7f3d0;
      --st-late-bg:rgba(239,68,68,.16); --st-late-bd:rgba(239,68,68,.45); --st-late-tx:#fecaca;
    }
    .light{
      --st-todo-bg:#fffbeb; --st-todo-bd:#fde68a; --st-todo-tx:#92400e;
      --st-prog-bg:#eff6ff; --st-prog-bd:#bfdbfe; --st-prog-tx:#1d4ed8;
      --st-done-bg:#ecfdf5; --st-done-bd:#a7f3d0; --st-done-tx:#065f46;
      --st-late-bg:#fef2f2; --st-late-bd:#fecaca; --st-late-tx:#991b1b;
    }

    html,body{height:100%}
    body{
      margin:0;
      font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--txt)
    }

    /* ===== Layout com sidebar ===== */
    .app-shell{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:100vh;
    }
    .sidebar{
      background:var(--panel); border-right:1px solid var(--border); padding:14px; position:sticky; top:0; height:100vh; box-sizing:border-box;
      display:flex; flex-direction:column; gap:12px;
    }
    .brand{font-weight:800;font-size:18px;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .sidebar .btn{ width:100%; }
    .proj-search{ display:flex; gap:8px; }
    .proj-search input{ flex:1; }

    .proj-list{ display:grid; gap:6px; overflow:auto; padding-right:4px; }
    .proj-item{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px; cursor:pointer;
    }
    .proj-item:hover{ box-shadow:var(--shadow); }
    .proj-item .title{ font-weight:600; }
    .proj-actions{ display:flex; gap:6px; }
    .proj-actions .btn.small{ padding:6px 8px; }

    .main{
      display:flex; flex-direction:column; gap:0;
    }

    header.main-head{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      padding:16px 18px; border-bottom:1px solid var(--border); background:var(--panel); position:sticky; top:0; z-index:10;
    }
    .crumbs{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .crumbs .sep{ opacity:.5; }
    .btn,button{
      cursor:pointer;
      border:1px solid var(--border);background:var(--panel);color:var(--txt);
      padding:9px 12px;border-radius:10px;box-shadow:var(--shadow);
      transition:transform .05s,box-shadow .2s,background .2s
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;border:none
    }
    .btn.primary:hover{filter:saturate(1.1);box-shadow:0 10px 22px rgba(24,91,36,.35)}
    .btn.small{padding:6px 9px}
    .spacer{ flex:1; }

    /* Toolbar dentro do projeto */
    .toolbar{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;
      padding:12px 18px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);
      backdrop-filter:saturate(160%) blur(6px);
      position:sticky; top:60px; z-index:9;
    }
    @media (max-width:980px){
      .app-shell{ grid-template-columns: 1fr; }
      .sidebar{ position:fixed; z-index:30; left:0; top:0; bottom:0; width:min(86vw, 360px); transform:translateX(-100%); transition:transform .2s; }
      .sidebar.open{ transform:none; }
      header.main-head{ position:sticky; top:0; }
    }

    .pill{
      background:rgba(255,255,255,.05);color:var(--txt);
      padding:6px 10px;border:1px solid var(--border);border-radius:10px
    }
    select,input[type="date"],input[type="text"],input[type="time"]{
      background:var(--panel);color:var(--txt);
      border:1px solid var(--border);border-radius:10px;padding:8px 10px
    }

    /* Sub-linhas (abas r√°pidas) de status */
    .subtabs{ display:flex; gap:8px; flex-wrap:wrap; padding:10px 18px; border-bottom:1px solid var(--border); background:var(--panel); position:sticky; top:114px; z-index:8; }
    .subtab{
      border:1px solid var(--border); background:var(--card); color:var(--txt); padding:6px 10px; border-radius:999px; font-size:13px; cursor:pointer;
    }
    .subtab.active{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; border:none; }

    .wrap{max-width:1400px;margin:0 auto;padding:0 18px 36px}

    .grid{
      display:grid;grid-template-columns:minmax(0,1.8fr) minmax(320px,1fr);
      gap:28px;margin-top:18px;align-items:start
    }
    .panel{
      background:var(--panel);border:1px solid var(--border);
      border-radius:14px;box-shadow:var(--shadow);overflow:hidden
    }
    .panel h3{margin:18px;font-size:16px}

    .kanban{
      display:grid;grid-template-columns:repeat(auto-fit, minmax(280px,1fr));
      gap:24px;padding:24px
    }
    .col{
      background:var(--card);border:1px solid var(--border);
      border-radius:12px;min-height:260px;display:flex;flex-direction:column
    }
    .col header{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px;border-bottom:1px solid var(--border)
    }
    .dropzone{flex:1;padding:14px;min-height:160px}
    .dropzone.readonly{opacity:.95}

    .card{
      background:var(--panel);border:1px solid var(--border);border-radius:12px;
      padding:14px;margin:12px 6px;box-shadow:var(--shadow);
      transition:box-shadow .2s,transform .05s;
      cursor:pointer
    }
    .card:hover{box-shadow:0 10px 22px rgba(0,0,0,.25)}
    .title{font-weight:700}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{
      background:rgba(255,255,255,.06);border:1px solid var(--border);
      padding:4px 8px;border-radius:999px;font-size:12px
    }
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .actions{display:flex;gap:8px;margin-top:10px}
    .actions .btn.small{cursor:pointer}

    .status-inline{font-size:12px;padding:4px 6px;border-radius:8px}

    .note{
      background:var(--card);border:1px solid var(--border);
      border-radius:12px;padding:12px;margin:10px 14px
    }
    .note-meta{
      display:flex;gap:8px;flex-wrap:wrap;
      color:var(--muted);font-size:12px;margin-top:6px
    }
    .note-edit{display:grid;gap:8px}
    textarea{
      width:100%;min-height:64px;
      background:var(--panel);color:var(--txt);
      border:1px solid var(--border);border-radius:10px;padding:8px 10px
    }

    .badges{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .badge{
      font-size:12px;padding:2px 8px;border-radius:999px;
      border:1px solid var(--border);background:var(--panel)
    }
    .badge.status-a_fazer{
      background:var(--st-todo-bg);color:var(--st-todo-tx);border-color:var(--st-todo-bd)
    }
    .badge.status-em_andamento{
      background:var(--st-prog-bg);color:var(--st-prog-tx);border-color:var(--st-prog-bd)
    }
    .badge.status-concluida{
      background:var(--st-done-bg);color:var(--st-done-tx);border-color:var(--st-done-bd)
    }

    .col[data-status="atrasadas"] .card{
      background:var(--st-late-bg);border-color:var(--st-late-bd)
    }
    .col[data-status="atrasadas"] .badge{
      background:transparent;color:var(--st-late-tx);border-color:var(--st-late-bd)
    }

    .card.is-a_fazer{box-shadow:inset 3px 0 0 0 var(--st-todo-bd)}
    .card.is-em_andamento{box-shadow:inset 3px 0 0 0 var(--st-prog-bd)}
    .card.is-concluida{box-shadow:inset 3px 0 0 0 var(--st-done-bd)}

    .col:not([data-status="atrasadas"]) .card.is-a_fazer{
      background:var(--st-todo-bg);border-color:var(--st-todo-bd)
    }
    .col:not([data-status="atrasadas"]) .card.is-em_andamento{
      background:var(--st-prog-bg);border-color:var(--st-prog-bd)
    }
    .col:not([data-status="atrasadas"]) .card.is-concluida{
      background:var(--st-done-bg);border-color:var(--st-done-bd)
    }

    .foot{
      margin-top:28px;display:flex;
      justify-content:space-between;align-items:center;color:var(--muted)
    }

    .assignees{display:flex;gap:8px;flex-wrap:wrap}
    .assignees input[type="checkbox"]{display:none}
    .assignees label{
      user-select:none;cursor:pointer;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);background:var(--panel);
      transition:background .2s,color .2s,box-shadow .2s
    }
    .assignees input[type="checkbox"]:checked + label{
      background:var(--brand);color:#fff;border-color:transparent;box-shadow:var(--ring)
    }

    dialog{ width:min(780px, calc(100% - 32px)); }
    dialog.modal-light{
      background:#ffffff; color:#111827; border:1px solid #e6ebf2;
      border-radius:14px; box-shadow:var(--shadow);
    }
    dialog.modal-light::backdrop{ background:rgba(0,0,0,.45); }
    dialog.modal-light .modal-head{
      padding:14px 16px; border-bottom:1px solid #e6ebf2; font-weight:700; color:#0f172a;
      display:flex; justify-content:space-between; align-items:flex-start; gap:8px; flex-wrap:wrap;
    }
    dialog.modal-light .modal-body{ padding:14px 16px; display:grid; gap:16px; }
    dialog.modal-light .modal-foot{
      padding:14px 16px; border-top:1px solid #e6ebf2; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    dialog.modal-light label{ color:#4b5563; font-size:13px; }
    dialog.modal-light input[type="text"],
    dialog.modal-light input[type="date"],
    dialog.modal-light input[type="time"],
    dialog.modal-light select,
    dialog.modal-light textarea{
      background:#f8fafc; color:#0f172a; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px;
      width:100%; box-sizing:border-box; font-size:13px;
    }
    dialog.modal-light .btn{ background:#f8fafc; color:#0f172a; border:1px solid #e5e7eb; }
    dialog.modal-light .btn.primary{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; border:none; }

    /* ===== Mini-calend√°rio (popover) ===== */
    .cal-pop{ position:fixed; z-index:20; width:280px; max-width:96vw; background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:8px; }
    .cal-pop.hidden{ display:none; }
    .cal{ display:grid; gap:8px; }
    .cal-head{ display:flex; justify-content:space-between; align-items:center; padding:4px 6px; }
    .cal-head .title{ font-weight:700; }
    .cal-head button{ padding:4px 8px; }
    .cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; padding:0 4px 6px; }
    .cal-dow{ text-align:center; font-size:12px; color:var(--muted); }
    .cal-day{ position:relative; text-align:center; padding:8px 0; border:1px solid var(--border); border-radius:8px; cursor:pointer; user-select:none; background:var(--panel); font-size:13px; }
    .cal-day:hover{ box-shadow:0 4px 14px rgba(0,0,0,.18); }
    .cal-day.is-today{ outline:2px solid var(--brand); outline-offset:-2px; }
    .cal-day.is-selected{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; border-color:transparent; }
    .cal-day.has-task::after{ content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:6px; width:6px; height:6px; border-radius:50%; background:var(--warn); }
    #selDiaTag .btn.small{ padding:2px 6px; }

    @media (max-width:420px){
      .cal-pop{
        left:50% !important; transform:translateX(-50%) !important; top:auto !important;
        bottom:calc(env(safe-area-inset-bottom, 0px) + 8px) !important; width:calc(100vw - 16px);
      }
    }

    /* ===== Avisos de vencimento ===== */
    .badge.due{ font-weight:700 }
    .badge.due-today{ background:var(--st-todo-bg); color:var(--st-todo-tx); border-color:var(--st-todo-bd) }
    .badge.due-soon{ background:var(--st-prog-bg); color:var(--st-prog-tx); border-color:var(--st-prog-bd) }
    .badge.due-overdue{ background:var(--st-late-bg); color:var(--st-late-tx); border-color:var(--st-late-bd) }

    /* ===== Reuni√µes ===== */
    .meeting-list{ display:grid; gap:10px; max-height:50vh; overflow:auto; padding-right:2px; }
    .meeting-item{ border:1px solid var(--border); background:var(--panel); border-radius:10px; padding:10px; display:grid; gap:6px; }
    .meeting-top{ display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .meeting-meta{ color:var(--muted); font-size:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .meeting-actions{ display:flex; gap:8px; }
    .pill-inline{ background:rgba(255,255,255,.06); border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:12px; }

    /* ===== TIMELINE ===== */
    .tl-body-grid{ display:grid; grid-template-columns: minmax(0,1fr); gap:16px; }
    .tl-brief-card{ background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:12px 14px; display:grid; gap:8px; }
    .tl-brief-title{ font-weight:600; color:#0f172a; font-size:15px; line-height:1.3; word-break:break-word; }
    .tl-brief-meta{ font-size:12px; color:#4b5563; display:flex; flex-wrap:wrap; gap:10px; line-height:1.4; }
    .tl-brief-badges{ display:flex; flex-wrap:wrap; gap:6px; font-size:12px; }
    .tl-brief-chip{ background:#fff; border:1px solid #d1d5db; border-radius:999px; padding:2px 8px; line-height:1.2; color:#1f2937; font-size:12px; }
    .timeline-form{ display:grid; gap:10px; background:#ffffff; border:1px solid #d1d5db; border-radius:12px; padding:12px 14px; }
    .timeline-form-head{ font-weight:600; color:#0f172a; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
    .tl-edit-row{ display:grid; gap:4px; }
    .tl-edit-row label{ font-size:12px; color:#4b5563; font-weight:500; }
    .tl-edit-row input[type="text"], .tl-edit-row textarea, .tl-edit-row select{
      background:#f9fafb; border:1px solid #d1d5db; border-radius:8px; padding:8px 10px; font-size:13px; color:#111827; width:100%; box-sizing:border-box;
    }
    .tl-save-row{ display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap; }
    .tl-history-head{ font-weight:600; color:#0f172a; font-size:14px; }
    .timeline-entries{ position:relative; max-height:45vh; overflow:auto; padding-left:20px; padding-right:4px; }
    .timeline-entries::before{ content:""; position:absolute; left:6px; top:0; bottom:0; width:2px; background:#e5e7eb; }
    .tl-item{ position:relative; background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; margin-bottom:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.04); display:grid; gap:6px; }
    .tl-item-dot{ position:absolute; left:-14px; top:12px; width:12px; height:12px; border-radius:50%; border:2px solid #fff; box-shadow:0 0 0 2px #e5e7eb; }
    .dot-concluido{ background:var(--ok); } .dot-andamento{ background:var(--warn); } .dot-parado{ background:var(--danger); }
    .tl-top-line{ display:flex; flex-wrap:wrap; justify-content:space-between; gap:8px; align-items:flex-start; }
    .tl-left-block{ display:grid; gap:4px; min-width:0; }
    .tl-titulo{ font-weight:600; color:#0f172a; font-size:14px; line-height:1.3; word-break:break-word; }
    .tl-line2{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:12px; line-height:1.4; color:#6b7280; }
    .tl-pill{ font-size:11px; font-weight:600; padding:2px 6px; border-radius:999px; line-height:1.2; border:1px solid transparent; }
    .tl-pill-concluido{ background:rgba(56,193,114,.14); color:#065f46; border-color:rgba(56,193,114,.4); }
    .tl-pill-andamento{ background:rgba(255,204,0,.14); color:#7a6400; border-color:rgba(255,204,0,.4); }
    .tl-pill-parado{ background:rgba(239,107,107,.16); color:#7a1b1b; border-color:rgba(239,107,107,.45); }
    .tl-desc{ font-size:13px; color:#4b5563; white-space:pre-wrap; word-break:break-word; }
    .tl-actions{ display:flex; flex-wrap:wrap; gap:8px; }
    .tl-actions .btn.small{ padding:4px 8px; font-size:12px; line-height:1.2; background:#f9fafb; border:1px solid #d1d5db; color:#1f2937; box-shadow:none; }
    .tl-edit-block{ display:grid; gap:10px; }
    .tl-edit-buttons{ display:flex; justify-content:flex-end; flex-wrap:wrap; gap:8px; }

    /* ===== Overlay de senha ===== */
    .locked #app-root{ filter: blur(8px) saturate(80%); pointer-events:none; user-select:none; }
    #loginOverlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); z-index:50; backdrop-filter: blur(3px); }
    #loginCard{
      width:min(420px, calc(100% - 32px));
      background:#ffffff; color:#0f172a;
      border:1px solid #e6ebf2; border-radius:14px; box-shadow:var(--shadow);
      padding:18px; display:grid; gap:12px;
    }
    #loginCard .brand{ font-weight:800; font-size:18px; }
    .login-meta{ color:#6b7280; font-size:12px; }
    .login-row{ display:grid; gap:6px; }
    .login-row label{ color:#4b5563; font-size:12px; }
    .login-row input{
      width:100%; background:#f8fafc; color:#0f172a; border:1px solid #e5e7eb;
      border-radius:10px; padding:10px 12px; font-size:14px;
    }
    .login-actions{ display:flex; gap:8px; justify-content:flex-end; align-items:center; }
    .login-btn{ cursor:pointer; padding:10px 14px; border-radius:10px; border:1px solid #e5e7eb; background:#f8fafc; }
    .login-btn.primary{ border:none; background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; }
    .login-err{ color:#b91c1c; font-size:12px; display:none; }
    .shake{ animation:shake .18s linear 2; }
    @keyframes shake{ 0%{transform:translateX(0)} 25%{transform:translateX(-4px)} 50%{transform:translateX(4px)} 75%{transform:translateX(-2px)} 100%{transform:translateX(0)} }
  </style>
</head>
<body>
  <!-- OVERLAY DE LOGIN -->
  <div id="loginOverlay">
    <div id="loginCard">
      <div class="brand">Eco Smart Group ‚Äî Gestor de Tarefas</div>
      <div class="login-meta">Usu√°rio padr√£o: <strong>Eco Smart Group</strong></div>

      <div class="login-row">
        <label>Senha</label>
        <input id="pwdInput" type="password" placeholder="Digite a senha" autocomplete="current-password" />
        <div id="loginErr" class="login-err">Senha incorreta. Tente novamente.</div>
      </div>

      <div class="login-actions">
        <button id="pwdShow" class="login-btn" type="button">üëÅ Mostrar</button>
        <span style="flex:1"></span>
        <button id="pwdEnter" class="login-btn primary" type="button">Entrar</button>
      </div>
    </div>
  </div>

  <div id="app-root" class="app-shell">
    <!-- ===== SIDEBAR (PROJETOS) ===== -->
    <aside id="sidebar" class="sidebar">
      <div>
        <div class="brand">Eco Smart Group</div>
        <div class="muted" id="modeLabel">Modo local ‚Ä¢ Projetos</div>
      </div>

      <div class="proj-search">
        <input id="projSearch" type="text" placeholder="Buscar projeto‚Ä¶" />
        <button id="btnSidebarToggle" class="btn" type="button" style="display:none">‚ò∞</button>
      </div>

      <button class="btn primary" id="btnNovoProjeto">+ Novo projeto</button>

      <div class="muted" style="font-size:12px">Projetos</div>
      <div id="projList" class="proj-list"></div>

      <div style="margin-top:auto">
        <div class="muted" id="onlineState">Offline (LocalStorage)</div>
        <button class="btn" id="btnTheme">Alternar tema</button>
      </div>
    </aside>

    <!-- ===== MAIN ===== -->
    <main class="main">
      <header class="main-head">
        <button class="btn" id="btnOpenSidebar" title="Projetos">‚ò∞</button>
        <div class="crumbs">
          <span class="muted">Projetos</span>
          <span class="sep">/</span>
          <span id="crumbProject" class="muted">‚Äî</span>
        </div>
        <span class="spacer"></span>
        <button class="btn" id="btnVoltarProjetos" title="Voltar aos projetos">‚Üê Projetos</button>
      </header>

      <!-- Barra do projeto selecionado -->
      <div class="toolbar" id="projectToolbar" style="display:none">
        <button class="btn primary" id="btnNova">+ Nova tarefa</button>

        <div class="pill">Status:
          <select id="fStatus">
            <option value="todos">todos</option>
            <option value="a_fazer">a fazer</option>
            <option value="em_andamento">em andamento</option>
            <option value="concluida">conclu√≠da</option>
          </select>
        </div>
        <div class="pill">Respons√°vel:
          <select id="fResp"><option value="todos">todos</option></select>
        </div>
        <div class="pill">Prazo:
          <select id="fPrazo">
            <option value="todos">todos</option>
            <option value="hoje">hoje</option>
            <option value="semana">esta semana</option>
            <option value="atrasadas">atrasadas</option>
          </select>
        </div>

        <!-- Calend√°rio + chip de dia -->
        <button class="btn small" id="btnCal" title="Abrir calend√°rio">üìÖ</button>
        <span id="selDiaTag" class="pill" style="display:none">dia: <strong id="selDiaText"></strong> <button class="btn small" id="btnClearDia" title="Limpar">√ó</button></span>

        <div id="calPopover" class="cal-pop hidden" role="dialog" aria-label="Calend√°rio"></div>

        <span class="spacer"></span>
        <button class="btn" id="btnMeetings" title="Reuni√µes">üóì Reuni√µes</button>
        <button class="btn" id="btnExport">Exportar CSV</button>
        <button class="btn" id="btnLink">Gerar link com dados</button>
        <label class="pill"><input type="checkbox" id="chkUpdateLink" checked> atualizar link ao editar</label>
      </div>

      <!-- Abas r√°pidas (sub-linhas) de status -->
      <div id="subtabs" class="subtabs" style="display:none">
        <button class="subtab active" data-scope="todas">Todas</button>
        <button class="subtab" data-scope="atrasadas">Atrasadas</button>
        <button class="subtab" data-scope="a_fazer">A fazer</button>
        <button class="subtab" data-scope="em_andamento">Em andamento</button>
        <button class="subtab" data-scope="concluida">Conclu√≠das</button>
      </div>

      <!-- Conte√∫dos -->
      <div class="wrap">
        <!-- Tela de Projetos -->
        <section id="viewProjects" class="panel" style="display:none">
          <h3>Projetos</h3>
          <div id="projectsGrid" class="kanban" style="grid-template-columns:repeat(auto-fit, minmax(240px,1fr));"></div>
        </section>

        <!-- Tela do Projeto (Kanban + Notas) -->
        <section id="viewProjectBoard" style="display:none">
          <section class="panel">
            <h3 id="projBoardTitle">Tarefas</h3>
            <div class="kanban">
              <div class="col" data-status="atrasadas">
                <header><div class="row"><strong>Atrasadas</strong><span class="badge">0</span></div></header>
                <div class="dropzone readonly" id="col-atrasadas"></div>
              </div>

              <div class="col" data-status="a_fazer">
                <header>
                  <div class="row"><strong>A fazer</strong><span class="badge">0</span></div>
                  <button class="btn small" data-add="a_fazer">+ adicionar</button>
                </header>
                <div class="dropzone" id="col-a_fazer" ondragover="event.preventDefault()"></div>
              </div>
              <div class="col" data-status="em_andamento">
                <header>
                  <div class="row"><strong>Em andamento</strong><span class="badge">0</span></div>
                  <button class="btn small" data-add="em_andamento">+ adicionar</button>
                </header>
                <div class="dropzone" id="col-em_andamento" ondragover="event.preventDefault()"></div>
              </div>
              <div class="col" data-status="concluida">
                <header>
                  <div class="row"><strong>Conclu√≠das</strong><span class="badge">0</span></div>
                  <button class="btn small" data-add="concluida">+ adicionar</button>
                </header>
                <div class="dropzone" id="col-concluida" ondragover="event.preventDefault()"></div>
              </div>
            </div>
          </section>

          <section class="panel">
            <h3>Anota√ß√µes gerais</h3>
            <div class="note">
              <div class="row" style="gap:10px;margin-bottom:8px">
                <label class="pill">Autor:
                  <select id="noteAuthor"></select>
                </label>
                <span class="muted" id="noteNow"></span>
              </div>
              <textarea id="noteInput" placeholder="Escreva uma anota√ß√£o‚Ä¶"></textarea>
              <div class="actions">
                <button class="btn" id="btnAnotar">Anotar</button>
              </div>
            </div>
            <div id="notes"></div>
          </section>
        </section>

        <div class="foot">
          <div>Feito com ‚ù§ para equipes que precisam de algo simples, online e colaborativo.</div>
          <div class="muted" id="boardInfo">‚Äî</div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL: TAREFA -->
  <dialog id="dlgTask" class="modal-light">
    <div class="modal-head" id="taskModalTitle">Nova tarefa</div>
    <div class="modal-body">
      <div class="field"><label>T√≠tulo</label><input id="tTitulo" type="text" placeholder="Ex.: Arquivos da Novo Agro" /></div>
      <div class="field"><label>Descri√ß√£o (opcional)</label><input id="tDesc" type="text" placeholder="Detalhes curtos‚Ä¶" /></div>
      <div class="field"><label>Respons√°veis</label><div id="tRespGroup" class="assignees"></div></div>
      <div class="field"><label>Prazo</label><input id="tPrazo" type="date" /></div>
      <div class="field"><label>Status</label>
        <select id="tStatus">
          <option value="a_fazer">a fazer</option>
          <option value="em_andamento">em andamento</option>
          <option value="concluida">conclu√≠da</option>
        </select>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="tCancelar">Cancelar</button>
      <button class="btn primary" id="tSalvar">Salvar</button>
    </div>
  </dialog>

  <!-- MODAL: REUNI√ïES -->
  <dialog id="dlgMeetings" class="modal-light">
    <div class="modal-head">Reuni√µes</div>
    <div class="modal-body">
      <div class="field"><label>Respons√°vel</label>
        <select id="mResp"></select>
      </div>
      <div class="field"><label>T√≠tulo</label>
        <input id="mTitulo" type="text" placeholder="Ex.: Reuni√£o com Cliente X" />
      </div>
      <div class="field"><label>Descri√ß√£o (opcional)</label>
        <input id="mDesc" type="text" placeholder="Pauta breve‚Ä¶" />
      </div>
      <div class="row" style="gap:10px">
        <div class="field"><label>Dia</label><input id="mData" type="date" /></div>
        <div class="field"><label>Hora</label><input id="mHora" type="time" /></div>
      </div>
      <div class="actions" style="justify-content:flex-end">
        <button class="btn" id="mCancelar">Limpar</button>
        <button class="btn primary" id="mSalvar">Salvar reuni√£o</button>
      </div>

      <div style="margin-top:8px;font-weight:700">Registros</div>
      <div id="meetingList" class="meeting-list"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="mFechar">Fechar</button>
    </div>
  </dialog>

  <!-- MODAL: TIMELINE / HIST√ìRICO DA TAREFA -->
  <dialog id="dlgTimeline" class="modal-light">
    <div class="modal-head" id="tlTaskTitle">Timeline / Hist√≥rico</div>
    <div class="modal-body">
      <div class="tl-body-grid">
        <section class="tl-brief-card">
          <div class="tl-brief-title" id="tlBriefTitulo">(t√≠tulo)</div>
          <div class="tl-brief-badges" id="tlBriefBadges"></div>
          <div class="tl-brief-meta" id="tlBriefMeta"></div>
        </section>

        <section class="tl-col-main">
          <div id="tlFormWrap" class="timeline-form" style="display:none">
            <div class="timeline-form-head">
              <span>Novo registro</span>
            </div>
            <div class="tl-edit-row">
              <label>T√≠tulo</label>
              <input id="tlNovoTitulo" type="text" placeholder="Ex.: Documento entregue / Reuni√£o feita" />
            </div>
            <div class="tl-edit-row">
              <label>Descri√ß√£o</label>
              <textarea id="tlNovoDesc" placeholder="Descreva rapidamente o que aconteceu‚Ä¶"></textarea>
            </div>
            <div class="tl-edit-row">
              <label>Status</label>
              <select id="tlNovoStatus">
                <option value="parado">Parado (vermelho)</option>
                <option value="andamento">Em andamento (amarelo)</option>
                <option value="concluido">Conclu√≠do (verde)</option>
              </select>
            </div>
            <div class="tl-save-row">
              <button class="btn primary" id="tlNovoSalvar">Adicionar na timeline</button>
            </div>
          </div>

          <div class="tl-history-head">Hist√≥rico</div>
          <div id="tlList" class="timeline-entries"></div>
        </section>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="tlFechar">Fechar</button>
    </div>
  </dialog>

  <!-- MODAL: NOVO PROJETO -->
  <dialog id="dlgProject" class="modal-light">
    <div class="modal-head">Novo projeto</div>
    <div class="modal-body">
      <div class="field"><label>Nome do projeto</label><input id="pTitulo" type="text" placeholder="Ex.: Projeto Rond√¥nia" /></div>
      <div class="muted" style="font-size:12px">Exemplos: ‚ÄúProjeto Rond√¥nia‚Äù, ‚ÄúProjeto Par√°‚Äù.</div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="pCancelar">Cancelar</button>
      <button class="btn primary" id="pSalvar">Criar</button>
    </div>
  </dialog>

  <script>
  /* =================== CONFIG GERAL =================== */
  const DEFAULT_SB_URL = 'https://oakntljdkkoqwttkgzpk.supabase.co';
  const DEFAULT_SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ha250bGpka2tvcXd0dGtnenBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwMzQzMDgsImV4cCI6MjA3MTYxMDMwOH0.jjxUzxyUoutDAVzZg9nrSi9kg5fYfs6F7PCd4xkT48c';

  const FIXED_RESPONSAVEIS = ['Bruno Ferreira','Bruno Santos','Carlos Barretto','Jo√£o Ten√≥rio'];

  const state = {
    theme: localStorage.getItem('theme') || 'dark',
    author: 'An√¥nimo',

    // projetos (usando 'boards' como tabela de projetos)
    projects: [],           // {slug, title}
    currentProject: null,   // {slug, title}

    // supabase
    supabaseUrl: DEFAULT_SB_URL,
    supabaseKey: DEFAULT_SB_KEY,
    client: null,
    online:false,

    // dados do projeto atual
    tasks: [],
    notes: [],
    meetings: [],

    // UI
    editingTaskId: null,
    editingNoteId: null,
    viewingTaskTimelineId:null,
    editingTimelineEntryId:null,

    // filtros
    filterDate:null,
    calMonth:null,

    // subtabs
    subScope:'todas', // todas | atrasadas | a_fazer | em_andamento | concluida
  };

  /* ========== Cadeado simples (senha no front) ========== */
  const APP_PASSWORD = 'esg2025*';
  const AUTH_FLAG = 'gst_auth_ok';
  let appStarted = false;

  function bootWithPassword(){
    const ok = sessionStorage.getItem(AUTH_FLAG) === '1';
    const overlay = document.getElementById('loginOverlay');
    const pwdInput = document.getElementById('pwdInput');
    const btnEnter = document.getElementById('pwdEnter');
    const btnShow  = document.getElementById('pwdShow');
    const err = document.getElementById('loginErr');

    function startAppOnce(){
      if(appStarted) return;
      appStarted = true;
      startApp();
    }
    function showLocked(){
      document.body.classList.add('locked');
      overlay.style.display = 'flex';
      pwdInput.value = '';
      err.style.display = 'none';
      setTimeout(()=>pwdInput.focus(), 80);
    }
    function unlock(){
      document.body.classList.remove('locked');
      overlay.style.display = 'none';
      sessionStorage.setItem(AUTH_FLAG, '1');
      startAppOnce();
    }
    function wrong(){
      err.style.display = 'block';
      const card = document.getElementById('loginCard');
      card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake');
    }
    btnEnter.onclick = ()=>{ if(pwdInput.value === APP_PASSWORD) unlock(); else wrong(); };
    btnShow.onclick = ()=>{ if(pwdInput.type === 'password'){ pwdInput.type = 'text'; btnShow.textContent = 'üôà Ocultar'; } else { pwdInput.type = 'password'; btnShow.textContent = 'üëÅ Mostrar'; } };
    pwdInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnEnter.click(); });

    if(ok){ startAppOnce(); } else { showLocked(); }
  }
  document.addEventListener('DOMContentLoaded', bootWithPassword);

  /* =================== Helpers =================== */
  function applyTheme(){
    if(state.theme==='light') document.body.classList.add('light');
    else document.body.classList.remove('light');
  } applyTheme();

  const id = x => document.getElementById(x);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const unique = a => [...new Set(a)];
  const pad2 = n => String(n).padStart(2,'0');
  const toYMD = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const toHM  = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

  function ymdToLocalDate(s){
    if(!s) return null;
    const [y,m,d]=s.split('-').map(Number);
    return new Date(y,m-1,d);
  }
  function fmtDate(d){
    if(!d) return '';
    const dt=(typeof d==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(d))?ymdToLocalDate(d):new Date(d);
    return dt.toLocaleDateString();
  }
  function fmtTime(hm){
    if(!hm) return '';
    const [h,m]=(hm||'').split(':').map(Number);
    const d=new Date();
    d.setHours(h||0,m||0,0,0);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
  function fmtDateTime(d){ return d?new Date(d).toLocaleString():''; }

  const toCSV = rows=>{
    if(!rows.length) return '';
    const head=Object.keys(rows[0]);
    const body=rows.map(r=>head.map(k=>`"${String(r[k]??'').replaceAll('"','""')}"`).join(','));
    return [head.join(','),...body].join('\n');
  };
  function showErr(ctx, err){
    console.error(ctx, err);
    alert(`${ctx}:\n${(err && err.message) || err}`);
  }

  function sanitizeSlug(text){
    return (text||'').toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'')
      || ('proj-'+Math.random().toString(36).slice(2,7));
  }

  /* =================== Storage Local =================== */
  function lsKeyProj(){ return `gst_projects`; }
  function lsKeyData(slug){ return `gst_${slug}`; }

  function loadProjectsLocal(){
    try{ return JSON.parse(localStorage.getItem(lsKeyProj()))||[]; }catch{return [];}
  }
  function saveProjectsLocal(arr){ localStorage.setItem(lsKeyProj(), JSON.stringify(arr||[])); }

  function loadProjectDataLocal(slug){
    const raw=localStorage.getItem(lsKeyData(slug));
    if(!raw) return {tasks:[],notes:[],meetings:[]};
    try{
      const obj = JSON.parse(raw);
      return { tasks:obj.tasks||[], notes:obj.notes||[], meetings:obj.meetings||[] };
    }catch{ return {tasks:[],notes:[],meetings:[]}; }
  }
  function saveProjectDataLocal(slug, data){
    localStorage.setItem(lsKeyData(slug), JSON.stringify({
      tasks:data.tasks||[], notes:data.notes||[], meetings:data.meetings||[]
    }));
  }

  /* =================== Supabase =================== */
  async function maybeInitSupabase(){
    try{
      state.client = window.supabase.createClient(
        state.supabaseUrl,
        state.supabaseKey,
        { auth: { persistSession:false }}
      );

      // Sala para mudan√ßas em boards/projects e nas entidades do projeto atual
      state.online = true;
      id('onlineState').textContent='Online (Supabase)';
      id('modeLabel').textContent='Online ‚Ä¢ Projetos';

      // Realtime ‚Äî boards
      state.client.channel('ch-boards')
        .on('postgres_changes', { event:'*', schema:'public', table:'boards' }, async ()=>{ await fetchProjects(); })
        .subscribe();

      // Realtime ‚Äî tasks/notes/meetings do projeto atual
      state.client.channel('ch-app')
        .on('postgres_changes', { event:'*', schema:'public', table:'tasks' }, handleRealtimeIfCurrent)
        .on('postgres_changes', { event:'*', schema:'public', table:'notes' }, handleRealtimeIfCurrent)
        .on('postgres_changes', { event:'*', schema:'public', table:'meetings' }, handleRealtimeIfCurrent)
        .subscribe();
    }catch(e){
      state.online=false;
      id('onlineState').textContent='Offline (LocalStorage)';
      id('modeLabel').textContent='Modo local ‚Ä¢ Projetos';
      console.warn('Sem Supabase, operando local:', e);
    }
  }

  async function handleRealtimeIfCurrent(payload){
    // Atualiza somente se for o projeto atual
    await fetchProjectData();
  }

  async function fetchProjects(){
    if(state.online){
      const { data, error } = await state.client
        .from('boards')
        .select('*')
        .order('created_at',{ascending:true});
      if(error){ console.warn('Boards offline fallback', error); state.projects = loadProjectsLocal(); }
      else{ state.projects = (data||[]).map(b=>({slug:b.slug, title:b.title||b.slug})); saveProjectsLocal(state.projects); }
    }else{
      state.projects = loadProjectsLocal();
    }
    renderProjectsView();
    renderSidebarProjects();
  }

  async function upsertProject(title){
    const slug = sanitizeSlug(title);
    if(state.online){
      // upsert board como projeto
      const { error } = await state.client
        .from('boards')
        .upsert({ slug, title }, { onConflict: 'slug' });
      if(error) return showErr('Erro ao criar projeto', error);
    }else{
      const arr = loadProjectsLocal();
      if(!arr.find(p=>p.slug===slug)) arr.push({slug, title});
      saveProjectsLocal(arr);
      // cria storage do projeto
      saveProjectDataLocal(slug, {tasks:[],notes:[],meetings:[]});
    }
    await fetchProjects();
    selectProject(slug);
  }

  async function deleteProject(slug){
    if(!confirm('Excluir projeto e todos os dados locais/online?')) return;
    if(state.online){
      try{
        // remove tasks/notes/meetings do board
        await state.client.from('tasks').delete().eq('board_slug', slug);
        await state.client.from('notes').delete().eq('board_slug', slug);
        await state.client.from('meetings').delete().eq('board_slug', slug);
        // remove board
        await state.client.from('boards').delete().eq('slug', slug);
      }catch(e){ return showErr('Erro ao excluir projeto', e); }
    }else{
      // apaga dados locais
      localStorage.removeItem(lsKeyData(slug));
      const arr = loadProjectsLocal().filter(p=>p.slug!==slug);
      saveProjectsLocal(arr);
    }
    if(state.currentProject?.slug === slug) state.currentProject=null;
    await fetchProjects();
    showProjectsHome();
  }

  async function fetchProjectData(){
    if(!state.currentProject) return;
    const slug = state.currentProject.slug;

    if(state.online){
      const { data: t, error: e1 } = await state.client
        .from('tasks')
        .select('*')
        .eq('board_slug', slug)
        .order('created_at',{ascending:true});
      state.tasks = e1 ? [] : (t||[]);
      if(e1) showErr('Erro ao carregar tarefas', e1);

      const { data: n, error: e2 } = await state.client
        .from('notes')
        .select('*')
        .eq('board_slug', slug)
        .order('created_at',{ascending:false});
      state.notes = e2 ? [] : (n||[]);
      if(e2) showErr('Erro ao carregar anota√ß√µes', e2);

      const { data: m, error: e3 } = await state.client
        .from('meetings')
        .select('*')
        .eq('board_slug', slug)
        .order('created_at',{ascending:false});
      state.meetings = e3 ? [] : (m||[]);
      if(e3) showErr('Erro ao carregar reuni√µes', e3);

      // cache local
      saveProjectDataLocal(slug, {tasks:state.tasks, notes:state.notes, meetings:state.meetings});
    }else{
      const {tasks,notes,meetings} = loadProjectDataLocal(slug);
      state.tasks=tasks; state.notes=notes; state.meetings=meetings;
    }

    renderProjectBoard();
    renderMeetingList();
    renderNoteAuthors();

    if(state.viewingTaskTimelineId) renderTimelineModal();
  }

  /* =================== UI de Projetos =================== */
  function renderSidebarProjects(){
    const list = id('projList');
    const q = (id('projSearch').value||'').toLowerCase().trim();
    list.innerHTML='';
    const arr = state.projects.filter(p => !q || p.title.toLowerCase().includes(q) || p.slug.includes(q));
    if(!arr.length){
      list.innerHTML = `<div class="muted">Nenhum projeto encontrado.</div>`;
      return;
    }
    arr.forEach(p=>{
      const item = document.createElement('div');
      item.className='proj-item';
      item.onclick=()=> selectProject(p.slug);

      const t = document.createElement('div');
      t.className='title';
      t.textContent = p.title;

      const actions = document.createElement('div');
      actions.className='proj-actions';
      const del = document.createElement('button');
      del.className='btn small';
      del.textContent='Excluir';
      del.onclick=(ev)=>{ ev.stopPropagation(); deleteProject(p.slug); };
      actions.append(del);

      item.append(t, actions);
      list.append(item);
    });
  }

  function renderProjectsView(){
    const grid = id('projectsGrid');
    grid.innerHTML = '';

    if(!state.projects.length){
      grid.innerHTML = `
        <div class="card">
          <div class="title">Sem projetos ainda</div>
          <div class="muted" style="margin-top:6px">Crie seu primeiro projeto para come√ßar (ex.: Projeto Rond√¥nia).</div>
          <div class="actions" style="margin-top:10px">
            <button class="btn primary" id="gridNovoProjeto">+ Criar projeto</button>
          </div>
        </div>`;
      const b = id('gridNovoProjeto'); if(b) b.onclick=()=>openProjectModal();
      return;
    }

    state.projects.forEach(p=>{
      const card=document.createElement('div');
      card.className='card';
      card.style.cursor='pointer';
      card.onclick=()=>selectProject(p.slug);

      const title=document.createElement('div');
      title.className='title';
      title.textContent=p.title;

      const meta=document.createElement('div');
      meta.className='muted';
      meta.style.fontSize='12px';
      meta.textContent=`slug: ${p.slug}`;

      const actions=document.createElement('div');
      actions.className='actions';
      const del=document.createElement('button'); del.className='btn small'; del.textContent='Excluir';
      del.onclick=(ev)=>{ev.stopPropagation(); deleteProject(p.slug);};
      actions.append(del);

      card.append(title, meta, actions);
      grid.append(card);
    });
  }

  function showProjectsHome(){
    id('viewProjects').style.display='';
    id('viewProjectBoard').style.display='none';
    id('projectToolbar').style.display='none';
    id('subtabs').style.display='none';
    id('crumbProject').textContent='‚Äî';
    id('boardInfo').textContent='Selecione um projeto na sidebar ou na grade.';
  }

  async function selectProject(slug){
    const p = (state.projects||[]).find(x=>x.slug===slug);
    if(!p) return;
    state.currentProject = p;

    id('crumbProject').textContent = p.title;
    id('projBoardTitle').textContent = `Tarefas ‚Äî ${p.title}`;
    id('boardInfo').textContent = `Projeto: ${p.title} (slug: ${p.slug})`;

    id('viewProjects').style.display='none';
    id('viewProjectBoard').style.display='';
    id('projectToolbar').style.display='';
    id('subtabs').style.display='';

    // Atualiza URL
    const url=new URL(location.href);
    url.searchParams.set('board', p.slug);
    url.searchParams.set('theme', state.theme);
    history.replaceState({},'',url.toString());

    await fetchProjectData();
    closeSidebar(); // mobile
  }

  function openProjectModal(){
    id('pTitulo').value='';
    id('dlgProject').showModal();
  }
  async function saveProjectFromModal(){
    const title = (id('pTitulo').value||'').trim();
    if(!title) return showErr('Projeto inv√°lido','Informe um nome.');
    await upsertProject(title);
    id('dlgProject').close();
  }

  /* =================== Tasks / Notes / Meetings (por projeto) =================== */
  function renderRespChoices(selected=[]){
    const wrap=id('tRespGroup'); wrap.innerHTML='';
    FIXED_RESPONSAVEIS.forEach((name, idx)=>{
      const input=document.createElement('input');
      input.type='checkbox';
      input.id=`resp_${idx}`;
      input.value=name;
      if(selected.includes(name)) input.checked=true;
      const label=document.createElement('label');
      label.htmlFor=input.id;
      label.textContent=name;
      wrap.append(input,label);
    });
  }
  function renderMeetingResponsaveis(){
    const sel=id('mResp');
    sel.innerHTML = FIXED_RESPONSAVEIS.map(n=>`<option value="${n}">${n}</option>`).join('');
  }
  function renderNoteAuthors(){
    const sel=id('noteAuthor');
    sel.innerHTML=FIXED_RESPONSAVEIS.map(n=>`<option value="${n}">${n}</option>`).join('');
    id('noteNow').textContent=`agora: ${fmtDateTime(new Date())}`;
  }

  async function upsertTask(obj){
    if(!state.currentProject) return showErr('Projeto n√£o selecionado','Selecione um projeto.');
    const slug = state.currentProject.slug;

    if(state.online){
      if(obj.id){
        const { error } = await state.client
          .from('tasks')
          .update(obj)
          .eq('id', obj.id);
        if(error) return showErr('Erro ao atualizar tarefa', error);
      }else{
        const payload = { ...obj, board_slug: slug };
        const { error } = await state.client
          .from('tasks')
          .insert(payload);
        if(error) return showErr('Erro ao criar tarefa', error);
      }
    }else{
      // offline
      if(!obj.id){
        obj.id=crypto.randomUUID();
        obj.created_at=new Date().toISOString();
      }
      const data = loadProjectDataLocal(slug);
      const idx=data.tasks.findIndex(x=>x.id===obj.id);
      if(idx>=0){ data.tasks[idx]={...data.tasks[idx],...obj}; }
      else{ data.tasks.push(obj); }
      saveProjectDataLocal(slug, data);
    }
    await fetchProjectData();
  }

  async function deleteTask(idv){
    const slug = state.currentProject?.slug;
    if(!slug) return;
    if(state.online){
      const { error } = await state.client.from('tasks').delete().eq('id', idv);
      if(error) return showErr('Erro ao excluir tarefa', error);
    }else{
      const data = loadProjectDataLocal(slug);
      data.tasks = (data.tasks||[]).filter(t=>t.id!==idv);
      saveProjectDataLocal(slug, data);
    }
    await fetchProjectData();
  }

  async function upsertMeeting(obj){
    const slug = state.currentProject?.slug;
    if(!slug) return showErr('Projeto n√£o selecionado','Selecione um projeto.');
    if(state.online){
      if(obj.id){
        const { error } = await state.client
          .from('meetings')
          .update({ ...obj, updated_at:new Date().toISOString() })
          .eq('id', obj.id);
        if(error) return showErr('Erro ao atualizar reuni√£o', error);
      }else{
        const tempId = crypto.randomUUID();
        const optimistic = { id: tempId, board_slug: slug, created_at: new Date().toISOString(), ...obj };
        state.meetings = [optimistic, ...(state.meetings||[])];
        renderMeetingList();

        const { data, error } = await state.client
          .from('meetings')
          .insert({ ...obj, board_slug: slug })
          .select()
          .single();

        if(error){
          state.meetings = state.meetings.filter(m => m.id !== tempId);
          renderMeetingList();
          return showErr('Erro ao criar reuni√£o', error);
        }
        const ix = state.meetings.findIndex(m => m.id === tempId);
        if(ix >= 0) state.meetings[ix] = data;
        renderMeetingList();
        return;
      }
    }else{
      const data = loadProjectDataLocal(slug);
      if(!obj.id){
        obj.id=crypto.randomUUID();
        obj.created_at=new Date().toISOString();
      }
      const idx=data.meetings.findIndex(x=>x.id===obj.id);
      if(idx>=0){ data.meetings[idx]={...data.meetings[idx],...obj}; }
      else{ data.meetings.unshift(obj); }
      saveProjectDataLocal(slug, data);
    }
    await fetchProjectData();
  }

  async function deleteMeeting(idv){
    const slug = state.currentProject?.slug;
    if(!slug) return;
    const backup = [...(state.meetings||[])];
    state.meetings = state.meetings.filter(m => m.id !== idv);
    renderMeetingList();

    if(state.online){
      const { error } = await state.client.from('meetings').delete().eq('id', idv);
      if(error){
        state.meetings = backup;
        renderMeetingList();
        return showErr('Erro ao excluir reuni√£o', error);
      }
    }else{
      const data = loadProjectDataLocal(slug);
      data.meetings = (data.meetings||[]).filter(m=>m.id!==idv);
      saveProjectDataLocal(slug, data);
    }
  }

  function openMeetings(){
    renderMeetingResponsaveis();
    id('mResp').value = FIXED_RESPONSAVEIS[0] || '';
    id('mTitulo').value = '';
    id('mDesc').value = '';
    id('mData').value = '';
    id('mHora').value = '';
    renderMeetingList();
    id('dlgMeetings').showModal();
  }
  function renderMeetingList(){
    const wrap=id('meetingList'); if(!wrap) return;
    wrap.innerHTML='';
    const list = [...(state.meetings||[])].sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
    if(!list.length){ wrap.innerHTML = `<div class="muted">Sem reuni√µes registradas.</div>`; return; }
    list.forEach(m=>{
      const dv=document.createElement('div'); dv.className='meeting-item';
      const top=document.createElement('div'); top.className='meeting-top';
      const ttl=document.createElement('div'); ttl.className='title'; ttl.textContent=m.titulo||'(sem t√≠tulo)';
      const actions=document.createElement('div'); actions.className='meeting-actions';
      const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir'; bDel.onclick=()=>deleteMeeting(m.id);
      actions.append(bDel); top.append(ttl, actions);

      const meta=document.createElement('div'); meta.className='meeting-meta';
      const resp=`<span class="pill-inline">${m.responsavel||'‚Äî'}</span>`;
      const dia = m.data ? fmtDate(m.data) : 'sem dia';
      const hora= m.hora ? fmtTime(m.hora) : '';
      meta.innerHTML = `${resp}<span>‚Ä¢</span><span>${dia}${hora? ' ‚Äî '+hora:''}</span><span>‚Ä¢</span><span>criada: ${fmtDateTime(m.created_at)}</span>`;

      const desc=document.createElement('div'); desc.className='muted'; desc.textContent=m.descricao||'';

      dv.append(top, meta, desc);
      wrap.append(dv);
    });
  }
  async function saveMeetingFromModal(){
    const responsavel=id('mResp').value;
    const titulo=(id('mTitulo').value||'').trim();
    const descricao=(id('mDesc').value||'').trim() || null;
    const data=id('mData').value || null;
    const hora=id('mHora').value || null;
    if(!titulo || !responsavel || !data || !hora){ return showErr('Formul√°rio incompleto','Preencha respons√°vel, t√≠tulo, dia e hora.'); }
    const obj = { titulo, descricao, responsavel, data, hora, autor: state.author };
    await upsertMeeting(obj);
    id('mTitulo').value=''; id('mDesc').value=''; id('mData').value=''; id('mHora').value='';
  }

  // ===== NOTAS =====
  async function addNote(content){
    const slug = state.currentProject?.slug; if(!slug) return showErr('Projeto n√£o selecionado','Selecione um projeto.');
    const autor=id('noteAuthor').value;
    if(!content.trim()) return;
    if(state.online){
      const { error } = await state.client.from('notes').insert({ board_slug: slug, conteudo: content, autor });
      if(error) return showErr('Erro ao criar anota√ß√£o', error);
    }else{
      const data = loadProjectDataLocal(slug);
      data.notes.push({ id: crypto.randomUUID(), conteudo: content, autor, created_at: new Date().toISOString(), updated_at: null });
      saveProjectDataLocal(slug, data);
    }
    id('noteInput').value='';
    await fetchProjectData();
  }
  async function startEditNote(note){ state.editingNoteId=note.id; renderNotes(); }
  async function saveEditNote(idv){
    const area=id(`edit_area_${idv}`); const sel=id(`edit_author_${idv}`);
    const newText=area.value.trim(); const newAuthor=sel.value;
    const slug = state.currentProject?.slug; if(!slug) return;
    if(!newText) return;
    if(state.online){
      const { error } = await state.client.from('notes').update({ conteudo:newText, autor:newAuthor }).eq('id', idv);
      if(error) return showErr('Erro ao salvar edi√ß√£o', error);
    }else{
      const data = loadProjectDataLocal(slug);
      const idx=data.notes.findIndex(n=>n.id===idv);
      if(idx>=0){ data.notes[idx].conteudo=newText; data.notes[idx].autor=newAuthor; data.notes[idx].updated_at=new Date().toISOString(); saveProjectDataLocal(slug, data); }
    }
    state.editingNoteId=null; await fetchProjectData();
  }
  function cancelEditNote(){ state.editingNoteId=null; renderNotes(); }
  async function deleteNote(idv){
    const slug = state.currentProject?.slug; if(!slug) return;
    if(state.online){
      const { error } = await state.client.from('notes').delete().eq('id', idv);
      if(error) return showErr('Erro ao excluir anota√ß√£o', error);
    }else{
      const data = loadProjectDataLocal(slug);
      data.notes = (data.notes||[]).filter(n=>n.id!==idv);
      saveProjectDataLocal(slug, data);
    }
    await fetchProjectData();
  }

  /* =================== Render Board =================== */
  function getDueBadge(prazo, status){
    if(!prazo || status==='concluida') return null;
    const today=new Date(); today.setHours(0,0,0,0);
    const d=ymdToLocalDate(prazo);
    const diff=Math.round((d - today)/(1000*60*60*24));
    if(diff<0) return { cls:'due due-overdue', text:`atrasada h√° ${Math.abs(diff)}d` };
    if(diff===0) return { cls:'due due-today', text:'vence hoje' };
    if(diff===1) return { cls:'due due-soon', text:'em 1 dia' };
    if(diff<=7) return { cls:'due due-soon', text:`em ${diff} dias` };
    return null;
  }

  function getTaskById(taskId){ return state.tasks.find(x=>x.id===taskId); }
  function getTimelineStatusLabel(st){ if(st==='concluido') return 'Conclu√≠do'; if(st==='andamento') return 'Em andamento'; if(st==='parado') return 'Parado'; return st||''; }
  function getTimelineDotClass(st){ if(st==='concluido') return 'dot-concluido'; if(st==='andamento') return 'dot-andamento'; if(st==='parado') return 'dot-parado'; return ''; }
  function getTimelinePillClass(st){ if(st==='concluido') return 'tl-pill tl-pill-concluido'; if(st==='andamento') return 'tl-pill tl-pill-andamento'; if(st==='parado') return 'tl-pill tl-pill-parado'; return 'tl-pill'; }

  async function saveTaskTimeline(task){
    const slug = state.currentProject?.slug; if(!slug) return;
    // offline fallback
    if(!state.online){
      const data = loadProjectDataLocal(slug);
      const idx=data.tasks.findIndex(t=>t.id===task.id);
      if(idx>=0){ data.tasks[idx].timeline = task.timeline||[]; data.tasks[idx].updated_at=new Date().toISOString(); saveProjectDataLocal(slug, data); }
    }
    if(state.online){
      const payloadUpdate = { timeline: task.timeline || [], updated_at: new Date().toISOString() };
      const { error } = await state.client.from('tasks').update(payloadUpdate).eq('id', task.id);
      if(error){ console.warn('Falha ao salvar timeline online:', error); showErr('Erro ao atualizar timeline', error); }
    }
    renderTimelineModal(); renderTasks();
  }

  function openTimelineModal(taskId){
    state.viewingTaskTimelineId = taskId;
    state.editingTimelineEntryId = null;
    renderTimelineModal();
    id('dlgTimeline').showModal();
  }

  function renderTimelineModal(){
    const task = getTaskById(state.viewingTaskTimelineId);
    if(!task) return;

    const isAutor = task.autor === state.author || !task.autor;

    id('tlTaskTitle').textContent = 'Timeline / Hist√≥rico';
    id('tlBriefTitulo').textContent = task.titulo || '(sem t√≠tulo)';

    const badgesWrap = id('tlBriefBadges'); badgesWrap.innerHTML = '';
    const stSpan = document.createElement('span'); stSpan.className='tl-brief-chip'; stSpan.textContent = 'Status: ' + (task.status||''); badgesWrap.appendChild(stSpan);
    if(task.prazo){ const prazoSpan=document.createElement('span'); prazoSpan.className='tl-brief-chip'; prazoSpan.textContent='Prazo: '+fmtDate(task.prazo); badgesWrap.appendChild(prazoSpan); }
    if(Array.isArray(task.responsaveis)){ task.responsaveis.forEach(r=>{ const chip=document.createElement('span'); chip.className='tl-brief-chip'; chip.textContent=r; badgesWrap.appendChild(chip); }); }

    const metaWrap = id('tlBriefMeta'); metaWrap.innerHTML = '';
    const partesMeta = [];
    if(task.autor){ partesMeta.push('Autor: '+task.autor); }
    if(task.created_at){ partesMeta.push('Criada: '+fmtDateTime(task.created_at)); }
    if(task.updated_at){ partesMeta.push('Atualizada: '+fmtDateTime(task.updated_at)); }
    if(!partesMeta.length){ partesMeta.push('Sem metadados'); }
    metaWrap.textContent = partesMeta.join(' ‚Ä¢ ');

    const tlFormWrap = id('tlFormWrap');
    tlFormWrap.style.display = isAutor ? '' : 'none';

    const tlList = id('tlList');
    tlList.innerHTML='';
    const timelineArr = Array.isArray(task.timeline) ? [...task.timeline] : [];
    timelineArr.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));

    if(!timelineArr.length){
      tlList.innerHTML = `<div style="font-size:13px;color:#6b7280;padding:8px 0 0 0;">Sem registros na timeline.</div>`;
      return;
    }

    timelineArr.forEach(entry=>{
      const isEditing = state.editingTimelineEntryId === entry.id;
      const item = document.createElement('div'); item.className='tl-item';
      const dot = document.createElement('div'); dot.className = 'tl-item-dot ' + getTimelineDotClass(entry.status); item.appendChild(dot);

      if(isEditing){
        const editBlock = document.createElement('div'); editBlock.className='tl-edit-block';

        const rowTitulo = document.createElement('div'); rowTitulo.className='tl-edit-row';
        rowTitulo.innerHTML = `<label>T√≠tulo</label><input id="tlEditTitulo_${entry.id}" type="text" value="${entry.titulo||''}">`;

        const rowDesc=document.createElement('div'); rowDesc.className='tl-edit-row';
        rowDesc.innerHTML = `<label>Descri√ß√£o</label><textarea id="tlEditDesc_${entry.id}">${entry.descricao||''}</textarea>`;

        const rowSt=document.createElement('div'); rowSt.className='tl-edit-row';
        rowSt.innerHTML = `<label>Status</label>
          <select id="tlEditStatus_${entry.id}">
            <option value="parado">Parado (vermelho)</option>
            <option value="andamento">Em andamento (amarelo)</option>
            <option value="concluido">Conclu√≠do (verde)</option>
          </select>`;
        setTimeout(()=>{ id(`tlEditStatus_${entry.id}`).value=entry.status||'parado'; }, 0);

        const rowBtns=document.createElement('div'); rowBtns.className='tl-edit-buttons';
        const bCancel=document.createElement('button'); bCancel.className='btn'; bCancel.textContent='Cancelar';
        bCancel.onclick=()=>{ state.editingTimelineEntryId=null; renderTimelineModal(); };
        const bSave=document.createElement('button'); bSave.className='btn primary'; bSave.textContent='Salvar';
        bSave.onclick=async ()=>{
          const newTitulo = id(`tlEditTitulo_${entry.id}`).value.trim() || '(sem t√≠tulo)';
          const newDesc   = id(`tlEditDesc_${entry.id}`).value.trim() || '';
          const newStatus = id(`tlEditStatus_${entry.id}`).value;
          const tTask = getTaskById(state.viewingTaskTimelineId);
          if(!tTask) return;
          const arr = Array.isArray(tTask.timeline)?tTask.timeline:[];
          const ix = arr.findIndex(e=>e.id===entry.id);
          if(ix>=0){ arr[ix] = { ...arr[ix], titulo:newTitulo, descricao:newDesc, status:newStatus, updated_at:new Date().toISOString() }; }
          tTask.timeline = arr;
          state.editingTimelineEntryId=null;
          await saveTaskTimeline(tTask);
        };

        rowBtns.append(bCancel,bSave);
        editBlock.append(rowTitulo,rowDesc,rowSt,rowBtns);
        item.append(editBlock);

      }else{
        const topLine=document.createElement('div'); topLine.className='tl-top-line';
        const leftBlock=document.createElement('div'); leftBlock.className='tl-left-block';

        const titleEl=document.createElement('div'); titleEl.className='tl-titulo'; titleEl.textContent=entry.titulo||'(sem t√≠tulo)';
        const line2=document.createElement('div'); line2.className='tl-line2';
        const pill=document.createElement('span'); pill.className=getTimelinePillClass(entry.status); pill.textContent=getTimelineStatusLabel(entry.status);
        const tsLabel = document.createElement('span'); tsLabel.textContent = entry.created_at ? fmtDateTime(entry.created_at) : '(sem data)';
        line2.append(pill,tsLabel);

        leftBlock.append(titleEl,line2);

        const actions=document.createElement('div'); actions.className='tl-actions';
        const task = getTaskById(state.viewingTaskTimelineId);
        const isAutor = task?.autor === state.author || !task?.autor;
        if(isAutor){
          const bEdit = document.createElement('button'); bEdit.className='btn small'; bEdit.textContent='Editar';
          bEdit.onclick=()=>{ state.editingTimelineEntryId=entry.id; renderTimelineModal(); };
          const bDel = document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir';
          bDel.onclick=async ()=>{
            const tTask=getTaskById(state.viewingTaskTimelineId);
            if(!tTask) return;
            const arr=Array.isArray(tTask.timeline)?tTask.timeline:[];
            tTask.timeline = arr.filter(e=>e.id!==entry.id);
            await saveTaskTimeline(tTask);
          };
          actions.append(bEdit,bDel);
        }

        topLine.append(leftBlock, actions);
        const desc=document.createElement('div'); desc.className='tl-desc'; desc.textContent=entry.descricao||'';
        item.append(topLine, desc);
      }

      id('tlList').append(item);
    });
  }

  async function addTimelineEntry(){
    const task = getTaskById(state.viewingTaskTimelineId);
    if(!task) return;
    if(task.autor && task.autor !== state.author){
      return showErr('Sem permiss√£o','Somente o autor da tarefa pode registrar na timeline.');
    }
    const titulo = (id('tlNovoTitulo').value||'').trim() || '(sem t√≠tulo)';
    const descricao = (id('tlNovoDesc').value||'').trim() || '';
    const status = id('tlNovoStatus').value || 'parado';
    const entry = { id: crypto.randomUUID(), titulo, descricao, status, created_at: new Date().toISOString() };
    const arr = Array.isArray(task.timeline)?task.timeline:[];
    arr.push(entry);
    task.timeline = arr;
    id('tlNovoTitulo').value=''; id('tlNovoDesc').value=''; id('tlNovoStatus').value='parado';
    await saveTaskTimeline(task);
  }

  function makeTaskCard(t){
    const card=document.createElement('div');
    card.className='card'; card.classList.add('is-'+t.status); card.draggable=true; card.dataset.id=t.id;
    card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', t.id); });
    card.addEventListener('click', ()=>{ openTimelineModal(t.id); });

    const title=document.createElement('div'); title.className='title'; title.textContent=t.titulo||'(sem t√≠tulo)';

    const badges=document.createElement('div'); badges.className='badges';
    const stBadge=document.createElement('span'); stBadge.className='badge status-'+t.status; stBadge.textContent=t.status.replace('_',' ');
    const prazo=document.createElement('span'); prazo.className='badge'; prazo.textContent=t.prazo ? 'Prazo: '+fmtDate(t.prazo) : 'Sem prazo';
    badges.append(stBadge,prazo);

    const due=getDueBadge(t.prazo, t.status);
    if(due){ const b=document.createElement('span'); b.className='badge '+due.cls; b.textContent=due.text.toUpperCase(); badges.append(b); }

    const stRow=document.createElement('div'); stRow.className='row';
    const stLabel=document.createElement('span'); stLabel.className='muted'; stLabel.style.fontSize='12px'; stLabel.textContent='Status:';
    const stSel=document.createElement('select'); stSel.className='status-inline';
    stSel.innerHTML=`<option value="a_fazer">a fazer</option><option value="em_andamento">em andamento</option><option value="concluida">conclu√≠da</option>`;
    stSel.value=t.status;
    stSel.addEventListener('click', ev=>ev.stopPropagation());
    stSel.onchange=async e=>{ e.stopPropagation(); await upsertTask({ id:t.id, status:e.target.value }); if(id('chkUpdateLink').checked) updateShareLink(); };

    stRow.append(stLabel, stSel);

    const meta=document.createElement('div'); meta.className='muted'; meta.style.fontSize='12px';
    meta.textContent='Criada em: ' + (t.created_at ? fmtDateTime(t.created_at) : '‚Äî');

    const tags=document.createElement('div'); tags.className='tags';
    (t.responsaveis||[]).forEach(p=>{ const el=document.createElement('span'); el.className='tag'; el.textContent=p; tags.append(el); });

    const actions=document.createElement('div'); actions.className='actions';
    const bEdit=document.createElement('button'); bEdit.className='btn small'; bEdit.textContent='Editar';
    bEdit.onclick=(ev)=>{ ev.stopPropagation(); openTaskModal(t); };
    const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir';
    bDel.onclick=(ev)=>{ ev.stopPropagation(); deleteTask(t.id); };
    actions.append(bEdit,bDel);

    card.append(title);
    if(t.descricao){ const d=document.createElement('div'); d.className='muted'; d.textContent=t.descricao; card.append(d); }
    card.append(badges, stRow, meta, tags, actions);
    return card;
  }

  function renderTasks(){
    const cols={ atrasadas:id('col-atrasadas'), a_fazer:id('col-a_fazer'), em_andamento:id('col-em_andamento'), concluida:id('col-concluida') };
    Object.values(cols).forEach(el=>el.innerHTML='');

    const fSt=id('fStatus').value, fResp=id('fResp').value, fPrazo=id('fPrazo').value;
    const today=new Date(); today.setHours(0,0,0,0);
    const endWeek=new Date(today); endWeek.setDate(today.getDate() + (7 - today.getDay())); endWeek.setHours(23,59,59,999);
    let list=[...state.tasks];

    // Sub-aba r√°pida (escopo)
    const scope = state.subScope;
    const prazoToLocal=t=> t.prazo ? ymdToLocalDate(t.prazo) : null;
    const isOverdue=t=>{ const p=prazoToLocal(t); return p && p<today && t.status!=='concluida'; };

    if(scope==='atrasadas') list=list.filter(isOverdue);
    if(scope==='a_fazer') list=list.filter(t=>t.status==='a_fazer' && !isOverdue(t));
    if(scope==='em_andamento') list=list.filter(t=>t.status==='em_andamento' && !isOverdue(t));
    if(scope==='concluida') list=list.filter(t=>t.status==='concluida');

    if(fSt!=='todos') list=list.filter(t=>t.status===fSt);
    if(fResp!=='todos') list=list.filter(t=>(t.responsaveis||[]).includes(fResp));

    if(state.filterDate){ list=list.filter(t=>t.prazo===state.filterDate); }
    else{
      if(fPrazo==='hoje'){ list=list.filter(t=>{ const p=prazoToLocal(t); return p && p.getTime()===today.getTime(); }); }
      if(fPrazo==='semana'){ list=list.filter(t=>{ const p=prazoToLocal(t); return p && p>=today && p<=endWeek; }); }
      if(fPrazo==='atrasadas'){ list=list.filter(t=> isOverdue(t)); }
    }

    const overdue=list.filter(isOverdue);
    const notOverdue=list.filter(t=>!isOverdue(t));
    overdue.forEach(t=> cols.atrasadas.append(makeTaskCard(t)));

    const counts={a_fazer:0,em_andamento:0,concluida:0};
    notOverdue.forEach(t=>counts[t.status]=(counts[t.status]||0)+1);
    notOverdue.forEach(t=> cols[t.status].append(makeTaskCard(t)));

    qsa('.col').forEach(col=>{
      const st=col.dataset.status, badge=col.querySelector('header .badge');
      if(!badge) return;
      badge.textContent = (st==='atrasadas') ? overdue.length : (counts[st]||0);
    });

    ['col-a_fazer','col-em_andamento','col-concluida'].forEach(cid=>{
      const dz=id(cid);
      dz.ondrop=async e=>{
        e.preventDefault();
        const idDrag=e.dataTransfer.getData('text/plain');
        const novo=cid.replace('col-','');
        const t=state.tasks.find(x=>x.id===idDrag);
        if(!t) return;
        await upsertTask({ id:t.id, status:novo });
        if(id('chkUpdateLink').checked) updateShareLink();
      };
    });

    updateFilters();
  }

  function renderNotes(){
    const wrap=id('notes'); if(!wrap) return;
    wrap.innerHTML='';
    const ordered=[...state.notes].sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
    ordered.forEach(n=>{
      const dv=document.createElement('div'); dv.className='note';

      if(state.editingNoteId===n.id){
        const edit=document.createElement('div'); edit.className='note-edit';
        const sel=document.createElement('select'); sel.id=`edit_author_${n.id}`;
        sel.innerHTML=FIXED_RESPONSAVEIS.map(a=>`<option ${a===n.autor?'selected':''} value="${a}">${a}</option>`).join('');
        const ta=document.createElement('textarea'); ta.id=`edit_area_${n.id}`; ta.value=n.conteudo||'';
        const row=document.createElement('div'); row.className='actions';
        const bCancel=document.createElement('button'); bCancel.className='btn'; bCancel.textContent='Cancelar'; bCancel.onclick=()=>cancelEditNote();
        const bSave=document.createElement('button'); bSave.className='btn primary'; bSave.textContent='Salvar'; bSave.onclick=()=>saveEditNote(n.id);
        row.append(bCancel,bSave); edit.append(sel,ta,row); dv.append(edit);
      }else{
        const p=document.createElement('div'); p.textContent=n.conteudo; dv.append(p);
        const meta=document.createElement('div'); meta.className='note-meta';
        const created=fmtDateTime(n.created_at); const updated=n.updated_at?fmtDateTime(n.updated_at):null;
        meta.innerHTML=`<span>por <strong>${n.autor||'‚Äî'}</strong></span><span>‚Ä¢</span><span>${created}</span>`+(updated?` <span>‚Ä¢</span><span>(editado em ${updated})</span>`:'');
        dv.append(meta);
        const row=document.createElement('div'); row.className='actions';
        const bEdit=document.createElement('button'); bEdit.className='btn small'; bEdit.textContent='Editar'; bEdit.onclick=()=>startEditNote(n);
        const bDel=document.createElement('button'); bDel.className='btn small'; bDel.textContent='Excluir'; bDel.onclick=()=>deleteNote(n.id);
        row.append(bEdit,bDel); dv.append(row);
      }
      wrap.append(dv);
    });
  }

  function renderProjectBoard(){
    if(!state.currentProject){ showProjectsHome(); return; }
    id('viewProjects').style.display='none';
    id('viewProjectBoard').style.display='';
    id('projectToolbar').style.display='';
    id('subtabs').style.display='';

    id('noteNow').textContent=`agora: ${fmtDateTime(new Date())}`;
    renderTasks();
    renderNotes();
    updateSelectedDayChip();
  }

  function updateFilters(){
    const base=[...FIXED_RESPONSAVEIS];
    const extras=unique(state.tasks.flatMap(t=>t.responsaveis||[])).filter(n=>!base.includes(n)).sort();
    const opts=[...base,...extras];
    const sel=id('fResp'); const val=sel.value;
    sel.innerHTML='<option value="todos">todos</option>'+opts.map(o=>`<option value="${o}">${o}</option>`).join('');
    if(opts.includes(val)) sel.value=val; else sel.value='todos';
  }

  function toggleCalendar(){
    const pop=id('calPopover');
    if(pop.classList.contains('hidden')) openCalendar();
    else closeCalendar();
  }
  function openCalendar(){
    if(!state.calMonth){
      const base = state.filterDate ? ymdToLocalDate(state.filterDate) : new Date();
      state.calMonth = new Date(base.getFullYear(), base.getMonth(), 1);
    }
    renderCalendar();
    id('calPopover').classList.remove('hidden');
    requestAnimationFrame(placeCalendarPopover);
  }
  function placeCalendarPopover(){
    const pop=id('calPopover'); const btn=id('btnCal'); const vw=window.innerWidth, vh=window.innerHeight;
    const r=btn.getBoundingClientRect(); const popW=pop.offsetWidth||280, popH=pop.offsetHeight||280;

    if(vw<=420){
      pop.style.left='50%'; pop.style.transform='translateX(-50%)'; pop.style.top=''; pop.style.bottom='calc(env(safe-area-inset-bottom, 0px) + 8px)'; pop.style.width='calc(100vw - 16px)';
      return;
    }else{ pop.style.bottom=''; pop.style.transform=''; pop.style.width='280px'; }

    let left = r.left + (r.width/2) - (popW/2); left = Math.max(8, Math.min(left, vw - popW - 8));
    let top = r.bottom + 8; if(top + popH > vh - 8) top = r.top - popH - 8; top = Math.max(8, Math.min(top, vh - popH - 8));
    pop.style.left = left + 'px'; pop.style.top  = top  + 'px';
  }
  function closeCalendar(){ id('calPopover').classList.add('hidden'); }

  function getTaskDatesSet(){
    const set=new Set();
    (state.tasks||[]).forEach(t=>{ if(t.prazo) set.add(t.prazo); });
    return set;
  }

  function renderCalendar(){
    const pop=id('calPopover');
    const d=state.calMonth||new Date();
    const y=d.getFullYear(), m=d.getMonth();
    const first=new Date(y,m,1);
    const firstDow=first.getDay();
    const daysInMonth=new Date(y,m+1,0).getDate();
    const title=first.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
    const dows=['D','S','T','Q','Q','S','S'];
    const taskSet=getTaskDatesSet();
    const todayStr=toYMD(new Date());

    let grid='';
    grid+=dows.map(x=>`<div class="cal-dow">${x}</div>`).join('');
    for(let i=0;i<firstDow;i++) grid+=`<div></div>`;
    for(let day=1; day<=daysInMonth; day++){
      const dt=new Date(y,m,day);
      const ymd=toYMD(dt);
      const has=taskSet.has(ymd);
      const isToday=ymd===todayStr;
      const isSel=state.filterDate===ymd;
      grid += `<div class="cal-day${has?' has-task':''}${isToday?' is-today':''}${isSel?' is-selected':''}" data-ymd="${ymd}">${day}</div>`;
    }

    pop.innerHTML=`
      <div class="cal">
        <div class="cal-head">
          <button class="btn small" id="calPrev">‚Äπ</button>
          <div class="title">${title}</div>
          <button class="btn small" id="calNext">‚Ä∫</button>
        </div>
        <div class="cal-grid">${grid}</div>
        <div class="row" style="justify-content:space-between; padding:0 6px 4px;">
          <button class="btn small" id="calHoje">Hoje</button>
          <button class="btn small" id="calFechar">Fechar</button>
        </div>
      </div>
    `;

    id('calPrev').onclick=()=>{ state.calMonth=new Date(y,m-1,1); renderCalendar(); placeCalendarPopover(); };
    id('calNext').onclick=()=>{ state.calMonth=new Date(y,m+1,1); renderCalendar(); placeCalendarPopover(); };
    id('calHoje').onclick=()=>{ const now=new Date(); state.calMonth=new Date(now.getFullYear(), now.getMonth(), 1); renderCalendar(); placeCalendarPopover(); };
    id('calFechar').onclick=closeCalendar;

    qsa('#calPopover .cal-day').forEach(el=>{
      el.onclick=()=>{ state.filterDate=el.dataset.ymd; id('fPrazo').value='todos'; closeCalendar(); renderProjectBoard(); };
    });
  }

  function updateSelectedDayChip(){
    const chip=id('selDiaTag'); const txt=id('selDiaText');
    if(state.filterDate){ chip.style.display=''; txt.textContent=fmtDate(state.filterDate); }
    else{ chip.style.display='none'; }
  }

  function openTaskModal(t){
    if(!state.currentProject) return showErr('Projeto n√£o selecionado','Selecione um projeto.');
    state.editingTaskId = t?.id || null;
    id('taskModalTitle').textContent = t ? 'Editar tarefa' : 'Nova tarefa';
    id('tTitulo').value = t?.titulo || '';
    id('tDesc').value = t?.descricao || '';
    renderRespChoices(t?.responsaveis||[]);
    id('tPrazo').value = t?.prazo || '';
    id('tStatus').value = t?.status || 'a_fazer';
    id('dlgTask').showModal();
  }

  async function saveTaskFromModal(){
    if(!state.currentProject) return showErr('Projeto n√£o selecionado','Selecione um projeto.');
    const selected=Array.from(document.querySelectorAll('#tRespGroup input:checked')).map(i=>i.value);
    const obj={
      id: state.editingTaskId || undefined,
      titulo: id('tTitulo').value.trim() || 'Sem t√≠tulo',
      descricao: id('tDesc').value.trim() || null,
      responsaveis: selected,
      prazo: id('tPrazo').value || null,
      status: id('tStatus').value,
      autor: state.author
    };
    await upsertTask(obj);
    id('dlgTask').close();
    if(id('chkUpdateLink').checked) updateShareLink();
  }

  function updateShareLink(){
    const url=new URL(location.href);
    if(state.currentProject?.slug) url.searchParams.set('board',state.currentProject.slug);
    url.searchParams.set('theme',state.theme);
    history.replaceState({},'',url.toString());
  }
  function generateShareLink(){
    const url=new URL(location.href);
    if(state.currentProject?.slug) url.searchParams.set('board',state.currentProject.slug);
    url.searchParams.set('theme',state.theme);
    navigator.clipboard.writeText(url.toString());
    alert('Link copiado! Cole no WhatsApp para compartilhar.');
  }
  function toggleTheme(){
    state.theme=(state.theme==='dark')?'light':'dark';
    localStorage.setItem('theme',state.theme);
    applyTheme();
    updateShareLink();
  }

  function exportCSV(){
    if(!state.currentProject) return showErr('Projeto n√£o selecionado','Selecione um projeto.');
    const rows=state.tasks.map(t=>({
      id:t.id, projeto:state.currentProject.slug, titulo:t.titulo, descricao:t.descricao||'', status:t.status,
      prazo:t.prazo||'', responsaveis:(t.responsaveis||[]).join('; '), autor:t.autor||'',
      criado_em:t.created_at||'', atualizado_em:t.updated_at||''
    }));
    const csv=toCSV(rows);
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`tarefas_${state.currentProject.slug}.csv`; a.click();
  }

  /* =================== Sidebar Mobile =================== */
  function openSidebar(){ id('sidebar').classList.add('open'); }
  function closeSidebar(){ id('sidebar').classList.remove('open'); }
  function toggleSidebar(){
    const s=id('sidebar');
    if(s.classList.contains('open')) closeSidebar(); else openSidebar();
  }

  /* =================== Eventos =================== */
  // Tema
  id('btnTheme').onclick = toggleTheme;

  // Sidebar
  id('btnOpenSidebar').onclick = toggleSidebar;

  // Projetos
  id('btnNovoProjeto').onclick = openProjectModal;
  id('pSalvar').onclick = saveProjectFromModal;
  id('pCancelar').onclick = ()=>id('dlgProject').close();
  id('projSearch').oninput = renderSidebarProjects;
  id('btnVoltarProjetos').onclick = showProjectsHome;

  // Toolbar/Kanban
  document.getElementById('btnNova').onclick = ()=>openTaskModal();
  qsa('[data-add]').forEach(b=>{ b.onclick=()=>openTaskModal({status:b.getAttribute('data-add')}); });
  document.getElementById('btnExport').onclick = exportCSV;
  document.getElementById('btnLink').onclick = generateShareLink;
  document.getElementById('tSalvar').onclick = saveTaskFromModal;
  document.getElementById('tCancelar').onclick = ()=>id('dlgTask').close();
  document.getElementById('btnAnotar').onclick = ()=>addNote(id('noteInput').value);
  document.getElementById('fStatus').onchange = renderProjectBoard;
  document.getElementById('fResp').onchange = renderProjectBoard;
  document.getElementById('fPrazo').onchange = ()=>{ state.filterDate=null; renderProjectBoard(); };

  // Reuni√µes
  document.getElementById('btnMeetings').onclick = openMeetings;
  document.getElementById('mSalvar').onclick = saveMeetingFromModal;
  document.getElementById('mCancelar').onclick = ()=>{ id('mTitulo').value=''; id('mDesc').value=''; id('mData').value=''; id('mHora').value=''; };
  document.getElementById('mFechar').onclick = ()=>id('dlgMeetings').close();

  // Timeline
  document.getElementById('tlNovoSalvar').onclick = addTimelineEntry;
  document.getElementById('tlFechar').onclick = ()=>{ state.viewingTaskTimelineId=null; state.editingTimelineEntryId=null; id('dlgTimeline').close(); };

  // mini-calend√°rio
  document.getElementById('btnCal').onclick = toggleCalendar;
  document.getElementById('btnClearDia').onclick = ()=>{ state.filterDate=null; renderProjectBoard(); };
  document.addEventListener('click', (ev)=>{
    const pop=id('calPopover'); if(pop.classList.contains('hidden')) return;
    if(!pop.contains(ev.target) && ev.target!==id('btnCal')) closeCalendar();
  });
  document.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') closeCalendar(); });
  window.addEventListener('resize', ()=>{ const pop=id('calPopover'); if(!pop.classList.contains('hidden')) placeCalendarPopover(); });
  window.addEventListener('scroll', ()=>{ const pop=id('calPopover'); if(!pop.classList.contains('hidden')) placeCalendarPopover(); }, true);

  // Subtabs (abas r√°pidas)
  qsa('.subtab').forEach(tab=>{
    tab.onclick = ()=>{
      qsa('.subtab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      state.subScope = tab.dataset.scope;
      renderProjectBoard();
    };
  });

  /* =================== Boot =================== */
  async function startApp(){
    // aplica tema da URL se existir
    const params=new URL(location.href).searchParams;
    const themeFromUrl=params.get('theme');
    if(themeFromUrl){ state.theme=themeFromUrl; localStorage.setItem('theme',state.theme); applyTheme(); }

    await maybeInitSupabase();
    await fetchProjects();

    // se vem um board na URL, j√° seleciona
    const fromUrl = params.get('board');
    if(fromUrl && state.projects.find(p=>p.slug===fromUrl)){
      await selectProject(fromUrl);
    }else{
      // tela de projetos como inicial
      showProjectsHome();
    }
  }
  </script>
</body>
</html>
